<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>Math4ML</title>
    <link href="/2024/02/07/Math4ML/"/>
    <url>/2024/02/07/Math4ML/</url>
    
    <content type="html"><![CDATA[<p>æ‘˜è¦ <span id="more"></span></p><center><a class="btn" href="https://mml-book.github.io/book/mml-book.pdf" title="title" target="_blank">MML</a></center><p><a href="https://myblackboxrecorder.com/use-math-in-hexo/">æ•°å­¦å…¬å¼æ”¯æŒ</a></p><h2 id="probability-and-distribution">Probability and Distribution</h2><h3 id="discrete-and-continuous-probabilitie">Discrete and ContinuousProbabilitie</h3><p><strong>quantity of interest</strong>:some characteristic of thedistribution of a population random variable.</p><p>Posterior <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="6.274ex" height="2.262ex" role="img" focusable="false" viewBox="0 -750 2773 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D45D" d="M23 287Q24 290 25 295T30 317T40 348T55 381T75 411T101 433T134 442Q209 442 230 378L240 387Q302 442 358 442Q423 442 460 395T497 281Q497 173 421 82T249 -10Q227 -10 210 -4Q199 1 187 11T168 28L161 36Q160 35 139 -51T118 -138Q118 -144 126 -145T163 -148H188Q194 -155 194 -157T191 -175Q188 -187 185 -190T172 -194Q170 -194 161 -194T127 -193T65 -192Q-5 -192 -24 -194H-32Q-39 -187 -39 -183Q-37 -156 -26 -148H-6Q28 -147 33 -136Q36 -130 94 103T155 350Q156 355 156 364Q156 405 131 405Q109 405 94 377T71 316T59 280Q57 278 43 278H29Q23 284 23 287ZM178 102Q200 26 252 26Q282 26 310 49T356 107Q374 141 392 215T411 325V331Q411 405 350 405Q339 405 328 402T306 393T286 380T269 365T254 350T243 336T235 326L232 322Q232 321 229 308T218 264T204 212Q178 106 178 102Z"></path></g><g data-mml-node="mo" transform="translate(503,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path></g><g data-mml-node="TeXAtom" data-mjx-texclass="ORD" transform="translate(892,0)"><g data-mml-node="mi"><path data-c="1D431" d="M227 0Q212 3 121 3Q40 3 28 0H21V62H117L245 213L109 382H26V444H34Q49 441 143 441Q247 441 265 444H274V382H246L281 339Q315 297 316 297Q320 297 354 341L389 382H352V444H360Q375 441 466 441Q547 441 559 444H566V382H471L355 246L504 63L545 62H586V0H578Q563 3 469 3Q365 3 347 0H338V62H366Q366 63 326 112T285 163L198 63L217 62H235V0H227Z"></path></g><g data-mml-node="mo" transform="translate(607,0) translate(0 -0.5)"><path data-c="7C" d="M139 -249H137Q125 -249 119 -235V251L120 737Q130 750 139 750Q152 750 159 735V-235Q151 -249 141 -249H139Z"></path></g><g data-mml-node="mi" transform="translate(885,0)"><path data-c="1D432" d="M84 -102Q84 -110 87 -119T102 -138T133 -149Q148 -148 162 -143T186 -131T206 -114T222 -95T234 -76T243 -59T249 -45T252 -37L269 0L96 382H26V444H34Q49 441 146 441Q252 441 270 444H279V382H255Q232 382 232 380L337 151L442 382H394V444H401Q413 441 495 441Q568 441 574 444H580V382H510L406 152Q298 -84 297 -87Q269 -139 225 -169T131 -200Q85 -200 54 -172T23 -100Q23 -64 44 -50T87 -35Q111 -35 130 -50T152 -92V-100H84V-102Z"></path></g></g><g data-mml-node="mo" transform="translate(2384,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></g></g></g></svg></mjx-container></span> isquantity of interest in Bayesian statjstics. i.e., know aboout <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: 0;" xmlns="http://www.w3.org/2000/svg" width="1.373ex" height="1.005ex" role="img" focusable="false" viewBox="0 -444 607 444"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="TeXAtom" data-mjx-texclass="ORD"><g data-mml-node="mi"><path data-c="1D431" d="M227 0Q212 3 121 3Q40 3 28 0H21V62H117L245 213L109 382H26V444H34Q49 441 143 441Q247 441 265 444H274V382H246L281 339Q315 297 316 297Q320 297 354 341L389 382H352V444H360Q375 441 466 441Q547 441 559 444H566V382H471L355 246L504 63L545 62H586V0H578Q563 3 469 3Q365 3 347 0H338V62H366Q366 63 326 112T285 163L198 63L217 62H235V0H227Z"></path></g></g></g></g></svg></mjx-container></span>after having observed <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.452ex;" xmlns="http://www.w3.org/2000/svg" width="1.373ex" height="1.457ex" role="img" focusable="false" viewBox="0 -444 607 644"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="TeXAtom" data-mjx-texclass="ORD"><g data-mml-node="mi"><path data-c="1D432" d="M84 -102Q84 -110 87 -119T102 -138T133 -149Q148 -148 162 -143T186 -131T206 -114T222 -95T234 -76T243 -59T249 -45T252 -37L269 0L96 382H26V444H34Q49 441 146 441Q252 441 270 444H279V382H255Q232 382 232 380L337 151L442 382H394V444H401Q413 441 495 441Q568 441 574 444H580V382H510L406 152Q298 -84 297 -87Q269 -139 225 -169T131 -200Q85 -200 54 -172T23 -100Q23 -64 44 -50T87 -35Q111 -35 130 -50T152 -92V-100H84V-102Z"></path></g></g></g></g></svg></mjx-container></span></p><p>quantity <span class="math display"><mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -1.948ex;" xmlns="http://www.w3.org/2000/svg" width="36.663ex" height="5.027ex" role="img" focusable="false" viewBox="0 -1361 16204.9 2222"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D45D" d="M23 287Q24 290 25 295T30 317T40 348T55 381T75 411T101 433T134 442Q209 442 230 378L240 387Q302 442 358 442Q423 442 460 395T497 281Q497 173 421 82T249 -10Q227 -10 210 -4Q199 1 187 11T168 28L161 36Q160 35 139 -51T118 -138Q118 -144 126 -145T163 -148H188Q194 -155 194 -157T191 -175Q188 -187 185 -190T172 -194Q170 -194 161 -194T127 -193T65 -192Q-5 -192 -24 -194H-32Q-39 -187 -39 -183Q-37 -156 -26 -148H-6Q28 -147 33 -136Q36 -130 94 103T155 350Q156 355 156 364Q156 405 131 405Q109 405 94 377T71 316T59 280Q57 278 43 278H29Q23 284 23 287ZM178 102Q200 26 252 26Q282 26 310 49T356 107Q374 141 392 215T411 325V331Q411 405 350 405Q339 405 328 402T306 393T286 380T269 365T254 350T243 336T235 326L232 322Q232 321 229 308T218 264T204 212Q178 106 178 102Z"></path></g><g data-mml-node="mo" transform="translate(503,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path></g><g data-mml-node="TeXAtom" data-mjx-texclass="ORD" transform="translate(892,0)"><g data-mml-node="mi"><path data-c="1D432" d="M84 -102Q84 -110 87 -119T102 -138T133 -149Q148 -148 162 -143T186 -131T206 -114T222 -95T234 -76T243 -59T249 -45T252 -37L269 0L96 382H26V444H34Q49 441 146 441Q252 441 270 444H279V382H255Q232 382 232 380L337 151L442 382H394V444H401Q413 441 495 441Q568 441 574 444H580V382H510L406 152Q298 -84 297 -87Q269 -139 225 -169T131 -200Q85 -200 54 -172T23 -100Q23 -64 44 -50T87 -35Q111 -35 130 -50T152 -92V-100H84V-102Z"></path></g></g><g data-mml-node="mo" transform="translate(1499,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></g><g data-mml-node="mo" transform="translate(1888,0)"><path data-c="3A" d="M78 370Q78 394 95 412T138 430Q162 430 180 414T199 371Q199 346 182 328T139 310T96 327T78 370ZM78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60Z"></path></g><g data-mml-node="mo" transform="translate(2332.7,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path></g><g data-mml-node="mo" transform="translate(3388.4,0) translate(0 1)"><path data-c="222B" d="M114 -798Q132 -824 165 -824H167Q195 -824 223 -764T275 -600T320 -391T362 -164Q365 -143 367 -133Q439 292 523 655T645 1127Q651 1145 655 1157T672 1201T699 1257T733 1306T777 1346T828 1360Q884 1360 912 1325T944 1245Q944 1220 932 1205T909 1186T887 1183Q866 1183 849 1198T832 1239Q832 1287 885 1296L882 1300Q879 1303 874 1307T866 1313Q851 1323 833 1323Q819 1323 807 1311T775 1255T736 1139T689 936T633 628Q574 293 510 -5T410 -437T355 -629Q278 -862 165 -862Q125 -862 92 -831T55 -746Q55 -711 74 -698T112 -685Q133 -685 150 -700T167 -741Q167 -789 114 -798Z"></path></g><g data-mml-node="mi" transform="translate(4499.1,0)"><path data-c="1D45D" d="M23 287Q24 290 25 295T30 317T40 348T55 381T75 411T101 433T134 442Q209 442 230 378L240 387Q302 442 358 442Q423 442 460 395T497 281Q497 173 421 82T249 -10Q227 -10 210 -4Q199 1 187 11T168 28L161 36Q160 35 139 -51T118 -138Q118 -144 126 -145T163 -148H188Q194 -155 194 -157T191 -175Q188 -187 185 -190T172 -194Q170 -194 161 -194T127 -193T65 -192Q-5 -192 -24 -194H-32Q-39 -187 -39 -183Q-37 -156 -26 -148H-6Q28 -147 33 -136Q36 -130 94 103T155 350Q156 355 156 364Q156 405 131 405Q109 405 94 377T71 316T59 280Q57 278 43 278H29Q23 284 23 287ZM178 102Q200 26 252 26Q282 26 310 49T356 107Q374 141 392 215T411 325V331Q411 405 350 405Q339 405 328 402T306 393T286 380T269 365T254 350T243 336T235 326L232 322Q232 321 229 308T218 264T204 212Q178 106 178 102Z"></path></g><g data-mml-node="mo" transform="translate(5002.1,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path></g><g data-mml-node="TeXAtom" data-mjx-texclass="ORD" transform="translate(5391.1,0)"><g data-mml-node="mi"><path data-c="1D432" d="M84 -102Q84 -110 87 -119T102 -138T133 -149Q148 -148 162 -143T186 -131T206 -114T222 -95T234 -76T243 -59T249 -45T252 -37L269 0L96 382H26V444H34Q49 441 146 441Q252 441 270 444H279V382H255Q232 382 232 380L337 151L442 382H394V444H401Q413 441 495 441Q568 441 574 444H580V382H510L406 152Q298 -84 297 -87Q269 -139 225 -169T131 -200Q85 -200 54 -172T23 -100Q23 -64 44 -50T87 -35Q111 -35 130 -50T152 -92V-100H84V-102Z"></path></g><g data-mml-node="mo" transform="translate(607,0) translate(0 -0.5)"><path data-c="7C" d="M139 -249H137Q125 -249 119 -235V251L120 737Q130 750 139 750Q152 750 159 735V-235Q151 -249 141 -249H139Z"></path></g><g data-mml-node="mi" transform="translate(885,0)"><path data-c="1D431" d="M227 0Q212 3 121 3Q40 3 28 0H21V62H117L245 213L109 382H26V444H34Q49 441 143 441Q247 441 265 444H274V382H246L281 339Q315 297 316 297Q320 297 354 341L389 382H352V444H360Q375 441 466 441Q547 441 559 444H566V382H471L355 246L504 63L545 62H586V0H578Q563 3 469 3Q365 3 347 0H338V62H366Q366 63 326 112T285 163L198 63L217 62H235V0H227Z"></path></g></g><g data-mml-node="mo" transform="translate(6883.1,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></g><g data-mml-node="mi" transform="translate(7272.1,0)"><path data-c="1D45D" d="M23 287Q24 290 25 295T30 317T40 348T55 381T75 411T101 433T134 442Q209 442 230 378L240 387Q302 442 358 442Q423 442 460 395T497 281Q497 173 421 82T249 -10Q227 -10 210 -4Q199 1 187 11T168 28L161 36Q160 35 139 -51T118 -138Q118 -144 126 -145T163 -148H188Q194 -155 194 -157T191 -175Q188 -187 185 -190T172 -194Q170 -194 161 -194T127 -193T65 -192Q-5 -192 -24 -194H-32Q-39 -187 -39 -183Q-37 -156 -26 -148H-6Q28 -147 33 -136Q36 -130 94 103T155 350Q156 355 156 364Q156 405 131 405Q109 405 94 377T71 316T59 280Q57 278 43 278H29Q23 284 23 287ZM178 102Q200 26 252 26Q282 26 310 49T356 107Q374 141 392 215T411 325V331Q411 405 350 405Q339 405 328 402T306 393T286 380T269 365T254 350T243 336T235 326L232 322Q232 321 229 308T218 264T204 212Q178 106 178 102Z"></path></g><g data-mml-node="mo" transform="translate(7775.1,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path></g><g data-mml-node="TeXAtom" data-mjx-texclass="ORD" transform="translate(8164.1,0)"><g data-mml-node="mi"><path data-c="1D431" d="M227 0Q212 3 121 3Q40 3 28 0H21V62H117L245 213L109 382H26V444H34Q49 441 143 441Q247 441 265 444H274V382H246L281 339Q315 297 316 297Q320 297 354 341L389 382H352V444H360Q375 441 466 441Q547 441 559 444H566V382H471L355 246L504 63L545 62H586V0H578Q563 3 469 3Q365 3 347 0H338V62H366Q366 63 326 112T285 163L198 63L217 62H235V0H227Z"></path></g></g><g data-mml-node="mo" transform="translate(8771.1,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></g><g data-mml-node="mi" transform="translate(9160.1,0)"><path data-c="1D451" d="M366 683Q367 683 438 688T511 694Q523 694 523 686Q523 679 450 384T375 83T374 68Q374 26 402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487H491Q506 153 506 145Q506 140 503 129Q490 79 473 48T445 8T417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157Q33 205 53 255T101 341Q148 398 195 420T280 442Q336 442 364 400Q369 394 369 396Q370 400 396 505T424 616Q424 629 417 632T378 637H357Q351 643 351 645T353 664Q358 683 366 683ZM352 326Q329 405 277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q233 26 290 98L298 109L352 326Z"></path></g><g data-mml-node="mi" transform="translate(9680.1,0)"><path data-c="1D465" d="M52 289Q59 331 106 386T222 442Q257 442 286 424T329 379Q371 442 430 442Q467 442 494 420T522 361Q522 332 508 314T481 292T458 288Q439 288 427 299T415 328Q415 374 465 391Q454 404 425 404Q412 404 406 402Q368 386 350 336Q290 115 290 78Q290 50 306 38T341 26Q378 26 414 59T463 140Q466 150 469 151T485 153H489Q504 153 504 145Q504 144 502 134Q486 77 440 33T333 -11Q263 -11 227 52Q186 -10 133 -10H127Q78 -10 57 16T35 71Q35 103 54 123T99 143Q142 143 142 101Q142 81 130 66T107 46T94 41L91 40Q91 39 97 36T113 29T132 26Q168 26 194 71Q203 87 217 139T245 247T261 313Q266 340 266 352Q266 380 251 392T217 404Q177 404 142 372T93 290Q91 281 88 280T72 278H58Q52 284 52 289Z"></path></g><g data-mml-node="mo" transform="translate(10529.9,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path></g><g data-mml-node="TeXAtom" data-mjx-texclass="ORD" transform="translate(11585.7,0)"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D53C" d="M12 666Q12 675 24 683H582Q590 680 593 672V588Q593 514 591 502T575 490Q567 490 563 495T555 517Q552 556 517 590Q486 623 445 634T340 648H282Q266 636 264 620T260 492V370H277Q329 375 358 391T404 439Q420 480 420 506Q420 529 436 529Q445 529 451 521Q455 517 455 361Q455 333 455 298T456 253Q456 217 453 207T437 197Q420 196 420 217Q420 240 406 270Q377 328 284 335H260V201Q261 174 261 134Q262 73 264 61T278 38Q281 36 282 35H331Q400 35 449 50Q571 93 602 179Q605 203 622 203Q629 203 634 197T640 183Q638 181 624 95T604 3L600 -1H24Q12 5 12 16Q12 35 51 35Q92 38 97 52Q102 60 102 341T97 632Q91 645 51 648Q12 648 12 666ZM137 341Q137 131 136 89T130 37Q129 36 129 35H235Q233 41 231 48L226 61V623L231 635L235 648H129Q132 641 133 638T135 603T137 517T137 341ZM557 603V648H504Q504 646 515 639Q527 634 542 619L557 603ZM420 317V397L406 383Q394 370 380 363L366 355Q373 350 382 346Q400 333 409 328L420 317ZM582 61L586 88Q585 88 582 83Q557 61 526 46L511 37L542 35H577Q577 36 578 39T580 49T582 61Z"></path></g><g data-mml-node="mi" transform="translate(700,-176.7) scale(0.707)"><text data-variant="double-struck" transform="scale(1,-1)" font-size="884px">ğ•©</text></g></g></g><g data-mml-node="mo" transform="translate(12759.9,0)"><path data-c="5B" d="M118 -250V750H255V710H158V-210H255V-250H118Z"></path></g><g data-mml-node="mi" transform="translate(13037.9,0)"><path data-c="1D45D" d="M23 287Q24 290 25 295T30 317T40 348T55 381T75 411T101 433T134 442Q209 442 230 378L240 387Q302 442 358 442Q423 442 460 395T497 281Q497 173 421 82T249 -10Q227 -10 210 -4Q199 1 187 11T168 28L161 36Q160 35 139 -51T118 -138Q118 -144 126 -145T163 -148H188Q194 -155 194 -157T191 -175Q188 -187 185 -190T172 -194Q170 -194 161 -194T127 -193T65 -192Q-5 -192 -24 -194H-32Q-39 -187 -39 -183Q-37 -156 -26 -148H-6Q28 -147 33 -136Q36 -130 94 103T155 350Q156 355 156 364Q156 405 131 405Q109 405 94 377T71 316T59 280Q57 278 43 278H29Q23 284 23 287ZM178 102Q200 26 252 26Q282 26 310 49T356 107Q374 141 392 215T411 325V331Q411 405 350 405Q339 405 328 402T306 393T286 380T269 365T254 350T243 336T235 326L232 322Q232 321 229 308T218 264T204 212Q178 106 178 102Z"></path></g><g data-mml-node="TeXAtom" data-mjx-texclass="ORD" transform="translate(13540.9,0)"><g data-mml-node="mo" transform="translate(0 -0.5)"><path data-c="28" d="M103 166T103 251T121 412T165 541T225 639T287 708T341 750H356H361Q382 750 382 736Q382 732 365 714T323 661T274 576T232 439T214 250Q214 -62 381 -229Q382 -231 382 -234Q382 -249 360 -249H356H341Q314 -231 287 -207T226 -138T165 -41T121 89Z"></path></g><g data-mml-node="mi" transform="translate(447,0)"><path data-c="1D432" d="M84 -102Q84 -110 87 -119T102 -138T133 -149Q148 -148 162 -143T186 -131T206 -114T222 -95T234 -76T243 -59T249 -45T252 -37L269 0L96 382H26V444H34Q49 441 146 441Q252 441 270 444H279V382H255Q232 382 232 380L337 151L442 382H394V444H401Q413 441 495 441Q568 441 574 444H580V382H510L406 152Q298 -84 297 -87Q269 -139 225 -169T131 -200Q85 -200 54 -172T23 -100Q23 -64 44 -50T87 -35Q111 -35 130 -50T152 -92V-100H84V-102Z"></path></g><g data-mml-node="mo" transform="translate(1054,0) translate(0 -0.5)"><path data-c="7C" d="M139 -249H137Q125 -249 119 -235V251L120 737Q130 750 139 750Q152 750 159 735V-235Q151 -249 141 -249H139Z"></path></g><g data-mml-node="mi" transform="translate(1332,0)"><path data-c="1D431" d="M227 0Q212 3 121 3Q40 3 28 0H21V62H117L245 213L109 382H26V444H34Q49 441 143 441Q247 441 265 444H274V382H246L281 339Q315 297 316 297Q320 297 354 341L389 382H352V444H360Q375 441 466 441Q547 441 559 444H566V382H471L355 246L504 63L545 62H586V0H578Q563 3 469 3Q365 3 347 0H338V62H366Q366 63 326 112T285 163L198 63L217 62H235V0H227Z"></path></g><g data-mml-node="mo" transform="translate(1939,0) translate(0 -0.5)"><path data-c="29" d="M231 251Q231 354 214 439T173 575T123 661T81 714T64 735Q64 744 73 749H75Q77 749 79 749T84 750T90 750H105Q132 732 159 708T220 639T281 542T325 413T343 251T325 89T281 -40T221 -138T159 -207T105 -249H90Q80 -249 76 -249T68 -245T64 -234Q64 -230 81 -212T123 -160T172 -75T214 61T231 251Z"></path></g></g><g data-mml-node="mo" transform="translate(15926.9,0)"><path data-c="5D" d="M22 710V750H159V-250H22V-210H119V710H22Z"></path></g></g></g></svg></mjx-container></span></p><p>hellofasdf</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>paper_read</title>
    <link href="/2024/01/25/paper-read/"/>
    <url>/2024/01/25/paper-read/</url>
    
    <content type="html"><![CDATA[<p>æ–‡ç« é˜…è¯»<br><span id="more"></span></p><p><strong>NOTE</strong>:<a href="https://blog.csdn.net/lx_ros/article/details/124240258">æ•°å­¦å…¬å¼å ‚å ‚æ”¯æŒ</a></p><p><strong>NOTE</strong>: <a href="https://www.notion.so/PAPER-0ce3b7d6f7444da8b386f33d21b0afe8?pvs=4">è°ƒè¯•æ•°å­¦å…¬å¼æ¼ç¾æˆæ€’è°ƒæ•´è‡³notionä¸­å®Œæˆ</a></p><h1 id="paper-read"><a href="#paper-read" class="headerlink" title="paper_read"></a>paper_read</h1><p><a href="https://gitee.com/ZhangYi_ustc/torch_learn">å­¦ä¹ ä»£ç </a></p><center><iframe src="//player.bilibili.com/player.html?aid=536046404&bvid=BV1zu411F7xV&cid=1337475913&p=1" scrolling="no" border="0" frameborder="no" framespacing="0" allowfullscreen="true"> </iframe></center><h2 id="TODO-list"><a href="#TODO-list" class="headerlink" title="TODO list"></a>TODO list</h2><ul><li>[x] Prompting Large Language Models for Recommender Systems: A Comprehensive Framework and Empirical Analysis</li><li>[x]  LlamaRec: Two-Stage Recommendation using Large Language Models for Ranking</li><li>[x]  Adapting Large Language Models by Integrating Collaborative Semantics for Recommendation</li><li>[x]  Toolformer: Language Models Can Teach Themselves to Use Tools</li><li>[x]  clip</li><li>[x]  dalle2</li><li>[x] Generative Modeling by Estimating Gradients of the Data Distribution</li></ul><!-- <div>            <input type="checkbox" disabled checked="checked">checked?          </div> --><h2 id="Generative-model"><a href="#Generative-model" class="headerlink" title="Generative model"></a>Generative model</h2><h3 id="Generative-Modeling-by-Estimating-Gradients-of-the-Data-Distribution"><a href="#Generative-Modeling-by-Estimating-Gradients-of-the-Data-Distribution" class="headerlink" title="Generative Modeling by Estimating Gradients of the Data Distribution"></a><a href="https://zhuanlan.zhihu.com/p/656417979">Generative Modeling by Estimating Gradients of the Data Distribution</a></h3><p><a href="https://www.bilibili.com/video/BV1Do4y16767/?spm_id_from=333.337.search-card.all.click&amp;vd_source=6299aeae8989a203c110117bfebb54f7">video</a><br>score ä¸ºæ•°æ®çš„å¯¹æ•°æ¦‚ç‡å¯†åº¦å¢é•¿æœ€å¿«çš„æ–¹å‘</p><script type="math/tex; mode=display">\mathbf{S\theta(x)}= \nabla_x\log_{p_\theta} (x)</script><!-- ![æ¢¯åº¦åœº](https://vdn3.vzuu.com/SD/83349034-5927-11ed-a869-76a40522aa1e.mp4?disable_local_cache=1&bu=078babd7&c=avc.1.1&f=mp4&expiration=1707227005&auth_key=1707227005-0-0-54dcd8af71d3cb2bc33cf3cc8fb9e478&v=tx&pu=078babd7) --><p>æœ—ä¹‹ä¸‡é‡‡æ ·:ä»å…ˆéªŒåˆ†å¸ƒä¸­éšæœºé‡‡æ ·ä¸€ä¸ªåˆå§‹æ ·æœ¬ï¼Œç„¶ååˆ©ç”¨scoreé€æ¸å°†æ ·æœ¬åƒæ•°æ®åˆ†å¸ƒçš„é«˜æ¦‚ç‡å¯†åº¦åŒºåŸŸé è¿‘ï¼ŒåŒæ—¶ä¸ºäº†ç”Ÿæˆç»“æœçš„å¤šæ ·æ€§ï¼Œéœ€è¦é‡‡ç”¨è¿‡ç¨‹å¸¦æœ‰éšæœºæ€§ã€‚åŒæ—¶zæœä»æ­£æ€åˆ†å¸ƒï¼Œepsilonä¸ºæ¯æ¬¡ç§»åŠ¨çš„æ­¥é•¿</p><script type="math/tex; mode=display">\bold{x}_{i+1} \rightarrow \bold{x}_i + \epsilon\nabla_x\log p(x)+\sqrt{2\epsilon}\bold{z_i}</script><h4 id="Denoising-Score-Matching"><a href="#Denoising-Score-Matching" class="headerlink" title="Denoising Score Matching"></a>Denoising Score Matching</h4><script type="math/tex; mode=display">q_\sigma(\tilde{x}|x)\thicksim N(\tilde{x};x,\sigma^2I)</script><h2 id="rec-amp-amp-llm"><a href="#rec-amp-amp-llm" class="headerlink" title="rec && llm"></a>rec &amp;&amp; llm</h2><h3 id="Prompting-Large-Language-Models-for-Recommender-Systems-A-Comprehensive-Framework-and-Empirical-Analysis"><a href="#Prompting-Large-Language-Models-for-Recommender-Systems-A-Comprehensive-Framework-and-Empirical-Analysis" class="headerlink" title="Prompting Large Language Models for Recommender Systems: A Comprehensive Framework and Empirical Analysis"></a>Prompting Large Language Models for Recommender Systems: A Comprehensive Framework and Empirical Analysis</h3><ul><li>[ ] code</li></ul><h4 id="some-finding"><a href="#some-finding" class="headerlink" title="some finding"></a>some finding</h4><ul><li>Fine-tuning all parameters of LLMs for recommendation is more effective than parameter-efficient fine-tuning, but more training time is required</li><li>Increasing the number of historical items to represent users brings insignificant gains for LLM</li></ul><h4 id="problem"><a href="#problem" class="headerlink" title="problem"></a>problem</h4><ul><li>Existing literature has also found the position bias in LLM-based recommendations [32, 74, 133], and methods such as bootstrapping [32] and Bayesian probability framework [74] havebeen proposed to calibrate unstable results. However, the instability of LLMs is still an unresolved issue.</li></ul><h3 id="Adapting-Large-Language-Models-by-Integrating-Collaborative-Semantics-for-Recommendation"><a href="#Adapting-Large-Language-Models-by-Integrating-Collaborative-Semantics-for-Recommendation" class="headerlink" title="Adapting Large Language Models by Integrating Collaborative Semantics for Recommendation"></a>Adapting Large Language Models by Integrating Collaborative Semantics for Recommendation</h3><p><img src="2step.png" alt=""></p><h4 id="idea"><a href="#idea" class="headerlink" title="idea"></a>idea</h4><p>recinterpret + llara</p><h4 id="motivation"><a href="#motivation" class="headerlink" title="motivation"></a>motivation</h4><p>integrate language and collaborative semantics for recommender systems<br>Our approach can directly generate items from the<br>entire item set for recommendation, without relying on candidate items.</p><h4 id="method"><a href="#method" class="headerlink" title="method"></a>method</h4><ol><li>item indexing<ol><li>These item indices are learned based on the text embeddings of items encoded by LLMs, enabling the learned IDs to capture the intrinsic similarity among items</li><li>æŒ‰ç…§è¯­ä¹‰ç›¸å…³åº¦ï¼Œåˆ†å‰²æˆæ ‘çŠ¶çš„id</li></ol></li><li>finetune<ol><li>å¤šç§æ¨èä»»åŠ¡çš„æ–‡æœ¬æè¿°finetune</li></ol></li></ol><h3 id="LlamaRec-Two-Stage-Recommendation-using-Large-Language-Models-for-Ranking"><a href="#LlamaRec-Two-Stage-Recommendation-using-Large-Language-Models-for-Ranking" class="headerlink" title="LlamaRec: Two-Stage Recommendation using Large Language Models for Ranking"></a>LlamaRec: Two-Stage Recommendation using Large Language Models for Ranking</h3><ul><li>[x] code æŠ½è±¡ç±»ï¼Œæ•°æ®å¤„ç†åŠ è½½ ï¼Œllamaçš„logitsè¿ç”¨</li></ul><p><img src="llamarec.png" alt=""></p><h4 id="idea-1"><a href="#idea-1" class="headerlink" title="idea"></a>idea</h4><p>å‡çº§ç‰ˆæœ¬tallrec,tallrecçš„å€™é€‰listçš„å»¶ä¼¸,é€šè¿‡logits+softmaxçš„å½¢å¼æ¥è¿›è¡Œé‡æ–°æ’åºï¼Œä½†æ˜¯è®­ç»ƒçš„æ–¹å¼åŒalpacaï¼Œä½†æ˜¯ç”¨äº†pytorch-lightingçš„å½¢å¼ã€‚</p><h4 id="motivation-å¬å›-æ’åº"><a href="#motivation-å¬å›-æ’åº" class="headerlink" title="motivation å¬å› æ’åº"></a>motivation å¬å› æ’åº</h4><ol><li>åºåˆ—æ¨èå¬å›list</li><li>è®¾è®¡äº† verbalizer approachï¼Œç”¨è®¡ç®—logitsçš„æ–¹å¼ä½œä¸ºæ‰“åˆ†ä¾æ®ï¼Œè§£å†³äº†æ¨ç†æ—¶å»¶é—®é¢˜</li><li>åˆ†è¯çš„æ–¹å¼æ˜¯itemé€ä¸€å¤„ç†å†è¿›è¡Œæ‹¼æ¥ã€‚</li></ol><h4 id="novelty"><a href="#novelty" class="headerlink" title="novelty"></a>novelty</h4><p>method</p><h2 id="llm"><a href="#llm" class="headerlink" title="llm"></a>llm</h2><h3 id="Toolformer-Language-Models-Can-Teach-Themselves-to-Use-Tools"><a href="#Toolformer-Language-Models-Can-Teach-Themselves-to-Use-Tools" class="headerlink" title="Toolformer: Language Models Can Teach Themselves to Use Tools"></a>Toolformer: Language Models Can Teach Themselves to Use Tools</h3><p><img src="toolformer.png" alt=""></p><ul><li>[x] code: æ­£åˆ™è¡¨è¾¾å¼</li></ul><h4 id="idea-2"><a href="#idea-2" class="headerlink" title="idea"></a>idea</h4><p>æ— ç›‘ç£çš„æ–¹å¼æ•™ä¼šè¯­è¨€æ¨¡å‹ä½¿ç”¨å·¥å…·</p><h4 id="motivation-1"><a href="#motivation-1" class="headerlink" title="motivation"></a>motivation</h4><p>ç›¸å½“äºå¤šéæ‰«æçš„è¿‡ç¨‹ï¼Œç¬¬ä¸€étextæ’å…¥åœ¨å“ªä½¿ç”¨å·¥å…·ï¼Œç¬¬äºŒéé€šè¿‡æ›¿æ¢å·¥å…·çš„å†…å®¹ï¼Œé€šè¿‡losså‡½æ•°çš„è®¡ç®—å†³å®šæ˜¯å¦æ›¿æ¢ï¼Œç„¶åç”¨finetuneçš„æ‰‹æ®µè¿›è¡Œç”Ÿæˆã€‚</p><h4 id="method-1"><a href="#method-1" class="headerlink" title="method"></a>method</h4><ol><li>æ·»åŠ åœ¨å“ªé‡Œä½¿ç”¨å·¥å…·</li><li>è°ƒç”¨å·¥å…·ï¼ŒåŒæ—¶è®¡ç®—lossï¼Œè®¾ç½®é˜€å€¼å†³å®šæ˜¯å¦éœ€è¦æ›¿æ¢ã€‚</li></ol><h2 id="vision-amp-amp-LLM"><a href="#vision-amp-amp-LLM" class="headerlink" title="vision && LLM"></a>vision &amp;&amp; LLM</h2><h3 id="CLIP"><a href="#CLIP" class="headerlink" title="CLIP"></a>CLIP</h3><p><img src="CLIP.png" alt="CLIP"></p><h4 id="idea-3"><a href="#idea-3" class="headerlink" title="idea"></a>idea</h4><p>our intuition is that CLIP models will need to learn to recognize a wide variety of visual concepts in images and associate them with their names</p><h4 id="method-2"><a href="#method-2" class="headerlink" title="method"></a>method</h4><p>é€šè¿‡æ­£è´Ÿæ ·æœ¬å¯¹è¿›è¡Œè®­ç»ƒ,æ ·æœ¬å¯¹é€šè¿‡ç¼–ç å™¨ï¼Œç„¶ååŒæ—¶å¯¹batchä¸­å¤šå¯¹æ ·æœ¬è¿›è¡Œç‚¹ç§¯å¤„ç†ï¼Œç„¶åå¯ä»¥åˆ†å‡ºæ­£è´Ÿçš„æ ·æœ¬å¯¹</p><p>  <img src="Contrast_CLIP.png" alt="clip-contrast"></p><h3 id="diffusion"><a href="#diffusion" class="headerlink" title="diffusion"></a>diffusion</h3><p>æŠŠpictureä½œä¸ºè§†é¢‘çš„idï¼Œç„¶åç”¨æ–‡æœ¬è¿›è¡Œç”Ÿæˆï¼Œç„¶åç”¨ç”Ÿæˆçš„pictureä½œä¸ºæ£€ç´¢çš„ç­–ç•¥ï¼Ÿ</p><ol><li>æ–‡å­—LLMå¢å¤§ï¼Œencoder æˆå¯¹èµ„æ–™æ›´å¥½ï¼Œä½†æ˜¯diffusion modelæ‰©å¤§æ•ˆæœä¸å¥½</li><li>FID è¯„ä¼°æŒ‡æ ‡ small is better<br><img src="./paper-read/FID.png" alt="FID"></li></ol><h3 id="NLP-diffusion"><a href="#NLP-diffusion" class="headerlink" title="NLP-diffusion"></a>NLP-diffusion</h3><p>é€šè¿‡tokenè½¬æ¢æˆembeddingä¸Šé¢æ·»åŠ noiseï¼Œå†è¿›è¡Œè¿˜åŸ<br>[ ] to be done</p><p><img src="./NLP-diffusion.png" alt="NLP"></p><p><img src="./NLP-diffusion2.png" alt="NLP2"></p><h3 id="stable-diffusion"><a href="#stable-diffusion" class="headerlink" title="stable diffusion"></a>stable diffusion</h3><h4 id="decode"><a href="#decode" class="headerlink" title="decode"></a>decode</h4><p><img src="Decoder-SD.png" alt="decode"></p><font color="blue">i am blue</font>heloo<font color="red">i am red </font><font style="background-color:yellow">hel</font><h2 id="ablity"><a href="#ablity" class="headerlink" title="ablity"></a>ablity</h2><ul><li>[x] <a href="https://lilianweng.github.io/posts/2023-01-27-the-transformer-family-v2/">transformer-famlily</a></li></ul><h2 id="application"><a href="#application" class="headerlink" title="application"></a>application</h2><ol><li>adaptive attendsion span </li><li><strong>class-free guidance</strong></li></ol><p>week </p><ol><li>transformerç›¸å…³æ¨¡å‹ä¸blog</li><li>æ¢ç©¶å¤šæ¨¡æ€æ¨èï¼Œä¸»è¦å­¦ä¹ diffusionæ¨¡å‹ï¼Œå¹¶å¤åŸäº†diffusionï¼ˆDDPMï¼‰çš„ä»£ç ã€‚ç„¶åé˜…è¯»çš„è®ºæ–‡æœ‰clipï¼ˆæ–‡æœ¬æ®µå’Œå›¾ç‰‡çš„å¯¹æ¯”å­¦ä¹ ï¼‰ï¼Œdalle2ï¼ˆunclipæ¨¡å‹ï¼‰ã€‚è¿™ä¸¤ç¯‡å·¥ä½œéƒ½å¼ºè°ƒäº†å¢å¤§æ•°æ®è§„æ¨¡åï¼Œæ€§èƒ½è·å¾—äº†å¤§å¹…æå‡ï¼Œï¼ˆä¸ç¡®å®šdiffusion+recæ˜¯å¦å¯è¡Œå±€é™äºrecæ•°æ®é›†å’ŒCVæ•°æ®é›†çš„å·®å¼‚ï¼Œä»¥åŠrecçš„æ•°æ®é‡æ˜¯ç¦»æ•£çš„ï¼Œä¹‹åè®¡åˆ’é˜…è¯»ä¸¤è€…ç»“åˆåçš„è®ºæ–‡diffurecï¼Œä»¥åŠæ‰“ç®—é˜…è¯»NLPä¸Šçš„diffusionåº”ç”¨å’Œclass-free guidanceè®ºæ–‡ï¼‰</li></ol>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>web</title>
    <link href="/2023/10/23/web/"/>
    <url>/2023/10/23/web/</url>
    
    <content type="html"><![CDATA[<h3 id="æ£€ç´¢"><a href="#æ£€ç´¢" class="headerlink" title="æ£€ç´¢"></a>æ£€ç´¢</h3><h4 id="é¢„è®­ç»ƒæ¨¡å‹"><a href="#é¢„è®­ç»ƒæ¨¡å‹" class="headerlink" title="é¢„è®­ç»ƒæ¨¡å‹"></a>é¢„è®­ç»ƒæ¨¡å‹</h4><p>å¤§è§„æ¨¡çš„æ•°æ®å’Œæ¨¡å‹,å­¦ä¹ è¯­æ–™åº“çš„çŸ¥è¯†,å°†è¿™äº›çŸ¥è¯†è¿ç§»åˆ°æŸä¸€ä¸ªå…·ä½“çš„ä»»åŠ¡ä¸­,ä»è€Œè·å¾—è¾ƒå¥½çš„è¡¨ç°<br><strong>transforms</strong></p><ul><li>åŸºäºä½ç½®ä¿¡æ¯è¡¨å¾,é€‚åº”è¾ƒé•¿çš„æ–‡æœ¬</li><li>ä¼˜åŠ¿:çŸ©é˜µä¹˜æ³•ä¸ºæ ¸å¿ƒ,GPUé«˜é€Ÿè¿ç®—</li><li><img src="web/æˆªå±.png" alt=""></li><li>bert:è¿‡ç»•è¯¶å®¶å‘åŒå‘å¤šå±‚,position + Token + segmentä¿¡æ¯embedding<ul><li>é¢„è®­ç»ƒ éšæœºmaskéƒ¨åˆ†è¯,ç„¶åç”¨ä¸Šä¸‹</li><li>fine-tune:<ul><li>é€‰æ‹©è®­ç»ƒå¥½çš„æœ€åä¸€å±‚,åˆ†ç±»å±‚è¿›è¡Œæ›¿æ¢,å†»ç»“å…ˆå‰çš„éƒ¨åˆ†,</li><li>åˆ©ç”¨æ–°çš„åˆ†ç±»å±‚çš„åç›¸ä¼ é€’ä¼˜åŒ–è¿‡å±‚</li></ul></li></ul></li><li>ç¼ºç‚¹,å®‰å…¨é—®é¢˜,ä»¥åŠ</li><li>ä¼˜ç‚¹:<ul><li>ä»»åŠ¡éš¾åº¦å¤§ é‡‡ç”¨ä¸Šæ¸¸é¢„è®­ç»ƒ,ä¸‹æ¸¸å¾®è°ƒçš„èŒƒå¼.</li><li>å……åˆ†åˆ©ç”¨äº†å¤§é‡çš„æ— æ ‡ç­¾æ•°æ®,å¼€æ”¾ä¸–ç•Œçš„çŸ¥è¯†åº”ç”¨äºä¸‹æ¸¸ä»»åŠ¡,ä»è€Œå¤§å¹…åº¦æé«˜äº†æ¨¡å‹æ•ˆæœ</li><li>å¯ä»¥ç›´æ¥ä½¿ç”¨</li></ul></li></ul><h2 id="ååŒè¿‡æ»¤"><a href="#ååŒè¿‡æ»¤" class="headerlink" title="ååŒè¿‡æ»¤"></a>ååŒè¿‡æ»¤</h2><p><img src="web/æˆªå±%201.png" alt=""></p><p><img src="web/æˆªå±%202.png" alt=""></p><h3 id="item"><a href="#item" class="headerlink" title="item"></a>item</h3><p><img src="web/æˆªå±%203.png" alt=""></p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>spyter</title>
    <link href="/2023/10/08/spyter/"/>
    <url>/2023/10/08/spyter/</url>
    
    <content type="html"><![CDATA[<h2 id="BeautifulSoup"><a href="#BeautifulSoup" class="headerlink" title="BeautifulSoup"></a>BeautifulSoup</h2><h3 id="use"><a href="#use" class="headerlink" title="use"></a>use</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># soup åˆ†è¯ä¹‹å,soup.pä¸ºä¸‹é¢çš„æ ‡é¢˜çš„å†…å®¹</span><br></code></pre></td></tr></table></figure><p>å¦‚æœéœ€è¦å¯»æ‰¾å¤šæ¡ç›¸åŒçš„æ ‡ç­¾ä¸‹çš„å†…å®¹ å¯ä»¥é€šè¿‡</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python">a_tag  = soup.find_all(<span class="hljs-string">&#x27;a&#x27;</span>)<span class="hljs-comment">#ä½œä¸ºæ‰¾åˆ°è¿™ä¸ªåˆ†å‰²ä¸‹é¢çš„</span><br><br>soup = BeautifulSoup(<span class="hljs-string">&#x27;&lt;b class=&quot;boldest&quot;&gt;Extremely bold&lt;/b&gt;&#x27;</span>, <span class="hljs-string">&#x27;lxml)</span><br><span class="hljs-string">soup.b.name#è¡¨ç¤ºtagçš„name</span><br><span class="hljs-string">soup.attrs[&quot;name&quot;]#å¯ä»¥é€‰æ‹©nameçš„å±æ€§æ ‡ç­¾</span><br><span class="hljs-string">soup.string#ä¹Ÿæ˜¯å¯ä»¥è·å–æ–‡æœ¬å†…å®¹</span><br><span class="hljs-string">soup.p.contents #ç”¨äºæŒ‡ç¤ºä¸¤è€…ä¹‹é—´çš„å†…å®¹</span><br><span class="hljs-string">soup.p.children #å¯ä»¥å±•ç°é‡Œé¢æ‰€æœ‰çš„æ ‡ç­¾</span><br><span class="hljs-string">parents # as same function</span><br><span class="hljs-string"></span><br></code></pre></td></tr></table></figure><h3 id="å­èŠ‚ç‚¹"><a href="#å­èŠ‚ç‚¹" class="headerlink" title="å­èŠ‚ç‚¹"></a>å­èŠ‚ç‚¹</h3>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>prompt-engineer</title>
    <link href="/2023/10/07/prompt-engineer/"/>
    <url>/2023/10/07/prompt-engineer/</url>
    
    <content type="html"><![CDATA[<h1 id="Prompt-Engineering-for-Developer"><a href="#Prompt-Engineering-for-Developer" class="headerlink" title="Prompt Engineering for Developer"></a>Prompt Engineering for Developer</h1><h2 id="Guideline"><a href="#Guideline" class="headerlink" title="Guideline"></a>Guideline</h2><h3 id="ç¼–å†™æ¸…æ™°ã€å…·ä½“çš„æŒ‡ä»¤"><a href="#ç¼–å†™æ¸…æ™°ã€å…·ä½“çš„æŒ‡ä»¤" class="headerlink" title="ç¼–å†™æ¸…æ™°ã€å…·ä½“çš„æŒ‡ä»¤"></a>ç¼–å†™æ¸…æ™°ã€å…·ä½“çš„æŒ‡ä»¤</h3><h4 id="åˆ†éš”ç¬¦"><a href="#åˆ†éš”ç¬¦" class="headerlink" title="åˆ†éš”ç¬¦"></a>åˆ†éš”ç¬¦</h4><p>â€œâ€â€ï¼Œ&lt; &gt;ï¼Œ<tag> </tag>ä¹‹ç±»çš„ä½œä¸º,é˜²æ­¢Prompt Rejection</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> tool <span class="hljs-keyword">import</span> get_completion<br><br>text = <span class="hljs-string">f&quot;&quot;&quot;</span><br><span class="hljs-string">æ‚¨åº”è¯¥æä¾›å°½å¯èƒ½æ¸…æ™°ã€å…·ä½“çš„æŒ‡ç¤ºï¼Œä»¥è¡¨è¾¾æ‚¨å¸Œæœ›æ¨¡å‹æ‰§è¡Œçš„ä»»åŠ¡ã€‚\</span><br><span class="hljs-string">è¿™å°†å¼•å¯¼æ¨¡å‹æœå‘æ‰€éœ€çš„è¾“å‡ºï¼Œå¹¶é™ä½æ”¶åˆ°æ— å…³æˆ–ä¸æ­£ç¡®å“åº”çš„å¯èƒ½æ€§ã€‚\</span><br><span class="hljs-string">ä¸è¦å°†å†™æ¸…æ™°çš„æç¤ºè¯ä¸å†™ç®€çŸ­çš„æç¤ºè¯æ··æ·†ã€‚\</span><br><span class="hljs-string">åœ¨è®¸å¤šæƒ…å†µä¸‹ï¼Œæ›´é•¿çš„æç¤ºè¯å¯ä»¥ä¸ºæ¨¡å‹æä¾›æ›´å¤šçš„æ¸…æ™°åº¦å’Œä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œä»è€Œå¯¼è‡´æ›´è¯¦ç»†å’Œç›¸å…³çš„è¾“å‡ºã€‚</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-comment"># éœ€è¦æ€»ç»“çš„æ–‡æœ¬å†…å®¹</span><br>prompt = <span class="hljs-string">f&quot;&quot;&quot;</span><br><span class="hljs-string">æŠŠç”¨ä¸‰ä¸ªåå¼•å·æ‹¬èµ·æ¥çš„æ–‡æœ¬æ€»ç»“æˆä¸€å¥è¯ã€‚</span><br><span class="hljs-string">```<span class="hljs-subst">&#123;text&#125;</span>```</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-comment"># æŒ‡ä»¤å†…å®¹ï¼Œä½¿ç”¨ ``` æ¥åˆ†éš”æŒ‡ä»¤å’Œå¾…æ€»ç»“çš„å†…å®¹</span><br>response = get_completion(prompt)<br><span class="hljs-built_in">print</span>(response)<br><span class="hljs-comment"># \ ä½œä¸ºåˆ†å‰²ç¬¦,åŒæ—¶å¯ä»¥æŒ‡ç¤ºç”Ÿæˆçš„æ–‡æ¡£</span><br>prompt = <span class="hljs-string">f&quot;&quot;&quot;</span><br><span class="hljs-string">è¯·ç”ŸæˆåŒ…æ‹¬ä¹¦åã€ä½œè€…å’Œç±»åˆ«çš„ä¸‰æœ¬è™šæ„çš„ã€éçœŸå®å­˜åœ¨çš„ä¸­æ–‡ä¹¦ç±æ¸…å•ï¼Œ\</span><br><span class="hljs-string">å¹¶ä»¥ JSON æ ¼å¼æä¾›ï¼Œå…¶ä¸­åŒ…å«ä»¥ä¸‹é”®:book_idã€titleã€authorã€genreã€‚</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br>response = get_completion(prompt)<br><span class="hljs-built_in">print</span>(response)<br><br><br></code></pre></td></tr></table></figure><h4 id="æ£€æŸ¥æ¨¡å‹æ˜¯å¦æ»¡è¶³æ¡ä»¶"><a href="#æ£€æŸ¥æ¨¡å‹æ˜¯å¦æ»¡è¶³æ¡ä»¶" class="headerlink" title="æ£€æŸ¥æ¨¡å‹æ˜¯å¦æ»¡è¶³æ¡ä»¶"></a>æ£€æŸ¥æ¨¡å‹æ˜¯å¦æ»¡è¶³æ¡ä»¶</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># æ»¡è¶³æ¡ä»¶çš„è¾“å…¥ï¼ˆtextä¸­æä¾›äº†æ­¥éª¤ï¼‰</span><br>text_1 = <span class="hljs-string">f&quot;&quot;&quot;</span><br><span class="hljs-string">æ³¡ä¸€æ¯èŒ¶å¾ˆå®¹æ˜“ã€‚é¦–å…ˆï¼Œéœ€è¦æŠŠæ°´çƒ§å¼€ã€‚\</span><br><span class="hljs-string">åœ¨ç­‰å¾…æœŸé—´ï¼Œæ‹¿ä¸€ä¸ªæ¯å­å¹¶æŠŠèŒ¶åŒ…æ”¾è¿›å»ã€‚\</span><br><span class="hljs-string">ä¸€æ—¦æ°´è¶³å¤Ÿçƒ­ï¼Œå°±æŠŠå®ƒå€’åœ¨èŒ¶åŒ…ä¸Šã€‚\</span><br><span class="hljs-string">ç­‰å¾…ä¸€ä¼šå„¿ï¼Œè®©èŒ¶å¶æµ¸æ³¡ã€‚å‡ åˆ†é’Ÿåï¼Œå–å‡ºèŒ¶åŒ…ã€‚\</span><br><span class="hljs-string">å¦‚æœæ‚¨æ„¿æ„ï¼Œå¯ä»¥åŠ ä¸€äº›ç³–æˆ–ç‰›å¥¶è°ƒå‘³ã€‚\</span><br><span class="hljs-string">å°±è¿™æ ·ï¼Œæ‚¨å¯ä»¥äº«å—ä¸€æ¯ç¾å‘³çš„èŒ¶äº†ã€‚</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br>prompt = <span class="hljs-string">f&quot;&quot;&quot;</span><br><span class="hljs-string">æ‚¨å°†è·å¾—ç”±ä¸‰ä¸ªå¼•å·æ‹¬èµ·æ¥çš„æ–‡æœ¬ã€‚\</span><br><span class="hljs-string">å¦‚æœå®ƒåŒ…å«ä¸€ç³»åˆ—çš„æŒ‡ä»¤ï¼Œåˆ™éœ€è¦æŒ‰ç…§ä»¥ä¸‹æ ¼å¼é‡æ–°ç¼–å†™è¿™äº›æŒ‡ä»¤ï¼š</span><br><span class="hljs-string"></span><br><span class="hljs-string">ç¬¬ä¸€æ­¥ - ...</span><br><span class="hljs-string">ç¬¬äºŒæ­¥ - â€¦</span><br><span class="hljs-string">â€¦</span><br><span class="hljs-string">ç¬¬Næ­¥ - â€¦</span><br><span class="hljs-string"></span><br><span class="hljs-string">å¦‚æœæ–‡æœ¬ä¸­ä¸åŒ…å«ä¸€ç³»åˆ—çš„æŒ‡ä»¤ï¼Œåˆ™ç›´æ¥å†™â€œæœªæä¾›æ­¥éª¤â€ã€‚&quot;</span><br><span class="hljs-string">\&quot;\&quot;\&quot;<span class="hljs-subst">&#123;text_1&#125;</span>\&quot;\&quot;\&quot;</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br>response = get_completion(prompt)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Text 1 çš„æ€»ç»“:&quot;</span>)<br><span class="hljs-built_in">print</span>(response)<br></code></pre></td></tr></table></figure><h4 id="æä¾›å°‘é‡ç¤ºä¾‹"><a href="#æä¾›å°‘é‡ç¤ºä¾‹" class="headerlink" title="æä¾›å°‘é‡ç¤ºä¾‹"></a>æä¾›å°‘é‡ç¤ºä¾‹</h4><p>ç»™æ¨¡å‹ä¸€ä¸¤ä¸ªå·²ç»å®Œæˆçš„ç”¨ä¾‹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs python">prompt = <span class="hljs-string">f&quot;&quot;&quot;</span><br><span class="hljs-string">æ‚¨çš„ä»»åŠ¡æ˜¯ä»¥ä¸€è‡´çš„é£æ ¼å›ç­”é—®é¢˜ã€‚</span><br><span class="hljs-string"></span><br><span class="hljs-string">&lt;å­©å­&gt;: è¯·æ•™æˆ‘ä½•ä¸ºè€å¿ƒã€‚</span><br><span class="hljs-string"></span><br><span class="hljs-string">&lt;ç¥–çˆ¶æ¯&gt;: æŒ–å‡ºæœ€æ·±å³¡è°·çš„æ²³æµæºäºä¸€å¤„ä¸èµ·çœ¼çš„æ³‰çœ¼ï¼›æœ€å®ä¼Ÿçš„äº¤å“ä¹ä»å•ä¸€çš„éŸ³ç¬¦å¼€å§‹ï¼›æœ€å¤æ‚çš„æŒ‚æ¯¯ä»¥ä¸€æ ¹å­¤ç‹¬çš„çº¿å¼€å§‹ç¼–ç»‡ã€‚</span><br><span class="hljs-string"></span><br><span class="hljs-string">&lt;å­©å­&gt;: è¯·æ•™æˆ‘ä½•ä¸ºéŸ§æ€§ã€‚</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br>response = get_completion(prompt)<br><span class="hljs-built_in">print</span>(response)<br></code></pre></td></tr></table></figure><h3 id="ç»™æ¨¡å‹æ—¶é—´æ€è€ƒ"><a href="#ç»™æ¨¡å‹æ—¶é—´æ€è€ƒ" class="headerlink" title="ç»™æ¨¡å‹æ—¶é—´æ€è€ƒ"></a>ç»™æ¨¡å‹æ—¶é—´æ€è€ƒ</h3><h4 id="æŒ‡å®šå®Œæˆä»»åŠ¡æ‰€éœ€è¦çš„æ­¥éª¤"><a href="#æŒ‡å®šå®Œæˆä»»åŠ¡æ‰€éœ€è¦çš„æ­¥éª¤" class="headerlink" title="æŒ‡å®šå®Œæˆä»»åŠ¡æ‰€éœ€è¦çš„æ­¥éª¤"></a>æŒ‡å®šå®Œæˆä»»åŠ¡æ‰€éœ€è¦çš„æ­¥éª¤</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs python">text = <span class="hljs-string">f&quot;&quot;&quot;</span><br><span class="hljs-string">åœ¨ä¸€ä¸ªè¿·äººçš„æ‘åº„é‡Œï¼Œå…„å¦¹æ°å…‹å’Œå‰å°”å‡ºå‘å»ä¸€ä¸ªå±±é¡¶äº•é‡Œæ‰“æ°´ã€‚\</span><br><span class="hljs-string">ä»–ä»¬ä¸€è¾¹å”±ç€æ¬¢ä¹çš„æ­Œï¼Œä¸€è¾¹å¾€ä¸Šçˆ¬ï¼Œ\</span><br><span class="hljs-string">ç„¶è€Œä¸å¹¸é™ä¸´â€”â€”æ°å…‹ç»Šäº†ä¸€å—çŸ³å¤´ï¼Œä»å±±ä¸Šæ»šäº†ä¸‹æ¥ï¼Œå‰å°”ç´§éšå…¶åã€‚\</span><br><span class="hljs-string">è™½ç„¶ç•¥æœ‰äº›æ‘”ä¼¤ï¼Œä½†ä»–ä»¬è¿˜æ˜¯å›åˆ°äº†æ¸©é¦¨çš„å®¶ä¸­ã€‚\</span><br><span class="hljs-string">å°½ç®¡å‡ºäº†è¿™æ ·çš„æ„å¤–ï¼Œä»–ä»¬çš„å†’é™©ç²¾ç¥ä¾ç„¶æ²¡æœ‰å‡å¼±ï¼Œç»§ç»­å……æ»¡æ„‰æ‚¦åœ°æ¢ç´¢ã€‚</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-comment"># example 1</span><br>prompt_1 = <span class="hljs-string">f&quot;&quot;&quot;</span><br><span class="hljs-string">æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š</span><br><span class="hljs-string">1-ç”¨ä¸€å¥è¯æ¦‚æ‹¬ä¸‹é¢ç”¨ä¸‰ä¸ªåå¼•å·æ‹¬èµ·æ¥çš„æ–‡æœ¬ã€‚</span><br><span class="hljs-string">2-å°†æ‘˜è¦ç¿»è¯‘æˆè‹±è¯­ã€‚</span><br><span class="hljs-string">3-åœ¨è‹±è¯­æ‘˜è¦ä¸­åˆ—å‡ºæ¯ä¸ªäººåã€‚</span><br><span class="hljs-string">4-è¾“å‡ºä¸€ä¸ª JSON å¯¹è±¡ï¼Œå…¶ä¸­åŒ…å«ä»¥ä¸‹é”®ï¼šenglish_summaryï¼Œnum_namesã€‚</span><br><span class="hljs-string"></span><br><span class="hljs-string">è¯·ç”¨æ¢è¡Œç¬¦åˆ†éš”æ‚¨çš„ç­”æ¡ˆã€‚</span><br><span class="hljs-string"></span><br><span class="hljs-string">Text:</span><br><span class="hljs-string">```<span class="hljs-subst">&#123;text&#125;</span>```</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br>response = get_completion(prompt_1)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;prompt 1:&quot;</span>)<br><span class="hljs-built_in">print</span>(response)<br><br>prompt_2 = <span class="hljs-string">f&quot;&quot;&quot;</span><br><span class="hljs-string">1-ç”¨ä¸€å¥è¯æ¦‚æ‹¬ä¸‹é¢ç”¨&lt;&gt;æ‹¬èµ·æ¥çš„æ–‡æœ¬ã€‚</span><br><span class="hljs-string">2-å°†æ‘˜è¦ç¿»è¯‘æˆè‹±è¯­ã€‚</span><br><span class="hljs-string">3-åœ¨è‹±è¯­æ‘˜è¦ä¸­åˆ—å‡ºæ¯ä¸ªåç§°ã€‚</span><br><span class="hljs-string">4-è¾“å‡ºä¸€ä¸ª JSON å¯¹è±¡ï¼Œå…¶ä¸­åŒ…å«ä»¥ä¸‹é”®ï¼šEnglish_summaryï¼Œnum_namesã€‚</span><br><span class="hljs-string"></span><br><span class="hljs-string">è¯·ä½¿ç”¨ä»¥ä¸‹æ ¼å¼ï¼š</span><br><span class="hljs-string">æ–‡æœ¬ï¼š&lt;è¦æ€»ç»“çš„æ–‡æœ¬&gt;</span><br><span class="hljs-string">æ‘˜è¦ï¼š&lt;æ‘˜è¦&gt;</span><br><span class="hljs-string">ç¿»è¯‘ï¼š&lt;æ‘˜è¦çš„ç¿»è¯‘&gt;</span><br><span class="hljs-string">åç§°ï¼š&lt;è‹±è¯­æ‘˜è¦ä¸­çš„åç§°åˆ—è¡¨&gt;</span><br><span class="hljs-string">è¾“å‡º JSONï¼š&lt;å¸¦æœ‰ English_summary å’Œ num_names çš„ JSON&gt;</span><br><span class="hljs-string"></span><br><span class="hljs-string">Text: &lt;<span class="hljs-subst">&#123;text&#125;</span>&gt;</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br>response = get_completion(prompt_2)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\nprompt 2:&quot;</span>)<br><span class="hljs-built_in">print</span>(response)<br><br></code></pre></td></tr></table></figure><h4 id="æŒ‡å¯¼æ¨¡å‹åœ¨ä¸‹ç»“è®ºä¹‹å‰æ‰¾åˆ°ä¸€ä¸ªè‡ªå·±çš„è§£æ³•"><a href="#æŒ‡å¯¼æ¨¡å‹åœ¨ä¸‹ç»“è®ºä¹‹å‰æ‰¾åˆ°ä¸€ä¸ªè‡ªå·±çš„è§£æ³•" class="headerlink" title="æŒ‡å¯¼æ¨¡å‹åœ¨ä¸‹ç»“è®ºä¹‹å‰æ‰¾åˆ°ä¸€ä¸ªè‡ªå·±çš„è§£æ³•"></a>æŒ‡å¯¼æ¨¡å‹åœ¨ä¸‹ç»“è®ºä¹‹å‰æ‰¾åˆ°ä¸€ä¸ªè‡ªå·±çš„è§£æ³•</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs python">prompt = <span class="hljs-string">f&quot;&quot;&quot;</span><br><span class="hljs-string">è¯·åˆ¤æ–­å­¦ç”Ÿçš„è§£å†³æ–¹æ¡ˆæ˜¯å¦æ­£ç¡®ï¼Œè¯·é€šè¿‡å¦‚ä¸‹æ­¥éª¤è§£å†³è¿™ä¸ªé—®é¢˜ï¼š</span><br><span class="hljs-string"></span><br><span class="hljs-string">æ­¥éª¤ï¼š</span><br><span class="hljs-string"></span><br><span class="hljs-string">    é¦–å…ˆï¼Œè‡ªå·±è§£å†³é—®é¢˜ã€‚</span><br><span class="hljs-string">    ç„¶åå°†æ‚¨çš„è§£å†³æ–¹æ¡ˆä¸å­¦ç”Ÿçš„è§£å†³æ–¹æ¡ˆè¿›è¡Œæ¯”è¾ƒï¼Œå¯¹æ¯”è®¡ç®—å¾—åˆ°çš„æ€»è´¹ç”¨ä¸å­¦ç”Ÿè®¡ç®—çš„æ€»è´¹ç”¨æ˜¯å¦ä¸€è‡´ï¼Œå¹¶è¯„ä¼°å­¦ç”Ÿçš„è§£å†³æ–¹æ¡ˆæ˜¯å¦æ­£ç¡®ã€‚</span><br><span class="hljs-string">    åœ¨è‡ªå·±å®Œæˆé—®é¢˜ä¹‹å‰ï¼Œè¯·å‹¿å†³å®šå­¦ç”Ÿçš„è§£å†³æ–¹æ¡ˆæ˜¯å¦æ­£ç¡®ã€‚</span><br><span class="hljs-string"></span><br><span class="hljs-string">ä½¿ç”¨ä»¥ä¸‹æ ¼å¼ï¼š</span><br><span class="hljs-string"></span><br><span class="hljs-string">    é—®é¢˜ï¼šé—®é¢˜æ–‡æœ¬</span><br><span class="hljs-string">    å­¦ç”Ÿçš„è§£å†³æ–¹æ¡ˆï¼šå­¦ç”Ÿçš„è§£å†³æ–¹æ¡ˆæ–‡æœ¬</span><br><span class="hljs-string">    å®é™…è§£å†³æ–¹æ¡ˆå’Œæ­¥éª¤ï¼šå®é™…è§£å†³æ–¹æ¡ˆå’Œæ­¥éª¤æ–‡æœ¬</span><br><span class="hljs-string">    å­¦ç”Ÿè®¡ç®—çš„æ€»è´¹ç”¨ï¼šå­¦ç”Ÿè®¡ç®—å¾—åˆ°çš„æ€»è´¹ç”¨</span><br><span class="hljs-string">    å®é™…è®¡ç®—çš„æ€»è´¹ç”¨ï¼šå®é™…è®¡ç®—å‡ºçš„æ€»è´¹ç”¨</span><br><span class="hljs-string">    å­¦ç”Ÿè®¡ç®—çš„è´¹ç”¨å’Œå®é™…è®¡ç®—çš„è´¹ç”¨æ˜¯å¦ç›¸åŒï¼šæ˜¯æˆ–å¦</span><br><span class="hljs-string">    å­¦ç”Ÿçš„è§£å†³æ–¹æ¡ˆå’Œå®é™…è§£å†³æ–¹æ¡ˆæ˜¯å¦ç›¸åŒï¼šæ˜¯æˆ–å¦</span><br><span class="hljs-string">    å­¦ç”Ÿçš„æˆç»©ï¼šæ­£ç¡®æˆ–ä¸æ­£ç¡®</span><br><span class="hljs-string"></span><br><span class="hljs-string">é—®é¢˜ï¼š</span><br><span class="hljs-string"></span><br><span class="hljs-string">    æˆ‘æ­£åœ¨å»ºé€ ä¸€ä¸ªå¤ªé˜³èƒ½å‘ç”µç«™ï¼Œéœ€è¦å¸®åŠ©è®¡ç®—è´¢åŠ¡ã€‚ </span><br><span class="hljs-string">    - åœŸåœ°è´¹ç”¨ä¸ºæ¯å¹³æ–¹è‹±å°º100ç¾å…ƒ</span><br><span class="hljs-string">    - æˆ‘å¯ä»¥ä»¥æ¯å¹³æ–¹è‹±å°º250ç¾å…ƒçš„ä»·æ ¼è´­ä¹°å¤ªé˜³èƒ½ç”µæ± æ¿</span><br><span class="hljs-string">    - æˆ‘å·²ç»è°ˆåˆ¤å¥½äº†ç»´æŠ¤åˆåŒï¼Œæ¯å¹´éœ€è¦æ”¯ä»˜å›ºå®šçš„10ä¸‡ç¾å…ƒï¼Œå¹¶é¢å¤–æ”¯ä»˜æ¯å¹³æ–¹è‹±å°º10ç¾å…ƒ;</span><br><span class="hljs-string"></span><br><span class="hljs-string">    ä½œä¸ºå¹³æ–¹è‹±å°ºæ•°çš„å‡½æ•°ï¼Œé¦–å¹´è¿è¥çš„æ€»è´¹ç”¨æ˜¯å¤šå°‘ã€‚</span><br><span class="hljs-string"></span><br><span class="hljs-string">å­¦ç”Ÿçš„è§£å†³æ–¹æ¡ˆï¼š</span><br><span class="hljs-string"></span><br><span class="hljs-string">    è®¾xä¸ºå‘ç”µç«™çš„å¤§å°ï¼Œå•ä½ä¸ºå¹³æ–¹è‹±å°ºã€‚</span><br><span class="hljs-string">    è´¹ç”¨ï¼š</span><br><span class="hljs-string">    1. åœŸåœ°è´¹ç”¨ï¼š100xç¾å…ƒ</span><br><span class="hljs-string">    2. å¤ªé˜³èƒ½ç”µæ± æ¿è´¹ç”¨ï¼š250xç¾å…ƒ</span><br><span class="hljs-string">    3. ç»´æŠ¤è´¹ç”¨ï¼š100,000+100x=10ä¸‡ç¾å…ƒ+10xç¾å…ƒ</span><br><span class="hljs-string">    æ€»è´¹ç”¨ï¼š100xç¾å…ƒ+250xç¾å…ƒ+10ä¸‡ç¾å…ƒ+100xç¾å…ƒ=450x+10ä¸‡ç¾å…ƒ</span><br><span class="hljs-string"></span><br><span class="hljs-string">å®é™…è§£å†³æ–¹æ¡ˆå’Œæ­¥éª¤ï¼š</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br>response = get_completion(prompt)<br><span class="hljs-built_in">print</span>(response)<br></code></pre></td></tr></table></figure><h2 id="è¿­ä»£ä¼˜åŒ–"><a href="#è¿­ä»£ä¼˜åŒ–" class="headerlink" title="è¿­ä»£ä¼˜åŒ–"></a>è¿­ä»£ä¼˜åŒ–</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># ç¤ºä¾‹ï¼šäº§å“è¯´æ˜ä¹¦</span><br>fact_sheet_chair = <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">æ¦‚è¿°</span><br><span class="hljs-string"></span><br><span class="hljs-string">    ç¾ä¸½çš„ä¸­ä¸–çºªé£æ ¼åŠå…¬å®¶å…·ç³»åˆ—çš„ä¸€éƒ¨åˆ†ï¼ŒåŒ…æ‹¬æ–‡ä»¶æŸœã€åŠå…¬æ¡Œã€ä¹¦æŸœã€ä¼šè®®æ¡Œç­‰ã€‚</span><br><span class="hljs-string">    å¤šç§å¤–å£³é¢œè‰²å’Œåº•åº§æ¶‚å±‚å¯é€‰ã€‚</span><br><span class="hljs-string">    å¯é€‰å¡‘æ–™å‰åé èƒŒè£…é¥°ï¼ˆSWC-100ï¼‰æˆ–10ç§é¢æ–™å’Œ6ç§çš®é©çš„å…¨é¢è£…é¥°ï¼ˆSWC-110ï¼‰ã€‚</span><br><span class="hljs-string">    åº•åº§æ¶‚å±‚é€‰é¡¹ä¸ºï¼šä¸é”ˆé’¢ã€å“‘å…‰é»‘è‰²ã€å…‰æ³½ç™½è‰²æˆ–é“¬ã€‚</span><br><span class="hljs-string">    æ¤…å­å¯å¸¦æˆ–ä¸å¸¦æ‰¶æ‰‹ã€‚</span><br><span class="hljs-string">    é€‚ç”¨äºå®¶åº­æˆ–å•†ä¸šåœºæ‰€ã€‚</span><br><span class="hljs-string">    ç¬¦åˆåˆåŒä½¿ç”¨èµ„æ ¼ã€‚</span><br><span class="hljs-string"></span><br><span class="hljs-string">ç»“æ„</span><br><span class="hljs-string"></span><br><span class="hljs-string">    äº”ä¸ªè½®å­çš„å¡‘æ–™æ¶‚å±‚é“åº•åº§ã€‚</span><br><span class="hljs-string">    æ°”åŠ¨æ¤…å­è°ƒèŠ‚ï¼Œæ–¹ä¾¿å‡é™ã€‚</span><br><span class="hljs-string"></span><br><span class="hljs-string">å°ºå¯¸</span><br><span class="hljs-string"></span><br><span class="hljs-string">    å®½åº¦53å˜ç±³|20.87è‹±å¯¸</span><br><span class="hljs-string">    æ·±åº¦51å˜ç±³|20.08è‹±å¯¸</span><br><span class="hljs-string">    é«˜åº¦80å˜ç±³|31.50è‹±å¯¸</span><br><span class="hljs-string">    åº§æ¤…é«˜åº¦44å˜ç±³|17.32è‹±å¯¸</span><br><span class="hljs-string">    åº§æ¤…æ·±åº¦41å˜ç±³|16.14è‹±å¯¸</span><br><span class="hljs-string"></span><br><span class="hljs-string">é€‰é¡¹</span><br><span class="hljs-string"></span><br><span class="hljs-string">    è½¯åœ°æ¿æˆ–ç¡¬åœ°æ¿æ»šè½®é€‰é¡¹ã€‚</span><br><span class="hljs-string">    ä¸¤ç§åº§æ¤…æ³¡æ²«å¯†åº¦å¯é€‰ï¼šä¸­ç­‰ï¼ˆ1.8ç£…/ç«‹æ–¹è‹±å°ºï¼‰æˆ–é«˜ï¼ˆ2.8ç£…/ç«‹æ–¹è‹±å°ºï¼‰ã€‚</span><br><span class="hljs-string">    æ— æ‰¶æ‰‹æˆ–8ä¸ªä½ç½®PUæ‰¶æ‰‹ã€‚</span><br><span class="hljs-string"></span><br><span class="hljs-string">ææ–™</span><br><span class="hljs-string">å¤–å£³åº•åº§æ»‘åŠ¨ä»¶</span><br><span class="hljs-string"></span><br><span class="hljs-string">    æ”¹æ€§å°¼é¾™PA6/PA66æ¶‚å±‚çš„é“¸é“ã€‚</span><br><span class="hljs-string">    å¤–å£³åšåº¦ï¼š10æ¯«ç±³ã€‚</span><br><span class="hljs-string">    åº§æ¤…</span><br><span class="hljs-string">    HD36æ³¡æ²«</span><br><span class="hljs-string"></span><br><span class="hljs-string">åŸäº§å›½</span><br><span class="hljs-string"></span><br><span class="hljs-string">    æ„å¤§åˆ©</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-keyword">from</span> tool <span class="hljs-keyword">import</span> get_completion<br><br><span class="hljs-comment"># Prompt ï¼šåŸºäºè¯´æ˜ä¹¦åˆ›å»ºè¥é”€æè¿°</span><br>prompt = <span class="hljs-string">f&quot;&quot;&quot;</span><br><span class="hljs-string">æ‚¨çš„ä»»åŠ¡æ˜¯å¸®åŠ©è¥é”€å›¢é˜ŸåŸºäºæŠ€æœ¯è¯´æ˜ä¹¦åˆ›å»ºä¸€ä¸ªäº§å“çš„è¥é”€æè¿°ã€‚</span><br><span class="hljs-string"></span><br><span class="hljs-string">æ ¹æ®```æ ‡è®°çš„æŠ€æœ¯è¯´æ˜ä¹¦ä¸­æä¾›çš„ä¿¡æ¯ï¼Œç¼–å†™ä¸€ä¸ªäº§å“æè¿°ã€‚</span><br><span class="hljs-string">å¯é€‰!: æœ€å¤šä½¿ç”¨50ä¸ªè¯</span><br><span class="hljs-string">å¯é€‰: å¤„ç†æŠ“é”™æ–‡æœ¬ç»†èŠ‚:æ ¹æ®ä¸åŒç›®æ ‡å—ä¼—å…³æ³¨ä¸åŒçš„æ–¹é¢ï¼Œè¾“å‡ºé£æ ¼å’Œå†…å®¹ä¸Šéƒ½é€‚åˆçš„æ–‡æœ¬ã€‚</span><br><span class="hljs-string"></span><br><span class="hljs-string"></span><br><span class="hljs-string">æŠ€æœ¯è¯´æ˜: ```<span class="hljs-subst">&#123;fact_sheet_chair&#125;</span>```</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br>response = get_completion(prompt)<br><span class="hljs-built_in">print</span>(response)<br><br></code></pre></td></tr></table></figure><h4 id="æ–‡æœ¬æ‘˜å–-extract"><a href="#æ–‡æœ¬æ‘˜å–-extract" class="headerlink" title="æ–‡æœ¬æ‘˜å– extract"></a>æ–‡æœ¬æ‘˜å– extract</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(review))<br></code></pre></td></tr></table></figure><h3 id="inferring"><a href="#inferring" class="headerlink" title="inferring"></a>inferring</h3><h4 id="æƒ…æ„Ÿå€¾å‘"><a href="#æƒ…æ„Ÿå€¾å‘" class="headerlink" title="æƒ…æ„Ÿå€¾å‘:"></a>æƒ…æ„Ÿå€¾å‘:</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> tool <span class="hljs-keyword">import</span> get_completion<br>prompt = <span class="hljs-string">f&quot;&quot;&quot;</span><br><span class="hljs-string">ä¸‰ä¸ªåå¼•å·åˆ†å‰²çš„äº§å“è¯„è®ºçš„æƒ…æ„Ÿæ˜¯ä»€ä¹ˆ</span><br><span class="hljs-string">â€˜â€™â€˜<span class="hljs-subst">&#123;lamp_review&#125;</span></span><br><span class="hljs-string">&#x27;&#x27;&#x27;&#x27;</span><br></code></pre></td></tr></table></figure><h4 id="ä¿¡æ¯æå–"><a href="#ä¿¡æ¯æå–" class="headerlink" title="ä¿¡æ¯æå–"></a>ä¿¡æ¯æå–</h4><p>ä»æ–‡æœ¬ä¸­æŠ½å–ç‰¹å®šçš„ã€æˆ‘ä»¬å…³å¿ƒçš„ä¿¡æ¯<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python">prompt = <span class="hljs-string">f&quot;&quot;&quot;</span><br><span class="hljs-string"></span><br><span class="hljs-string">ä»è¯„è®ºæ–‡æœ¬ä¸­è¯†åˆ«ä»¥ä¸‹é¡¹ç›®ï¼š</span><br><span class="hljs-string">- è¯„è®ºè€…è´­ä¹°çš„ç‰©å“</span><br><span class="hljs-string">- åˆ¶é€ è¯¥ç‰©å“çš„å…¬å¸</span><br><span class="hljs-string">- </span><br><span class="hljs-string">è¯„è®ºæ–‡æœ¬ç”¨ä¸‰ä¸ªåå¼•å·åˆ†éš”ã€‚å°†ä½ çš„å“åº”æ ¼å¼åŒ–ä¸ºä»¥ â€œç‰©å“â€ å’Œ â€œå“ç‰Œâ€ ä¸ºé”®çš„ JSON å¯¹è±¡ã€‚</span><br><span class="hljs-string">å¦‚æœä¿¡æ¯ä¸å­˜åœ¨ï¼Œè¯·ä½¿ç”¨ â€œæœªçŸ¥â€ ä½œä¸ºå€¼ã€‚</span><br><span class="hljs-string">è®©ä½ çš„å›åº”å°½å¯èƒ½ç®€çŸ­ã€‚</span><br><span class="hljs-string">â€œâ€â€œ</span><br></code></pre></td></tr></table></figure></p><h4 id="å¼•å…¥æ¸©åº¦ç³»æ•°"><a href="#å¼•å…¥æ¸©åº¦ç³»æ•°" class="headerlink" title="å¼•å…¥æ¸©åº¦ç³»æ•°"></a>å¼•å…¥æ¸©åº¦ç³»æ•°</h4><p>æ¸©åº¦æ§åˆ¶ç”Ÿæˆæ–‡æœ¬çš„éšæœºæ€§ä»¥åŠå¤šæ ·æ€§,éšæœºç¨‹åº¦é«˜,å¤šæ ·æ€§è¶Šé«˜,æ€»ä½“æ¥è¯´ï¼Œtemperature è¶Šé«˜ï¼Œè¯­è¨€æ¨¡å‹çš„æ–‡æœ¬ç”Ÿæˆå°±è¶Šå…·æœ‰éšæœºæ€§ã€‚å¯ä»¥æƒ³è±¡ï¼Œé«˜æ¸©åº¦ä¸‹ï¼Œè¯­è¨€æ¨¡å‹å°±åƒå¿ƒç»ªæ›´åŠ æ´»è·ƒï¼Œä½†ä¹Ÿå¯èƒ½æ›´æœ‰åˆ›é€ åŠ›ã€‚</p><h2 id="è¯­è¨€æ¨¡å‹ï¼Œæé—®èŒƒå¼ä¸-Token"><a href="#è¯­è¨€æ¨¡å‹ï¼Œæé—®èŒƒå¼ä¸-Token" class="headerlink" title="è¯­è¨€æ¨¡å‹ï¼Œæé—®èŒƒå¼ä¸ Token"></a>è¯­è¨€æ¨¡å‹ï¼Œæé—®èŒƒå¼ä¸ Token</h2><h3 id="Helper-function-è¾…åŠ©å‡½æ•°-æé—®èŒƒå¼"><a href="#Helper-function-è¾…åŠ©å‡½æ•°-æé—®èŒƒå¼" class="headerlink" title="Helper function è¾…åŠ©å‡½æ•° (æé—®èŒƒå¼)"></a>Helper function è¾…åŠ©å‡½æ•° (æé—®èŒƒå¼)</h3><h4 id="åˆ†ç±»"><a href="#åˆ†ç±»" class="headerlink" title="åˆ†ç±»"></a>åˆ†ç±»</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python">delimiter = <span class="hljs-string">&quot;####&quot;</span><br>messages =  [  <br>&#123;<span class="hljs-string">&#x27;role&#x27;</span>:<span class="hljs-string">&#x27;system&#x27;</span>, <br> <span class="hljs-string">&#x27;content&#x27;</span>: system_message&#125;,    <br>&#123;<span class="hljs-string">&#x27;role&#x27;</span>:<span class="hljs-string">&#x27;user&#x27;</span>, <br> <span class="hljs-string">&#x27;content&#x27;</span>: <span class="hljs-string">f&quot;<span class="hljs-subst">&#123;delimiter&#125;</span><span class="hljs-subst">&#123;user_message&#125;</span><span class="hljs-subst">&#123;delimiter&#125;</span>&quot;</span>&#125;,  <br>]<br>messages = []<br></code></pre></td></tr></table></figure><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ç³»ç»Ÿæ¶ˆæ¯ï¼ˆsystem_messageï¼‰ä½œä¸ºæ•´ä¸ªç³»ç»Ÿçš„å…¨å±€æŒ‡å¯¼ï¼Œå¹¶é€‰æ‹©ä½¿ç”¨ â€œ#â€ ä½œä¸ºåˆ†éš”ç¬¦ã€‚åˆ†éš”ç¬¦æ˜¯ç”¨æ¥åŒºåˆ†æŒ‡ä»¤æˆ–è¾“å‡ºä¸­ä¸åŒéƒ¨åˆ†çš„å·¥å…·ï¼Œå®ƒå¯ä»¥å¸®åŠ©æ¨¡å‹æ›´å¥½åœ°è¯†åˆ«å„ä¸ªéƒ¨åˆ†ï¼Œä»è€Œæé«˜ç³»ç»Ÿåœ¨æ‰§è¡Œç‰¹å®šä»»åŠ¡æ—¶çš„å‡†ç¡®æ€§å’Œæ•ˆç‡ã€‚ â€œ#â€ ä¹Ÿæ˜¯ä¸€ä¸ªç†æƒ³çš„åˆ†éš”ç¬¦ï¼Œå› ä¸ºå®ƒå¯ä»¥è¢«è§†ä¸ºä¸€ä¸ªå•ç‹¬çš„ token ã€‚</p><h4 id="å†…å¿ƒç‹¬ç™½"><a href="#å†…å¿ƒç‹¬ç™½" class="headerlink" title="å†…å¿ƒç‹¬ç™½"></a>å†…å¿ƒç‹¬ç™½</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">try</span>:<br>    <span class="hljs-keyword">if</span> delimiter <span class="hljs-keyword">in</span> response:<br>        final_response = response.split(delimiter)[-<span class="hljs-number">1</span>].strip()<br>    <span class="hljs-keyword">else</span>:<br>        final_response = response.split(<span class="hljs-string">&quot;:&quot;</span>)[-<span class="hljs-number">1</span>].strip()<br><span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>    final_response = <span class="hljs-string">&quot;å¯¹ä¸èµ·ï¼Œæˆ‘ç°åœ¨æœ‰ç‚¹é—®é¢˜ï¼Œè¯·å°è¯•é—®å¦å¤–ä¸€ä¸ªé—®é¢˜&quot;</span><br>    <br><span class="hljs-built_in">print</span>(final_response)<br></code></pre></td></tr></table></figure><h3 id="langchain"><a href="#langchain" class="headerlink" title="langchain"></a>langchain</h3><p>```python<br>from langchain.prompts import ChatPromptTemplate<br>template_string = â€œâ€â€â€</p>]]></content>
    
    
    
    <tags>
      
      <tag>LLM</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>data-clean</title>
    <link href="/2023/09/16/data-clean/"/>
    <url>/2023/09/16/data-clean/</url>
    
    <content type="html"><![CDATA[<h2 id="Tools"><a href="#Tools" class="headerlink" title="Tools"></a>Tools</h2><h3 id="pandas"><a href="#pandas" class="headerlink" title="pandas"></a>pandas</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs python">df.loc[df.AAA &gt;= <span class="hljs-number">5</span>, <span class="hljs-string">&quot;BBB&quot;</span>] = -<span class="hljs-number">1</span><span class="hljs-comment">#æ•°æ®æ›¿æ¢</span><br>df.loc[(df[<span class="hljs-string">&quot;BBB&quot;</span>] &lt; <span class="hljs-number">25</span>) &amp; (df[<span class="hljs-string">&quot;CCC&quot;</span>] &gt;= -<span class="hljs-number">40</span>), <span class="hljs-string">&quot;AAA&quot;</span>]<span class="hljs-comment">#è¿™ä¸ªæ“ä½œæ˜¯ç›´æ¥å±•ç°æ•°æ®</span><br>df.loc[df.AAA &gt;= <span class="hljs-number">5</span>, [<span class="hljs-string">&quot;BBB&quot;</span>, <span class="hljs-string">&quot;CCC&quot;</span>]] = <span class="hljs-number">555</span><span class="hljs-comment">#å¤šæ•°æ®æ›¿æ¢</span><br>df.where(df_mask, -<span class="hljs-number">1000</span>)<span class="hljs-comment">#mask ç”¨falseæ›¿æ¢æ‰</span><br>df[<span class="hljs-string">&quot;logic&quot;</span>] = np.where(df[<span class="hljs-string">&quot;AAA&quot;</span>] &gt; <span class="hljs-number">5</span>, <span class="hljs-string">&quot;high&quot;</span>, <span class="hljs-string">&quot;low&quot;</span>)<br><br><br><br><span class="hljs-comment">#æ•°æ®è£å‰ª å¯ä»¥ç›´æ¥åœ¨å˜é‡çš„åˆ—è¡¨æ¡†ä¸­ç›´æ¥è¿›è¡Œåˆ›å»º</span><br>df[(df.AAA &lt;= <span class="hljs-number">6</span>) &amp; (df.index.isin([<span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">4</span>]))]<span class="hljs-comment">#.indexè¡¨ç¤ºè¡Œçš„å¤„ç†æ–¹å¼.å¯ä»¥æŒ‡å®šå¯¹åº”çš„æ ‡ç­¾</span><br>df2.iloc[<span class="hljs-number">1</span>:<span class="hljs-number">3</span>]  <span class="hljs-comment"># Position-oriented</span><br>df2.loc[<span class="hljs-number">1</span>:<span class="hljs-number">3</span>]  <span class="hljs-comment"># Label-oriented</span><br><br><span class="hljs-comment"># ç”¨æ˜ å°„å¤„ç†æ–°çš„åˆ— Efficiently and dynamically creating new columns using DataFrame.map (previously named applymap)</span><br>source_cols = df.columns  <span class="hljs-comment"># åˆ›å»ºå‡ºç¬¬ä¸€åˆ—çš„åˆ—å,åŒæ—¶è¿™é‡Œæ˜¯ä¸€ä¸ªåˆ—è¡¨</span><br>new_cols = [<span class="hljs-built_in">str</span>(x) + <span class="hljs-string">&quot;_cat&quot;</span> <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> source_cols]<span class="hljs-comment">#æŒ‰ç…§stråˆ—ååˆ›å»º</span><br>categories = &#123;<span class="hljs-number">1</span>: <span class="hljs-string">&quot;Alpha&quot;</span>, <span class="hljs-number">2</span>: <span class="hljs-string">&quot;Beta&quot;</span>, <span class="hljs-number">3</span>: <span class="hljs-string">&quot;Charlie&quot;</span>&#125;<span class="hljs-comment">#å­—å…¸</span><br>df[new_cols] = df[source_cols].<span class="hljs-built_in">map</span>(categories.get)<span class="hljs-comment">#æ˜ å°„çš„æ–¹å¼</span><br><br><span class="hljs-comment">#æœ‰ä¸€ä¸ªé‡è¦çš„å‡½æ•°applyå¯ä»¥æŠŠæ‰€æœ‰çš„å‡½æ•°è¿ç”¨åœ¨ç‰¹å®šçš„ä½ç½®ä¸Š</span><br><br><span class="hljs-comment">#merge </span><br>pd.merge(left,right,how=<span class="hljs-string">&quot;left&quot;</span>,on=[])<span class="hljs-comment">#å‘å·¦è¾¹çš„é”®ä½è¿›è¡Œè¿æ¥,åŒæ—¶onè¡¨ç¤ºé€šè¿‡ä»€ä¹ˆé”®æ¥è¿æ¥</span><br><br><span class="hljs-comment"># Arithmetic .. Performing arithmetic with a MultiIndex that needs broadcasting</span><br>cols = pd.MultiIndex.from_tuples(<br>    [(x, y) <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> [<span class="hljs-string">&quot;A&quot;</span>, <span class="hljs-string">&quot;B&quot;</span>, <span class="hljs-string">&quot;C&quot;</span>] <span class="hljs-keyword">for</span> y <span class="hljs-keyword">in</span> [<span class="hljs-string">&quot;O&quot;</span>, <span class="hljs-string">&quot;I&quot;</span>]]<br>)<br><span class="hljs-comment">#ä¹Ÿå°±æ˜¯ä»¥ä¸Šå¯ä»¥åˆ›å»ºä¸€ä¸ªä¸¤å…ƒçš„ç»„,åŒæ—¶ä¸¤è€…å¯ä»¥åŒæ—¶å¤„ç†</span><br><br><span class="hljs-comment"># group </span><br><span class="hljs-comment">### è¿™é‡Œå¯ä»¥æŒ‰ç…§æŸä¸€ä¸ªç‰¹å®šçš„idåšä¸€æ¬¡èšç±»,å†å¯¹é‡Œé¢çš„æ•°æ®å®Œæˆæ“ä½œ</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">GrowUp</span>(<span class="hljs-params">x</span>):<br>    avg_weight = <span class="hljs-built_in">sum</span>(x[x[<span class="hljs-string">&quot;size&quot;</span>] == <span class="hljs-string">&quot;S&quot;</span>].weight * <span class="hljs-number">1.5</span>)<br>    avg_weight += <span class="hljs-built_in">sum</span>(x[x[<span class="hljs-string">&quot;size&quot;</span>] == <span class="hljs-string">&quot;M&quot;</span>].weight * <span class="hljs-number">1.25</span>)<br>    avg_weight += <span class="hljs-built_in">sum</span>(x[x[<span class="hljs-string">&quot;size&quot;</span>] == <span class="hljs-string">&quot;L&quot;</span>].weight)<br>    avg_weight /= <span class="hljs-built_in">len</span>(x)<br>    <span class="hljs-keyword">return</span> pd.Series([<span class="hljs-string">&quot;L&quot;</span>, avg_weight, <span class="hljs-literal">True</span>], index=[<span class="hljs-string">&quot;size&quot;</span>, <span class="hljs-string">&quot;weight&quot;</span>, <span class="hljs-string">&quot;adult&quot;</span>])<br><span class="hljs-comment">#weight æƒé‡å¯ä»¥é™åˆ¶å…¶ä¸ºå‡ å€çš„æ“ä½œ</span><br><br>pd.Series([i / <span class="hljs-number">100.0</span> <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, <span class="hljs-number">11</span>)])<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">cum_ret</span>(<span class="hljs-params">x, y</span>):<br>    <span class="hljs-keyword">return</span> x * (<span class="hljs-number">1</span> + y)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">red</span>(<span class="hljs-params">x</span>):<br>    <span class="hljs-keyword">return</span> functools.reduce(cum_ret, x, <span class="hljs-number">1.0</span>)<br><span class="hljs-comment"># ç´¯ç§¯è¿ç”¨å¤šæ¬¡ä»¥ä¸Šçš„æ“ä½œ</span><br><br><span class="hljs-comment">#æ³¨æ„transformå‚æ•°çš„æ˜¯ç”¨ä¸€ä¸ªåˆ—ä½œä¸ºå‚æ•° sort_values å‡½æ•°é€šè¿‡å‚é‡é‡Œé¢çš„å“ªä¸€ä¸ªå€¼æ¥è¿›è¡Œè®¡ç®—</span><br>df[<span class="hljs-string">&quot;Counts&quot;</span>] = df.groupby([<span class="hljs-string">&quot;Color&quot;</span>]).transform(<span class="hljs-built_in">len</span>)<span class="hljs-comment">#è¿™é‡Œçš„groupbyå«æœ‰ä¸¤ä¸ªå…ƒç´ ,ä½†æ˜¯lenä¼šé€šè¿‡å¹¿æ’­æœºåˆ¶åæ˜ åˆ°æ‰€æœ‰çš„coloråˆ—ä¸­</span><br><br>df[<span class="hljs-string">&quot;beyer_shifted&quot;</span>] = df.groupby(level=<span class="hljs-number">0</span>)[<span class="hljs-string">&quot;beyer&quot;</span>].shift(<span class="hljs-number">1</span>)<span class="hljs-comment">#shiftæ˜¯ä½œä¸ºå‘ä¸‹ç§»åŠ¨çš„è¿‡ç¨‹</span><br>df.groupby(level=<span class="hljs-number">0</span>)<span class="hljs-comment">#å¯¹äºç¬¬ä¸€ä¸ªåˆ—è¿›è¡Œç´¢å¼•</span><br><br><br><br><br></code></pre></td></tr></table></figure><h2 id="æ•°æ®æ¸…æ´—"><a href="#æ•°æ®æ¸…æ´—" class="headerlink" title="æ•°æ®æ¸…æ´—"></a>æ•°æ®æ¸…æ´—</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-string">&quot;\n&quot;</span>.join(<span class="hljs-built_in">list</span>) <span class="hljs-comment">#è¡¨ç¤ºç”¨listå­—ç¬¦é‡æ–°ç”Ÿæˆå­—ç¬¦ä¸²,åŒæ—¶é‡Œé¢å†…å®¹ç”¨\nåˆ‡å‰²</span><br>[::-<span class="hljs-number">1</span>]<span class="hljs-comment">#ä»åå‘å‰éå†</span><br>[<span class="hljs-number">5</span>::<span class="hljs-number">6</span>]<span class="hljs-comment">#è¡¨ç¤ºä»5èµ·,æ­¥é•¿ä¸º6å¼€å§‹éå†</span><br><br></code></pre></td></tr></table></figure><h2 id="simpy"><a href="#simpy" class="headerlink" title="simpy"></a>simpy</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> simpy<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():<br>    env = simpy.Environment()<br>    env.process(traffic_light(env))<br>    env.run(until=<span class="hljs-number">120</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;simulation done&#x27;</span>)<br>    <br><span class="hljs-comment"># traffic_lightæ˜¯ä¸€ä¸ªprocessï¼Œä¼ å…¥envæ˜¯å‘Šè¯‰traffic_lightå®ƒæ˜¯åœ¨envé‡Œæ‰§è¡Œçš„ï¼Œè€Œä¸æ˜¯å…¶å®ƒç¯å¢ƒ</span><br><span class="hljs-comment">#yield å¯ä»¥éšæ—¶çš„ä»å½“å‰çš„æ—¶é—´æ®µåœä¸‹æ¥,ç„¶åä¸‹ä¸€æ¬¡è¯»å–çš„æ—¶å€™åœ¨é‡å¤</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">traffic_light</span>(<span class="hljs-params">env</span>):<br>    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;light green at :<span class="hljs-subst">&#123;env.now&#125;</span>&#x27;</span>)<br>        <span class="hljs-keyword">yield</span> env.timeout(<span class="hljs-number">30</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;light yellow at :<span class="hljs-subst">&#123;env.now&#125;</span>&#x27;</span>)<br>        <span class="hljs-keyword">yield</span> env.timeout(<span class="hljs-number">5</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;light red at :<span class="hljs-subst">&#123;env.now&#125;</span>&#x27;</span>)<br>        <span class="hljs-keyword">yield</span> env.timeout(<span class="hljs-number">20</span>)<br>        <br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    main()<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">example</span>(<span class="hljs-params">env</span>):<br>        value = <span class="hljs-keyword">yield</span> env.timeout(env,delay=<span class="hljs-number">1</span>,value=<span class="hljs-number">42</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;now=%d,value=%d&#x27;</span>%(env.now,value))<br>env = simpy.Environment()<br>p = env.process(example(env))<br></code></pre></td></tr></table></figure><p>generateæ˜¯ä¸€ç§è¿­ä»£å™¨,ä¸€æ¬¡åªèƒ½ä½¿ç”¨ä¸€ä¸ªå€¼,åŒæ—¶è¿™ä¸ªåªèƒ½ä½¿ç”¨ä¸€æ¬¡,ä¹‹åç›¸å½“äºä¼šå¿˜è®°è¿™é‡Œçš„å€¼,ä¹Ÿå°±æ˜¯æ— æ³•ä½¿ç”¨è¿™ä¸ªè¡Œä¸º<br>yield æ˜¯ä¸€ä¸ªç”¨æ³•ä¸returnç±»ä¼¼çš„å…³é”®è¯ï¼Œåªæ˜¯è¿™ä¸ªå‡½æ•°è¿”å›ä¸€ä¸ªç”Ÿæˆå™¨<br>è°ƒç”¨åŒ…å«yieldçš„å‡½æ•°ä¼šè¿”å›ä¸€ä¸ªç”Ÿæˆå™¨ï¼Œå‡½æ•°ä¸­çš„ä»£ç å¹¶æ²¡æœ‰è¿è¡Œï¼Œè°ƒç”¨ç”Ÿæˆå™¨åï¼Œæ¯æ¬¡é‡åˆ° yield æ—¶å‡½æ•°ä¼šæš‚åœå¹¶ä¿å­˜å½“å‰æ‰€æœ‰çš„è¿è¡Œä¿¡æ¯ï¼ˆä¿ç•™å±€éƒ¨å˜é‡ï¼‰ï¼Œè¿”å› yield çš„å€¼, å¹¶åœ¨ä¸‹ä¸€æ¬¡è¿­ä»£æ—¶ä»å½“å‰ä½ç½®ç»§ç»­è¿è¡Œï¼Œç›´åˆ°ç”Ÿæˆå™¨è¢«å…¨éƒ¨éå†å®Œã€‚<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">create_generator</span>():<br>    mylist = <span class="hljs-built_in">range</span>(<span class="hljs-number">3</span>)<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> mylist:<br>    <span class="hljs-keyword">yield</span> i*i<br>mygenerator = create_generator()<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> mygenerator:<br>    <span class="hljs-built_in">print</span>(i)<br>env.run(until=<span class="hljs-number">10</span>)<span class="hljs-comment">#ä¼šä¸€ç›´è¿è¡Œ10s</span><br></code></pre></td></tr></table></figure><br>Environment.active_processï¼šè·å–å½“å‰æ‰§è¡Œçš„è¿›ç¨‹ï¼Œåªæœ‰åœ¨è¿›ç¨‹å‡½æ•°é‡Œèƒ½è·å–åˆ°è¯¥ä¿¡æ¯<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> simpy<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">subfunc</span>(<span class="hljs-params">env</span>):<br>    <span class="hljs-built_in">print</span>(env.active_process)<span class="hljs-comment">#processåˆ›å»ºè¿›ç¨‹,runæ‰§è¡Œ</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">proc</span>(<span class="hljs-params">env</span>):<br>    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>        <span class="hljs-built_in">print</span>(env.active_process)<br>        subfunc(env)<br>        <span class="hljs-keyword">yield</span> env.timeout(<span class="hljs-number">1</span>)<span class="hljs-comment">#è¿›ç¨‹åº”è¯¥é‡‡ç”¨çš„é˜»å¡å™¨çš„æ–¹å¼åšå‡ºç”Ÿæˆå™¨çš„æ–¹å¼</span><br>env = simpy.Environment()<br>p1 = env.process(proc(env))  <br></code></pre></td></tr></table></figure></p><h4 id="event-basic"><a href="#event-basic" class="headerlink" title="event basic"></a>event basic</h4><p>3ç§çŠ¶æ€:</p><pre><code class="hljs">1. å°†è¦å‘ç”Ÿtriggered = True æ”¾å…¥äº‹ä»¶é˜Ÿåˆ—ä¸­2. å¯èƒ½å‘ç”Ÿtriggered = False 3. å·²ç»å‘ç”Ÿprocessed = True å¤„ç†,å°±ä¼šå¼¹å‡º</code></pre><p>Event.callbacksï¼šå›è°ƒåˆ—è¡¨ï¼Œåªè¦eventæ²¡æœ‰è¢«å¤„ç†ï¼Œå°±å¯ä»¥æ·»åŠ å›è°ƒã€‚å›è°ƒå°±æ˜¯eventä»¥å‚æ•°çš„å½¢å¼å­˜å‚¨åœ¨Event.callbacksåˆ—è¡¨ä¸­<br>è§¦å‘å,å¯èƒ½æˆåŠŸä¹Ÿå¯èƒ½å¤±è´¥<br>Event.succeed(value=None)ï¼šè§¦å‘ä¸€ä»¶eventå¹¶å°†å…¶æ ‡è®°ä¸ºæˆåŠŸ<br>Event.fail(exception)ï¼šè§¦å‘eventå¤±è´¥ï¼Œå¹¶é—¯å…¥åŸå› <br>Event.trigger(event)ï¼šè§¦å‘eventé€šç”¨æ–¹æ³•ï¼Œè¿”å›æˆåŠŸæˆ–è€…å¤±è´¥çš„å€¼</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> simpy<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">school</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, env</span>):<br>        self.env = env<br>        self.class_end = env.event()<br>        <span class="hljs-comment"># åˆ›å»ºä¸‰ä¸ªpupilè¿›ç¨‹å’Œä¸€ä¸ªbellè¿›ç¨‹</span><br>        self.pupil_procs = [env.process(self.pupil()) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">3</span>)]<br>        self.bell_procs = env.process(self.bell())<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">bell</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">2</span>): <span class="hljs-comment"># ï¼ˆ1ï¼‰bellå¾ªç¯</span><br>            <span class="hljs-keyword">yield</span> self.env.timeout(<span class="hljs-number">45</span>)  <span class="hljs-comment"># ï¼ˆ2ï¼‰ç­‰å¾…45</span><br>            self.class_end.succeed()  <span class="hljs-comment"># ï¼ˆ3ï¼‰è§¦å‘class_endæ ‡è®°æˆåŠŸ</span><br>            self.class_end = self.env.event()  <span class="hljs-comment"># ï¼ˆ4ï¼‰ç”Ÿæˆæ–°çš„class_endäº‹ä»¶</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">pupil</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">2</span>):  <span class="hljs-comment"># ï¼ˆ5ï¼‰pupilå¾ªç¯</span><br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">r&#x27;\0/&#x27;</span>,end=<span class="hljs-string">&#x27; &#x27;</span>)  <span class="hljs-comment"># ï¼ˆ6ï¼‰è¾“å‡º\0/</span><br>            <span class="hljs-keyword">yield</span> self.class_end  <span class="hljs-comment">#ï¼ˆ7ï¼‰ä¸­æ–­å¤„ç†class_endäº‹ä»¶</span><br>school = School(env)<br>env = simpy.Environment()<br>env.run()        <br><br><span class="hljs-comment"># charge &amp; run</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Car</span>(<span class="hljs-title class_ inherited__">object</span>):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, env</span>):<br>        self.env = env<br>        <span class="hljs-comment"># Start the run process everytime an instance is created.</span><br>        self.action = env.process(self.run())<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">run</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Start parking and charging at %d&#x27;</span> % self.env.now)<br>            charge_duration = <span class="hljs-number">5</span><br>            <span class="hljs-comment"># We yield the process that process() returns</span><br>            <span class="hljs-comment"># to wait for it to finish</span><br>            <span class="hljs-keyword">yield</span> self.env.process(self.charge(charge_duration))<br><br>            <span class="hljs-comment"># The charge process has finished and</span><br>            <span class="hljs-comment"># we can start driving again.</span><br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Start driving at %d&#x27;</span> % self.env.now)<br>            trip_duration = <span class="hljs-number">2</span><br>            <span class="hljs-keyword">yield</span> self.env.timeout(trip_duration)<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">driver</span>(<span class="hljs-params">env, car</span>):<br>        <span class="hljs-keyword">yield</span> env.timeout(<span class="hljs-number">3</span>)<br>        car.action.interrupt()<span class="hljs-comment">#è¿›ç¨‹çš„ä¸­æ–­</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">charge</span>(<span class="hljs-params">self, duration</span>):<br>        <span class="hljs-keyword">yield</span> self.env.timeout(duration) <span class="hljs-comment">#yield æœ¬èº«ä¹Ÿæ˜¯ä½œä¸ºè¿”å›ä¸€ç§è¿­ä»£å™¨çš„æ–¹å¼è¿”å›</span><br>        <span class="hljs-comment">#éœ€è¦n </span><br>    <span class="hljs-keyword">import</span> simpy<br>    env = simpy.Environment()<br>    car = Car(env)<br>    env.run(until=<span class="hljs-number">15</span>)<br><br><span class="hljs-comment">### !!!! æ³¨æ„è¿›ç¨‹çš„åˆ›å»ºæœ¬èº«ä¹Ÿæ˜¯åœ¨åŠ å…¥ä¸€ä¸ªå‡½æ•°é‡Œé¢å«æœ‰yieldå‡½æ•°å³å¯ </span><br><span class="hljs-comment">#### é‡‡ç”¨interuptå‡½æ•°ä¸­æ–­</span><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Car</span>(<span class="hljs-title class_ inherited__">object</span>):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, env</span>):<br>        self.env = env<br>        self.action = env.process(self.run())<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">run</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Start parking and charging at %d&#x27;</span> % self.env.now)<br>            charge_duration = <span class="hljs-number">5</span><br>            <span class="hljs-comment"># We may get interrupted while charging the battery</span><br>            <span class="hljs-keyword">try</span>:<br>                <span class="hljs-keyword">yield</span> self.env.process(self.charge(charge_duration))<br>            <span class="hljs-keyword">except</span> simpy.Interrupt:<br>                <span class="hljs-comment"># When we received an interrupt, we stop charging and</span><br>                <span class="hljs-comment"># switch to the &quot;driving&quot; state</span><br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Was interrupted. Hope, the battery is full enough ...&#x27;</span>)<br><br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Start driving at %d&#x27;</span> % self.env.now)<br>            trip_duration = <span class="hljs-number">2</span><br>            <span class="hljs-keyword">yield</span> self.env.timeout(trip_duration)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">charge</span>(<span class="hljs-params">self, duration</span>):<br>        <span class="hljs-keyword">yield</span> self.env.timeout(duration)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">example</span>(<span class="hljs-params">env</span>):<br>    event = simpy.events.Timeout(env, delay=<span class="hljs-number">1</span>, value=<span class="hljs-number">42</span>)<br>    value = <span class="hljs-keyword">yield</span> event<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;now=%d, value=%d&#x27;</span> % (env.now, value))<br>env = simpy.Environment()<br>example_gen = example(env)<br>p = simpy.events.Process(env, example_gen)<br>env.run()<span class="hljs-comment"># å¯ä»¥é€šè¿‡valueå‡½æ•°,åœ¨yield åè¿”å›ä¸€ä¸ªå¯¹åº”çš„valueçš„å€¼</span><br><br><span class="hljs-comment"># runåŒæ—¶å¯ä»¥ä¼ é€’ä¸€ä¸ªprocessè¿›å»æ­¤æ—¶runä¼šè¿”å›ç›¸å…³çš„å‡½æ•°çš„returnå€¼</span><br><br></code></pre></td></tr></table></figure><p>peek() returns the time of the next scheduled event or infinity (float(â€˜infâ€™)) if no future events are scheduled.</p><p>step() processes the next scheduled event. It raises an EmptySchedule exception if no event is available.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><code class="hljs python">until = <span class="hljs-number">10</span><br><span class="hljs-keyword">while</span> env.peek() &lt; until:<br>   env.step()<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">subfunc</span>(<span class="hljs-params">env</span>):<br>    <span class="hljs-built_in">print</span>(env.active_process)  <span class="hljs-comment"># will print &quot;p1&quot; æŒ‡å‘å½“å‰æ‰§è¡Œè¿›ç¨‹çš„pid</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">my_proc</span>(<span class="hljs-params">env</span>):<br>    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>        <span class="hljs-built_in">print</span>(env.active_process)  <span class="hljs-comment"># will print &quot;p1&quot;</span><br>        subfunc(env)<br>        <span class="hljs-keyword">yield</span> env.timeout(<span class="hljs-number">1</span>)<br><br>env = simpy.Environment()<br>p1 = env.process(my_proc(env))<br>env.active_process  <span class="hljs-comment"># None</span><br>env.step()<br><br><span class="hljs-comment"># callback list</span><br><span class="hljs-keyword">import</span> simpy<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">my_callback</span>(<span class="hljs-params">event</span>):<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Called back from&#x27;</span>, event)<br><br>env = simpy.Environment()<br>event = env.event()<span class="hljs-comment">#ç›¸å½“äºåˆ›å»ºä¸€ä¸ªæ—¶é—´å¯¹è±¡,ä¹‹åå¼€å§‹ä¿®æ”¹å¹¶è¿ç”¨</span><br>event.callbacks.append(my_callback)<br>event.callbacks<br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">School</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, env</span>):<br>        self.env = env<br>        self.class_ends = env.event()<span class="hljs-comment">#è¿™é‡Œåˆå§‹åŒ–äº†ä¸€ä¸ªå¯¹è±¡,é‡å¤è°ƒç”¨åªèƒ½å»è°ƒç”¨è¿™ä¸ªå¯¹è±¡ä¸­å·²ç»ä½¿ç”¨çš„éƒ¨åˆ†,è€Œä¸èƒ½é‡å¤è°ƒç”¨è¿™ä¸ªåˆ›å»ºå‡½æ•°</span><br>        <span class="hljs-comment"># initå‡½æ•°</span><br>        self.pupil_procs = [env.process(self.pupil()) <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">3</span>)]<br>        self.bell_proc = env.process(self.bell())<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">bell</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">2</span>):<br>            <span class="hljs-keyword">yield</span> self.env.timeout(<span class="hljs-number">45</span>)<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;hi&quot;</span>)<br>            self.class_ends.succeed()<br>            self.class_ends = self.env.event()<br>            <span class="hljs-built_in">print</span>(env.now)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">pupil</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">2</span>):<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">r&#x27; \o/ &#x27;</span>, end=<span class="hljs-string">&#x27;&#x27;</span> )<br>            <span class="hljs-keyword">yield</span> self.class_ends <span class="hljs-comment">#yield åˆ›å»ºäº†,ç„¶åç›´æ¥åˆ‡æ–­,è¿›è¡Œä¸‹ä¸€ä¸ªæ—¶é—´,</span><br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;hello&quot;</span>)<br>env = simpy.Environment()<br>school = School(env)<br>env.run()<br><br><span class="hljs-comment">#process as event</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">sub</span>(<span class="hljs-params">env</span>):<br>    <span class="hljs-keyword">yield</span> env.timeout(<span class="hljs-number">1</span>)<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">23</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">parent</span>(<span class="hljs-params">env</span>):<br>    ret = <span class="hljs-keyword">yield</span> env.process(sub(env))<span class="hljs-comment">#ç›¸å½“äºç­‰å¾…å­è¿›ç¨‹å®Œæˆä¹‹ååœ¨</span><br>    <span class="hljs-keyword">return</span> ret<br><br><br><span class="hljs-comment"># Waiting for multiple events at once</span><br><span class="hljs-keyword">from</span> simpy.events <span class="hljs-keyword">import</span> AnyOf, AllOf, Event<br>events = [Event(env) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">3</span>)]<br>a = AnyOf(env, events)  <span class="hljs-comment"># Triggers if at least one of &quot;events&quot; is triggered.</span><br>b = AllOf(env, events)  <span class="hljs-comment"># Triggers if all each of &quot;events&quot; is triggered.</span><br><br><span class="hljs-comment">#  åˆ›å»ºä»¥ä¸Šçš„æ–¹å¼ ,eventsä½œä¸ºå¯¹è±¡åˆ—æ¥ç­‰å¾…æ“ä½œ</span><br></code></pre></td></tr></table></figure><p>é™åˆ¶äº†å‡½æ•°çš„æ‰§è¡Œ</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>recommandation</title>
    <link href="/2023/09/06/recommandation/"/>
    <url>/2023/09/06/recommandation/</url>
    
    <content type="html"><![CDATA[<h1 id="recommendaion-system"><a href="#recommendaion-system" class="headerlink" title="recommendaion system"></a>recommendaion system</h1><h2 id="merics"><a href="#merics" class="headerlink" title="merics"></a>merics</h2><h3 id="ndcg"><a href="#ndcg" class="headerlink" title="ndcg"></a>ndcg</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np<br>np.random.seed(<span class="hljs-number">2021</span>)<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Model</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, k</span>):<br>        self.k = k<br>        self.item_size = <span class="hljs-number">50</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__call__</span>(<span class="hljs-params">self, users</span>):<br>        <span class="hljs-comment"># æ¨¡å‹éšæœºè¿”å› k ä¸ª item,æ¨¡æ‹Ÿæ¨èç»“æœ</span><br>        res = np.random.randint(<span class="hljs-number">0</span>, self.item_size, users.shape[<span class="hljs-number">0</span>] * self.k)<span class="hljs-comment">#éšæœºç”Ÿæˆæ•°ç»„çš„æ•´æ•°,ç”Ÿæˆçš„å¤§å°ä½äºå‰ä¸¤ä¸ªå‚æ•°ä¹‹é—´,ç”Ÿæˆçš„é•¿åº¦æ˜¯ç¬¬ä¸‰ä¸ªå‚æ•°</span><br>        <span class="hljs-keyword">return</span> res.reshape((users.shape[<span class="hljs-number">0</span>], -<span class="hljs-number">1</span>)) <span class="hljs-comment">#reshapeæ˜¯è½¬æ¢ä¸ºäºŒä½æ•°ç»„ è¡Œæ•°ç”¨å‰ä¸€ä¸ªå‚æ•°ç¡®å®š,-1æŒ‡çš„æ˜¯åˆ—æ•°è‡ªåŠ¨ç¡®å®š</span><br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_implict_matrix</span>(<span class="hljs-params">rec_items, test_set</span>):<br>    rel_matrix = [[<span class="hljs-number">0</span>] * rec_items.shape[<span class="hljs-number">1</span>] <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(rec_items.shape[<span class="hljs-number">0</span>])]<span class="hljs-comment">#shape[1]å®šä¹‰äº†åˆ—æ•°,åŒæ—¶[0]*æŠŠæ‰€æœ‰çš„å…ƒç´ èµ‹å€¼ä¸ºé›¶</span><br>    <span class="hljs-keyword">for</span> user <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(test_set)):<br>        <span class="hljs-keyword">for</span> index, item <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(rec_items[user]):<br>            <span class="hljs-keyword">if</span> item <span class="hljs-keyword">in</span> test_set[user]:<br>                rel_matrix[user][index] = <span class="hljs-number">1</span><br>    <span class="hljs-keyword">return</span> np.array(rel_matrix)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">DCG</span>(<span class="hljs-params">items</span>):<br>    <span class="hljs-keyword">return</span> np.<span class="hljs-built_in">sum</span>(items / np.log(np.arange(<span class="hljs-number">2</span>, <span class="hljs-built_in">len</span>(items) + <span class="hljs-number">2</span>))) <span class="hljs-comment"># np.sumä¼ å…¥æ•°ç»„å¯ä»¥å®ç°å¯¹äºæ•°ç»„ä¸­ä¸¤ä¸ªæ•°ä»¥æ­¤ åŒæ—¶éœ€è¦é‡‡ç”¨çš„np.arrayçš„æ•°æ®ç±»å‹</span><br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">nDCG</span>(<span class="hljs-params">rec_items, test_set</span>):<br>    <span class="hljs-keyword">assert</span> rec_items.shape[<span class="hljs-number">0</span>] == <span class="hljs-built_in">len</span>(test_set)<br>    <span class="hljs-comment"># è·å¾—éšå¼åé¦ˆçš„relåˆ†æ•°çŸ©é˜µ</span><br>    rel_matrix = get_implict_matrix(rec_items, test_set)<br>    ndcgs = []<br>    <span class="hljs-keyword">for</span> user <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(test_set)):<br>        rels = rel_matrix[user]<br>        dcg = DCG(rels)<br>        idcg = DCG(<span class="hljs-built_in">sorted</span>(rels, reverse=<span class="hljs-literal">True</span>))<span class="hljs-comment">#ä½œä¸ºæœ€ç†æƒ³çš„å®šä¹‰æ–¹æ³•,ä»¥æ­¤å®šä¹‰æ’åºæ–¹æ³•çš„å¥½å</span><br>        ndcg = dcg / idcg <span class="hljs-keyword">if</span> idcg != <span class="hljs-number">0</span> <span class="hljs-keyword">else</span> <span class="hljs-number">0</span><br>        ndcgs.append(ndcg)<br>    <span class="hljs-keyword">return</span> ndcgs<br><br><br><span class="hljs-comment"># å‡è®¾ top-20 æ¨è,ä¸€å…± 5 ä¸ª user, 50 ä¸ª item ,éšå¼åé¦ˆæ•°æ®é›†.</span><br>users = np.array([<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>])<br><span class="hljs-comment"># test_set è¡¨ç¤º 5 ä¸ªç”¨æˆ·åœ¨æµ‹è¯•é›†ä¸­åˆ†è¡¨äº¤äº’è¿‡é‚£äº› item</span><br>test_set = [<br>    [<span class="hljs-number">0</span>, <span class="hljs-number">21</span>, <span class="hljs-number">31</span>, <span class="hljs-number">41</span>, <span class="hljs-number">49</span>],<br>    [<span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">33</span>],<br>    [<span class="hljs-number">5</span>, <span class="hljs-number">10</span>, <span class="hljs-number">20</span>, <span class="hljs-number">30</span>, <span class="hljs-number">39</span>, <span class="hljs-number">44</span>, <span class="hljs-number">45</span>, <span class="hljs-number">49</span>],<br>    [<span class="hljs-number">4</span>, <span class="hljs-number">7</span>, <span class="hljs-number">13</span>, <span class="hljs-number">15</span>],<br>    [<span class="hljs-number">2</span>]<br>]<br><br>model = Model(<span class="hljs-number">20</span>)<br>rec_items = model(users)<br>ndcgs = nDCG(rec_items, test_set)<br><span class="hljs-built_in">print</span>(ndcgs)<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>leetcode</title>
    <link href="/2023/08/26/leetcode/"/>
    <url>/2023/08/26/leetcode/</url>
    
    <content type="html"><![CDATA[<h1 id="ç®—æ³•ä»£ç é˜…è¯»"><a href="#ç®—æ³•ä»£ç é˜…è¯»" class="headerlink" title="ç®—æ³•ä»£ç é˜…è¯»"></a>ç®—æ³•ä»£ç é˜…è¯»</h1><h2 id="sort"><a href="#sort" class="headerlink" title="sort"></a>sort</h2><h4 id="ä¸¤æ•°ä¹‹å’Œ-1"><a href="#ä¸¤æ•°ä¹‹å’Œ-1" class="headerlink" title="ä¸¤æ•°ä¹‹å’Œ -1"></a>ä¸¤æ•°ä¹‹å’Œ -1</h4><p>ç»™å®šä¸€ä¸ªæ•´æ•°æ•°ç»„ nums å’Œä¸€ä¸ªæ•´æ•°ç›®æ ‡å€¼ targetï¼Œè¯·ä½ åœ¨è¯¥æ•°ç»„ä¸­æ‰¾å‡º å’Œä¸ºç›®æ ‡å€¼ target  çš„é‚£ ä¸¤ä¸ª æ•´æ•°ï¼Œå¹¶è¿”å›å®ƒä»¬çš„æ•°ç»„ä¸‹æ ‡ã€‚</p><p>ä½ å¯ä»¥å‡è®¾æ¯ç§è¾“å…¥åªä¼šå¯¹åº”ä¸€ä¸ªç­”æ¡ˆã€‚ä½†æ˜¯ï¼Œæ•°ç»„ä¸­åŒä¸€ä¸ªå…ƒç´ åœ¨ç­”æ¡ˆé‡Œä¸èƒ½é‡å¤å‡ºç°ã€‚</p><p>ä½ å¯ä»¥æŒ‰ä»»æ„é¡ºåºè¿”å›ç­”æ¡ˆã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span>(<span class="hljs-title class_ inherited__">object</span>):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">twoSum</span>(<span class="hljs-params">self, nums, target</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        :type nums: List[int]</span><br><span class="hljs-string">        :type target: int</span><br><span class="hljs-string">        :rtype: List[int]</span><br><span class="hljs-string">        &quot;&quot;&quot;</span> <span class="hljs-comment">#è¿™é‡Œåº”è¯¥æ˜¯åˆ¤æ–­ç”¨çš„</span><br>        <span class="hljs-comment"># éå†åˆ—è¡¨</span><br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(nums)):<br>            <span class="hljs-comment"># è®¡ç®—éœ€è¦æ‰¾åˆ°çš„ä¸‹ä¸€ä¸ªç›®æ ‡æ•°å­—</span><br>            res = target-nums[i]<br>                <span class="hljs-comment"># iä¸ªæ•°å­—çš„å¯¹åº”çš„å¤§å°æ”¾åœ¨ içš„ç©ºé—´ä¸Š</span><br>            <span class="hljs-keyword">if</span> res <span class="hljs-keyword">in</span> nums[i+<span class="hljs-number">1</span>:]:<br><br><br>                <span class="hljs-comment"># è‹¥å­˜åœ¨ï¼Œè¿”å›ç­”æ¡ˆã€‚è¿™é‡Œç”±äºæ˜¯ä¸¤æ•°ä¹‹å’Œï¼Œå¯é‡‡ç”¨.index()æ–¹æ³•</span><br>                <span class="hljs-comment"># è·å¾—ç›®æ ‡å…ƒç´ åœ¨nums[i+1:]è¿™ä¸ªå­æ•°ç»„ä¸­çš„ç´¢å¼•åï¼Œè¿˜éœ€åŠ ä¸Ši+1æ‰æ˜¯è¯¥å…ƒç´ åœ¨numsä¸­çš„ç´¢å¼•</span><br>                <span class="hljs-keyword">return</span> [i, nums[i+<span class="hljs-number">1</span>:].index(res)+i+<span class="hljs-number">1</span>] <span class="hljs-comment">#index(å€¼ç”¨çš„æ˜¯ç›´æ¥ç´¢å¼•å‡ºæ ‡ç­¾ã€)</span><br><br><span class="hljs-comment"># æ—¶é—´å¤æ‚è¯»ä¸º n^2</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">twoSum</span>(<span class="hljs-params">self, nums: <span class="hljs-type">List</span>[<span class="hljs-built_in">int</span>], target: <span class="hljs-built_in">int</span></span>) -&gt; <span class="hljs-type">List</span>[<span class="hljs-built_in">int</span>]:<br>        idx = &#123;&#125;  <span class="hljs-comment"># åˆ›å»ºä¸€ä¸ªç©ºå“ˆå¸Œè¡¨ï¼ˆå­—å…¸ï¼‰</span><br>        <span class="hljs-keyword">for</span> j, x <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(nums):  <span class="hljs-comment"># x=nums[j]</span><br>            <span class="hljs-keyword">if</span> target - x <span class="hljs-keyword">in</span> idx:  <span class="hljs-comment"># åœ¨å·¦è¾¹æ‰¾ nums[i]ï¼Œæ»¡è¶³ nums[i]+x=target</span><br>                <span class="hljs-keyword">return</span> [idx[target - x], j]  <span class="hljs-comment"># è¿”å›ä¸¤ä¸ªæ•°çš„ä¸‹æ ‡</span><br>            idx[x] = j  <span class="hljs-comment"># ä¿å­˜ nums[j] å’Œ j</span><br><br><span class="hljs-comment">#hashè¡¨çš„æ˜ å°„å…³ç³», a[i] = x ä»¤ b[x] = i å¯¹äºtarget - x åªè¦æ£€æµ‹åè¡¨æ˜¯ä¸æ˜¯æœ‰è¿™ä¸ªå€¼å³å¯</span><br><br></code></pre></td></tr></table></figure><h3 id="ä¸¤æ•°ç›¸åŠ -2"><a href="#ä¸¤æ•°ç›¸åŠ -2" class="headerlink" title="ä¸¤æ•°ç›¸åŠ  -2"></a>ä¸¤æ•°ç›¸åŠ  -2</h3><p>ç»™ä½ ä¸¤ä¸ª éç©º çš„é“¾è¡¨ï¼Œè¡¨ç¤ºä¸¤ä¸ªéè´Ÿçš„æ•´æ•°ã€‚å®ƒä»¬æ¯ä½æ•°å­—éƒ½æ˜¯æŒ‰ç…§ é€†åº çš„æ–¹å¼å­˜å‚¨çš„ï¼Œå¹¶ä¸”æ¯ä¸ªèŠ‚ç‚¹åªèƒ½å­˜å‚¨ ä¸€ä½ æ•°å­—ã€‚</p><p>è¯·ä½ å°†ä¸¤ä¸ªæ•°ç›¸åŠ ï¼Œå¹¶ä»¥ç›¸åŒå½¢å¼è¿”å›ä¸€ä¸ªè¡¨ç¤ºå’Œçš„é“¾è¡¨ã€‚</p><p>ä½ å¯ä»¥å‡è®¾é™¤äº†æ•°å­— 0 ä¹‹å¤–ï¼Œè¿™ä¸¤ä¸ªæ•°éƒ½ä¸ä¼šä»¥ 0 å¼€å¤´ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span>:<br>    <span class="hljs-comment"># l1 å’Œ l2 ä¸ºå½“å‰éå†çš„èŠ‚ç‚¹ï¼Œcarry ä¸ºè¿›ä½</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">addTwoNumbers</span>(<span class="hljs-params">self, l1: <span class="hljs-type">Optional</span>[ListNode], l2: <span class="hljs-type">Optional</span>[ListNode], carry=<span class="hljs-number">0</span></span>) -&gt; <span class="hljs-type">Optional</span>[ListNode]:<span class="hljs-comment">#Optionalè¡¨ç¤ºå¯ä»¥æ˜¯ListNodeç±»å‹ä¹Ÿå¯ä»¥æ˜¯Noneç±»å‹</span><br>        <span class="hljs-comment">#é€’å½’çš„ç»“æŸæ ‡å¿—</span><br>        <span class="hljs-keyword">if</span> l1 <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> l2 <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:  <span class="hljs-comment"># é€’å½’è¾¹ç•Œï¼šl1 å’Œ l2 éƒ½æ˜¯ç©ºèŠ‚ç‚¹</span><br>            <span class="hljs-keyword">return</span> ListNode(carry) <span class="hljs-keyword">if</span> carry <span class="hljs-keyword">else</span> <span class="hljs-literal">None</span>  <span class="hljs-comment"># åˆ›å»ºä¸€ä¸ªèŠ‚ç‚¹å€¼ä¸ºcarryçš„ç»“ç‚¹</span><br>            <span class="hljs-comment">#è¿›ä½çš„æ ‡å¿—</span><br>        <span class="hljs-keyword">if</span> l1 <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:  <span class="hljs-comment"># ä»¤l1ä¸€ç›´æ˜¯é•¿çš„èŠ‚ç‚¹</span><br>            l1, l2 = l2, l1  <br><br>        carry += l1.val + (l2.val <span class="hljs-keyword">if</span> l2 <span class="hljs-keyword">else</span> <span class="hljs-number">0</span>)  <span class="hljs-comment"># è¿™ä¸ªè¯­å¥ä¸éœ€è¦ä¿®æ­£æ˜¯å¦ä¸ºé›¶çš„é•¿åº¦</span><br>        l1.val = carry % <span class="hljs-number">10</span>  <span class="hljs-comment"># æ¯ä¸ªèŠ‚ç‚¹ä¿å­˜ä¸€ä¸ªæ•°ä½</span><br>        l1.<span class="hljs-built_in">next</span> = self.addTwoNumbers(l1.<span class="hljs-built_in">next</span>, l2.<span class="hljs-built_in">next</span> <span class="hljs-keyword">if</span> l2 <span class="hljs-keyword">else</span> <span class="hljs-literal">None</span>, carry // <span class="hljs-number">10</span>)  <span class="hljs-comment"># è¿›ä½ å·²ç»æ­£ç¡®çš„å†³å®šl2çš„é•¿åº¦</span><br>        <span class="hljs-comment">#carry</span><br>        <span class="hljs-keyword">return</span> l1<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">addTwoNumbers</span>(<span class="hljs-params">self, l1: <span class="hljs-type">Optional</span>[ListNode], l2: <span class="hljs-type">Optional</span>[ListNode]</span>) -&gt; <span class="hljs-type">Optional</span>[ListNode]:<br>        cur = dummy = ListNode()  <span class="hljs-comment"># å“¨å…µèŠ‚ç‚¹</span><br>        carry = <span class="hljs-number">0</span>  <span class="hljs-comment"># è¿›ä½</span><br>        <span class="hljs-keyword">while</span> l1 <span class="hljs-keyword">or</span> l2 <span class="hljs-keyword">or</span> carry:  <span class="hljs-comment"># æœ‰ä¸€ä¸ªä¸æ˜¯ç©ºèŠ‚ç‚¹ï¼Œæˆ–è€…è¿˜æœ‰è¿›ä½ï¼Œå°±ç»§ç»­è¿­ä»£</span><br>            carry += (l1.val <span class="hljs-keyword">if</span> l1 <span class="hljs-keyword">else</span> <span class="hljs-number">0</span>) + (l2.val <span class="hljs-keyword">if</span> l2 <span class="hljs-keyword">else</span> <span class="hljs-number">0</span>)  <span class="hljs-comment"># èŠ‚ç‚¹å€¼å’Œè¿›ä½åŠ åœ¨ä¸€èµ·</span><br>            cur.<span class="hljs-built_in">next</span> = ListNode(carry % <span class="hljs-number">10</span>)  <span class="hljs-comment"># æ¯ä¸ªèŠ‚ç‚¹ä¿å­˜ä¸€ä¸ªæ•°ä½</span><br>            carry //= <span class="hljs-number">10</span>  <span class="hljs-comment"># æ–°çš„è¿›ä½</span><br>            cur = cur.<span class="hljs-built_in">next</span>  <span class="hljs-comment"># ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</span><br>            <span class="hljs-keyword">if</span> l1: l1 = l1.<span class="hljs-built_in">next</span>  <span class="hljs-comment"># ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</span><br>            <span class="hljs-keyword">if</span> l2: l2 = l2.<span class="hljs-built_in">next</span>  <span class="hljs-comment"># ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</span><br>        <span class="hljs-keyword">return</span> dummy.<span class="hljs-built_in">next</span>  <span class="hljs-comment"># å“¨å…µèŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹å°±æ˜¯å¤´èŠ‚ç‚¹</span><br><br><br></code></pre></td></tr></table></figure><h4 id="æ— é‡å¤å­—ç¬¦çš„æœ€é•¿å­ä¸²-3"><a href="#æ— é‡å¤å­—ç¬¦çš„æœ€é•¿å­ä¸²-3" class="headerlink" title="æ— é‡å¤å­—ç¬¦çš„æœ€é•¿å­ä¸² -3"></a>æ— é‡å¤å­—ç¬¦çš„æœ€é•¿å­ä¸² -3</h4><p>ç»™å®šä¸€ä¸ªå­—ç¬¦ä¸² s ï¼Œè¯·ä½ æ‰¾å‡ºå…¶ä¸­ä¸å«æœ‰é‡å¤å­—ç¬¦çš„ æœ€é•¿å­ä¸² çš„é•¿åº¦ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs python"><br><span class="hljs-comment">#æ»‘åŠ¨çª—å£ä»¥åŠ å“ˆå¸Œè¡¨</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">lengthOfLongestSubstring</span>(<span class="hljs-params">self, s: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">int</span>: <span class="hljs-comment">#è¿™ä¸ªåº”è¯¥æ˜¯å®šä¹‰äº†å†…éƒ¨å˜é‡çš„ä»¥åŠå‡½æ•°çš„è¿”å›ç±»å‹</span><br>        dic, res, i = &#123;&#125;, <span class="hljs-number">0</span>, -<span class="hljs-number">1</span><br>        <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(s)):<br>            <span class="hljs-keyword">if</span> s[j] <span class="hljs-keyword">in</span> dic: <span class="hljs-comment">#å¦‚æœåœ¨è¡¨çš„ä½ç½®ä¸ŠæŸ¥åˆ°äº†è¿™ä¸ªçš„å€¼ä¹Ÿå°±æ˜¯é‡å¤äº†</span><br>            <span class="hljs-comment"># è¯†åˆ«å‡ºæ¯ä¸€ä¸ªé‡å¤çš„å·¦æŒ‡æ ‡,ä»¥åŠè¿™ä¸ªé‡‡å–ç¼©å‡çš„æ–¹å¼,å®Œæˆäº†ä¸€èµ·æ›´æ–°,è¿˜æœ‰æ¯”è¾ƒçš„æ¨¡å¼</span><br>                i = <span class="hljs-built_in">max</span>(dic[s[j]], i) <span class="hljs-comment"># æ›´æ–°å·¦æŒ‡é’ˆ i</span><br>            dic[s[j]] = j <span class="hljs-comment"># åœ¨è¡¨çš„s[j]æ”¾å…¥ åœ¨å­—ç¬¦ä¸²sä¸­çš„ä½ç½® ä¹Ÿå°±æ˜¯å¯ä»¥ä¸€ä¸€æ˜ å°„çš„</span><br>            res = <span class="hljs-built_in">max</span>(res, j - i) <span class="hljs-comment"># æ›´æ–°ç»“æœ</span><br>        <span class="hljs-keyword">return</span> res<br><br><span class="hljs-comment">#åŠ¨æ€è§„åˆ’åŠ hash é‰´å®šä¸ºè„‘ç˜«ä¸œè¥¿</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">lengthOfLongestSubstring</span>(<span class="hljs-params">self, s: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">int</span>:<br>        dic = &#123;&#125;<br>        res = tmp = <span class="hljs-number">0</span><br>        <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(s)):<br>            i = dic.get(s[j], -<span class="hljs-number">1</span>) <span class="hljs-comment"># è·å–ç´¢å¼• i</span><br>            dic[s[j]] = j <span class="hljs-comment"># æ›´æ–°å“ˆå¸Œè¡¨</span><br>            <br>            tmp = tmp + <span class="hljs-number">1</span> <span class="hljs-keyword">if</span> tmp &lt; j - i <span class="hljs-keyword">else</span> j - i <span class="hljs-comment"># dp[j - 1] -&gt; dp[j]</span><br>            res = <span class="hljs-built_in">max</span>(res, tmp) <span class="hljs-comment"># max(dp[j - 1], dp[j])</span><br>        <span class="hljs-keyword">return</span> res<br><br></code></pre></td></tr></table></figure><h4 id="å¯»æ‰¾ä¸¤ä¸ªæ­£åºæ•°ç»„çš„ä¸­ä½æ•°-4gg"><a href="#å¯»æ‰¾ä¸¤ä¸ªæ­£åºæ•°ç»„çš„ä¸­ä½æ•°-4gg" class="headerlink" title="å¯»æ‰¾ä¸¤ä¸ªæ­£åºæ•°ç»„çš„ä¸­ä½æ•° -4gg"></a>å¯»æ‰¾ä¸¤ä¸ªæ­£åºæ•°ç»„çš„ä¸­ä½æ•° -4gg</h4><p>æ—¶é—´å¤æ‚åº¦ä¸º <script type="math/tex">\log(m+n)</script><br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><code class="hljs python"><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">findMedianSortedArrays</span>(<span class="hljs-params">self, nums1: <span class="hljs-type">List</span>[<span class="hljs-built_in">int</span>], nums2: <span class="hljs-type">List</span>[<span class="hljs-built_in">int</span>]</span>) -&gt; <span class="hljs-built_in">float</span>:<br>        <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_k_min</span>(<span class="hljs-params">nums1, start1, end1, nums2, start2, end2, k</span>):<br>            remain1 = end1 - start1 + <span class="hljs-number">1</span><br>            remain2 = end2 - start2 + <span class="hljs-number">1</span><br>            <span class="hljs-keyword">if</span> remain1 == <span class="hljs-number">0</span>:<br>                <span class="hljs-keyword">return</span> nums2[start2 + k - <span class="hljs-number">1</span>]<br>            <span class="hljs-keyword">if</span> remain2 == <span class="hljs-number">0</span>:<br>                <span class="hljs-keyword">return</span> nums1[start1 + k - <span class="hljs-number">1</span>]<br>            <span class="hljs-keyword">if</span> k == <span class="hljs-number">1</span>:<br>                <span class="hljs-keyword">return</span> <span class="hljs-built_in">min</span>(nums1[start1], nums2[start2])<br>            i = start1 + <span class="hljs-built_in">min</span>(remain1, k // <span class="hljs-number">2</span>) - <span class="hljs-number">1</span><br>            j = start2 + <span class="hljs-built_in">min</span>(remain2, k // <span class="hljs-number">2</span>) - <span class="hljs-number">1</span><br>            <span class="hljs-keyword">if</span> nums1[i] &lt;= nums2[j]:<br>                <span class="hljs-keyword">return</span> get_k_min(nums1, i+<span class="hljs-number">1</span>, end1, nums2, start2, end2, k - (i - start1 + <span class="hljs-number">1</span>))<br>            <span class="hljs-keyword">else</span>:<br>                <span class="hljs-keyword">return</span> get_k_min(nums1, start1, end1, nums2, j+<span class="hljs-number">1</span>, end2, k - (j - start2 + <span class="hljs-number">1</span>))<br><br>        m, n = <span class="hljs-built_in">len</span>(nums1), <span class="hljs-built_in">len</span>(nums2)<br>        mid1 = (m + n + <span class="hljs-number">1</span>) // <span class="hljs-number">2</span><br>        mid2 = (m + n + <span class="hljs-number">2</span>) // <span class="hljs-number">2</span><br>        a = get_k_min(nums1, <span class="hljs-number">0</span>, m-<span class="hljs-number">1</span>, nums2, <span class="hljs-number">0</span>, n-<span class="hljs-number">1</span>, mid1)<br>        b = get_k_min(nums1, <span class="hljs-number">0</span>, m-<span class="hljs-number">1</span>, nums2, <span class="hljs-number">0</span>, n-<span class="hljs-number">1</span>, mid2)<br>        <span class="hljs-keyword">return</span> (a + b) / <span class="hljs-number">2</span><br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">findMedianSortedArrays</span>(<span class="hljs-params">self, nums1: <span class="hljs-type">List</span>[<span class="hljs-built_in">int</span>], nums2: <span class="hljs-type">List</span>[<span class="hljs-built_in">int</span>]</span>) -&gt; <span class="hljs-built_in">float</span>:<br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(nums1) &gt; <span class="hljs-built_in">len</span>(nums2):<br>            <span class="hljs-keyword">return</span> self.findMedianSortedArrays(nums2, nums1)<br>        <span class="hljs-comment">#éƒ½æ˜¯å¯ä»¥é€šè¿‡æ›¿æ¢ä¸¤ä¸ªæ•°ç»„çš„åç§°æ¥ä¿è¯ä¸€å®šçš„é¡ºåº num2çš„é•¿åº¦å§‹ç»ˆæ˜¯æœ€é•¿çš„</span><br><br>        infinty = <span class="hljs-number">2</span>**<span class="hljs-number">40</span>  <span class="hljs-comment"># ä»£è¡¨æ­£æ— ç©·</span><br>        m, n = <span class="hljs-built_in">len</span>(nums1), <span class="hljs-built_in">len</span>(nums2)<br>        left, right = <span class="hljs-number">0</span>, m<br>        <span class="hljs-comment"># median1ï¼šå‰ä¸€éƒ¨åˆ†çš„æœ€å¤§å€¼</span><br>        <span class="hljs-comment"># median2ï¼šåä¸€éƒ¨åˆ†çš„æœ€å°å€¼</span><br>        median1, median2 = <span class="hljs-number">0</span>, <span class="hljs-number">0</span><br><br><br>        <span class="hljs-keyword">while</span> left &lt;= right: <span class="hljs-comment"># ä¸€ç›´å¾ªç¯æ‰¾åˆ°ä¸€ä¸ªæœ€å¤§çš„iæ»¡è¶³A[iâˆ’1]â‰¤B[j]</span><br>            <span class="hljs-comment"># å‰ä¸€éƒ¨åˆ†åŒ…å« nums1[0 .. i-1] å’Œ nums2[0 .. j-1]</span><br>            <span class="hljs-comment"># // åä¸€éƒ¨åˆ†åŒ…å« nums1[i .. m-1] å’Œ nums2[j .. n-1]</span><br>            i = (left + right) // <span class="hljs-number">2</span><br>            j = (m + n + <span class="hljs-number">1</span>) // <span class="hljs-number">2</span> - i<br><br><br>            <span class="hljs-comment"># nums_im1, nums_i, nums_jm1, nums_j åˆ†åˆ«è¡¨ç¤º nums1[i-1], nums1[i], nums2[j-1], nums2[j]</span><br>            <span class="hljs-comment"># å½“ä¸€ä¸ªæ•°ç»„ä¸å‡ºç°åœ¨å‰ä¸€éƒ¨åˆ†æ—¶,å¯¹åº”çš„å€¼ä¸ºè´Ÿæ— ç©·,å°±ä¸ä¼šå¯¹å‰ä¸€éƒ¨åˆ†çš„æœ€å¤§å€¼äº§ç”Ÿå½±å“</span><br>            nums_im1 = (-infinty <span class="hljs-keyword">if</span> i == <span class="hljs-number">0</span> <span class="hljs-keyword">else</span> nums1[i - <span class="hljs-number">1</span>]) <span class="hljs-comment"># æ³¨æ„å†™æ³•ä¸javaä¸åŒ</span><br>            <span class="hljs-comment"># å½“ä¸€ä¸ªæ•°ç»„ä¸å‡ºç°åœ¨åä¸€éƒ¨åˆ†æ—¶,å¯¹åº”çš„å€¼ä¸ºæ­£æ— ç©·,å°±ä¸ä¼šå¯¹åä¸€éƒ¨åˆ†çš„æœ€å°å€¼äº§ç”Ÿå½±å“</span><br>            nums_i = (infinty <span class="hljs-keyword">if</span> i == m <span class="hljs-keyword">else</span> nums1[i])<br>            nums_jm1 = (-infinty <span class="hljs-keyword">if</span> j == <span class="hljs-number">0</span> <span class="hljs-keyword">else</span> nums2[j - <span class="hljs-number">1</span>])<br>            nums_j = (infinty <span class="hljs-keyword">if</span> j == n <span class="hljs-keyword">else</span> nums2[j])<br><br><br>            <span class="hljs-keyword">if</span> nums_im1 &lt;= nums_j:<br>                median1, median2 = <span class="hljs-built_in">max</span>(nums_im1, nums_jm1), <span class="hljs-built_in">min</span>(nums_i, nums_j)<br>                left = i + <span class="hljs-number">1</span><br>            <span class="hljs-keyword">else</span>:<br>                right = i - <span class="hljs-number">1</span><br><br><br>        <span class="hljs-keyword">return</span> (median1 + median2) / <span class="hljs-number">2</span> <span class="hljs-keyword">if</span> (m + n) % <span class="hljs-number">2</span> == <span class="hljs-number">0</span> <span class="hljs-keyword">else</span> median1<br><br></code></pre></td></tr></table></figure></p><h4 id="æœ€é•¿å›æ–‡ä¸²"><a href="#æœ€é•¿å›æ–‡ä¸²" class="headerlink" title="æœ€é•¿å›æ–‡ä¸²"></a>æœ€é•¿å›æ–‡ä¸²</h4><p>è¯†åˆ«å‡ºæœ€é•¿çš„å›æ–‡ä¸²<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># è¿™ä¸ªç¨‹åºå¤æ‚åº¦æœ‰ç‚¹é«˜()</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">longestPalindrome</span>(<span class="hljs-params">self, s: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:<br>        n = <span class="hljs-built_in">len</span>(s)<br>        <span class="hljs-keyword">if</span> n &lt; <span class="hljs-number">2</span>:<br>            <span class="hljs-keyword">return</span> s<br><br>        max_len = <span class="hljs-number">1</span><br>        begin = <span class="hljs-number">0</span><br>        <span class="hljs-comment"># dp[i][j] è¡¨ç¤º s[i..j] æ˜¯å¦æ˜¯å›æ–‡ä¸²</span><br>        dp = [[<span class="hljs-literal">False</span>] * n <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(n)] <span class="hljs-comment">#[False]*n ä¸ºä¸€ä¸ªåˆ—è¡¨ä¸­çš„Falseçš„æ‹¼æ¥çš„å±•ç¤º</span><br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(n):<br>            dp[i][i] = <span class="hljs-literal">True</span><br>        <br>        <span class="hljs-comment"># é€’æ¨å¼€å§‹</span><br>        <span class="hljs-comment"># å…ˆæšä¸¾å­ä¸²é•¿åº¦</span><br>        <span class="hljs-keyword">for</span> L <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">2</span>, n + <span class="hljs-number">1</span>):<br>            <span class="hljs-comment"># æšä¸¾å·¦è¾¹ç•Œï¼Œå·¦è¾¹ç•Œçš„ä¸Šé™è®¾ç½®å¯ä»¥å®½æ¾ä¸€äº›</span><br>            <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(n):<br>                <span class="hljs-comment"># ç”± L å’Œ i å¯ä»¥ç¡®å®šå³è¾¹ç•Œï¼Œå³ j - i + 1 = L å¾—</span><br>                j = L + i - <span class="hljs-number">1</span><br>                <span class="hljs-comment"># å¦‚æœå³è¾¹ç•Œè¶Šç•Œï¼Œå°±å¯ä»¥é€€å‡ºå½“å‰å¾ªç¯</span><br>                <span class="hljs-comment">#i,j åˆ†åˆ«ä¸ºå·¦è¾¹ç•Œä¸æœ‰è¾¹ç•Œ åœ¨è¿™ä¸ªå¾ªç¯ä¸­,i,jè¦†ç›–äº†æ‰€æœ‰çš„å€¼</span><br>                <span class="hljs-keyword">if</span> j &gt;= n:<br>                    <span class="hljs-keyword">break</span><br>                <span class="hljs-comment">#æ£€æµ‹çš„é¡ºåºä¸º æŒ‰ç…§é•¿åº¦æ¥è¿›è¡Œæ£€ç´¢</span><br>                <span class="hljs-comment">#å¯¹äºiå¼€å§‹çš„,æœ‰å¤šå°‘ç›¸åŒçš„å­—ç¬¦ä¸²,åŒæ—¶ä¸€å¼€å§‹çš„æ—¶å€™é»˜è®¤æ˜¯å¯¹äºä»»æ„ä¸€ä¸ªå­—ç¬¦,éƒ½å¯ä»¥è§†ä¸ºå›æ–‡ä¸²,åŒæ—¶å¯¹äºä»»ä½•ä¸€ä¸ªä¸²æ¥è¯´,å¦‚æœé¦–ä½ç›¸åŒçš„è¯,åªéœ€è¦æ£€æµ‹é‡Œé¢ä¸¤ä¸ªçš„å­—ç¬¦ä¸²æ˜¯å¦æ˜¯ç›¸åŒçš„.</span><br>                <span class="hljs-comment"># ä»¥ä¸‹å¼€å§‹é€’å½’</span><br>                <span class="hljs-keyword">if</span> s[i] != s[j]:<br>                    dp[i][j] = <span class="hljs-literal">False</span> <br>                <span class="hljs-keyword">else</span>:<br>                    <span class="hljs-keyword">if</span> j - i &lt; <span class="hljs-number">3</span>:<br>                        dp[i][j] = <span class="hljs-literal">True</span><br>                    <span class="hljs-keyword">else</span>:<br>                        dp[i][j] = dp[i + <span class="hljs-number">1</span>][j - <span class="hljs-number">1</span>]<br>                <br>                <span class="hljs-comment"># åªè¦ dp[i][L] == true æˆç«‹ï¼Œå°±è¡¨ç¤ºå­ä¸² s[i..L] æ˜¯å›æ–‡ï¼Œæ­¤æ—¶è®°å½•å›æ–‡é•¿åº¦å’Œèµ·å§‹ä½ç½®</span><br>                <span class="hljs-keyword">if</span> dp[i][j] <span class="hljs-keyword">and</span> j - i + <span class="hljs-number">1</span> &gt; max_len:<br>                    max_len = j - i + <span class="hljs-number">1</span><br>                    begin = i<br>        <span class="hljs-keyword">return</span> s[begin:begin + max_len]<br><br><span class="hljs-comment">#è¿™æ˜¯ä¸€ä¸ªä»ä¸­å¿ƒå‘æ—è¾¹æ‰©æ•£çš„ç®—æ³•,åªè¦æœ‰å°±å¯ä»¥å‘å¤–æ£€æµ‹</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">expandAroundCenter</span>(<span class="hljs-params">self, s, left, right</span>):<br>        <span class="hljs-keyword">while</span> left &gt;= <span class="hljs-number">0</span> <span class="hljs-keyword">and</span> right &lt; <span class="hljs-built_in">len</span>(s) <span class="hljs-keyword">and</span> s[left] == s[right]:<br>            left -= <span class="hljs-number">1</span><br>            right += <span class="hljs-number">1</span><br>        <span class="hljs-keyword">return</span> left + <span class="hljs-number">1</span>, right - <span class="hljs-number">1</span><br><span class="hljs-comment"># è¿™é‡Œè¡¨ç¤ºå½“å‰çš„ä¸œè¥¿åˆ¤æ–­å®Œæˆäº†</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">longestPalindrome</span>(<span class="hljs-params">self, s: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:<br>        start, end = <span class="hljs-number">0</span>, <span class="hljs-number">0</span><br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(s)):<span class="hljs-comment"># ä»å­—ç¬¦ä¸²çš„é•¿åº¦å‡ºå‘?</span><br>            left1, right1 = self.expandAroundCenter(s, i, i)<br>            left2, right2 = self.expandAroundCenter(s, i, i + <span class="hljs-number">1</span>)<br>            <span class="hljs-keyword">if</span> right1 - left1 &gt; end - start:<br>                start, end = left1, right1<br>            <span class="hljs-keyword">if</span> right2 - left2 &gt; end - start:<br>                start, end = left2, right2<br>        <span class="hljs-keyword">return</span> s[start: end + <span class="hljs-number">1</span>]<br></code></pre></td></tr></table></figure></p><h3 id="nå­—å½¢æ‰©æ•£-6-1"><a href="#nå­—å½¢æ‰©æ•£-6-1" class="headerlink" title="nå­—å½¢æ‰©æ•£ - 6  (1)"></a>nå­—å½¢æ‰©æ•£ - 6  (1)</h3><p>å°†ä¸€ä¸ªç»™å®šå­—ç¬¦ä¸² s æ ¹æ®ç»™å®šçš„è¡Œæ•° numRows ï¼Œä»¥ä»ä¸Šå¾€ä¸‹ã€ä»å·¦åˆ°å³è¿›è¡Œ Z å­—å½¢æ’åˆ—ã€‚<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">convert</span>(<span class="hljs-params">self, s: <span class="hljs-built_in">str</span>, numRows: <span class="hljs-built_in">int</span></span>) -&gt; <span class="hljs-built_in">str</span>:<br>        <span class="hljs-keyword">if</span> numRows &lt; <span class="hljs-number">2</span>: <span class="hljs-keyword">return</span> s<br>        res = [<span class="hljs-string">&quot;&quot;</span> <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(numRows)]<span class="hljs-comment"># å«æœ‰numrowä¸ªç©ºå­—ç¬¦ä¸²çš„ç»“æ„ åŒæ—¶ç›¸å½“äºåšäº†ä¸€ä¸ªåˆå§‹åŒ–</span><br>        i, flag = <span class="hljs-number">0</span>, -<span class="hljs-number">1</span><br>        <span class="hljs-keyword">for</span> c <span class="hljs-keyword">in</span> s:<br>            res[i] += c<br>            <span class="hljs-keyword">if</span> i == <span class="hljs-number">0</span> <span class="hljs-keyword">or</span> i == numRows - <span class="hljs-number">1</span>: flag = -flag<br>            i += flag <span class="hljs-comment"># é€šè¿‡è®¾ç½®ä¸€ä¸ªflagæ¥æ§åˆ¶æ•°å­—çš„åŠ å…¥æ–¹å¼</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>.join(res)<br><br></code></pre></td></tr></table></figure></p><h2 id="æ’åº"><a href="#æ’åº" class="headerlink" title="æ’åº"></a>æ’åº</h2><h3 id="æ’å…¥åŒºé—´æ’åº-57-2"><a href="#æ’å…¥åŒºé—´æ’åº-57-2" class="headerlink" title="æ’å…¥åŒºé—´æ’åº 57 - (2)"></a>æ’å…¥åŒºé—´æ’åº 57 - (2)</h3><p>å¯¹äºè¿™ä¸ªæ•°æ®,åªæœ‰é‡åˆä¸‹é¢çš„äº¤é›†, ä»¥åŠå¯ä»¥ç›´æ¥æ”¾å…¥çš„æ•°ç»„é›†, æ‰€ä»¥ä¸€æ—¦æœ‰äº¤é›† ,å¯ä»¥æ›´æ–°æ–°çš„left ä¸ right æ”¾å…¥æ–°çš„å¾ªç¯ä¸­è¿›è¡Œæ›´æ–°</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">insert</span>(<span class="hljs-params">self, intervals: <span class="hljs-type">List</span>[<span class="hljs-type">List</span>[<span class="hljs-built_in">int</span>]], newInterval: <span class="hljs-type">List</span>[<span class="hljs-built_in">int</span>]</span>) -&gt; <span class="hljs-type">List</span>[<span class="hljs-type">List</span>[<span class="hljs-built_in">int</span>]]:<br>        left, right = newInterval<br>        placed = <span class="hljs-literal">False</span><br>        ans = <span class="hljs-built_in">list</span>() <span class="hljs-comment">#ç›¸å½“äºåˆ›å»ºäº†ä¸€ä¸ªæ–°çš„åˆ—è¡¨</span><br>        <span class="hljs-keyword">for</span> li, ri <span class="hljs-keyword">in</span> intervals:<br>            <span class="hljs-keyword">if</span> li &gt; right:<br>                <span class="hljs-comment"># åœ¨æ’å…¥åŒºé—´çš„å³ä¾§ä¸”æ— äº¤é›†</span><br>                <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> placed:<br>                    ans.append([left, right])<br>                    placed = <span class="hljs-literal">True</span> <span class="hljs-comment">#å®Œæˆäº†æ”¾ç½®</span><br>                ans.append([li, ri])<br><br>            <span class="hljs-keyword">elif</span> ri &lt; left:<br>                <span class="hljs-comment"># åœ¨æ’å…¥åŒºé—´çš„å·¦ä¾§ä¸”æ— äº¤é›†</span><br>                ans.append([li, ri])<br>            <br>            <span class="hljs-keyword">else</span>:<br>                <span class="hljs-comment"># ä¸æ’å…¥åŒºé—´æœ‰äº¤é›†ï¼Œè®¡ç®—å®ƒä»¬çš„å¹¶é›†</span><br>                left = <span class="hljs-built_in">min</span>(left, li)<br>                right = <span class="hljs-built_in">max</span>(right, ri)<br>        <br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> placed:<br>            ans.append([left, right])<br>        <span class="hljs-keyword">return</span> ans<br><br></code></pre></td></tr></table></figure><h3 id="ä¸‰æ•°ä¹‹å’Œ-3"><a href="#ä¸‰æ•°ä¹‹å’Œ-3" class="headerlink" title="ä¸‰æ•°ä¹‹å’Œ - (3)"></a>ä¸‰æ•°ä¹‹å’Œ - (3)</h3><p>ç»™ä½ ä¸€ä¸ªæ•´æ•°æ•°ç»„ nums ï¼Œåˆ¤æ–­æ˜¯å¦å­˜åœ¨ä¸‰å…ƒç»„ [ nums[i], nums[j], nums[k] ] æ»¡è¶³ i != jã€i != k ä¸” j != k ï¼ŒåŒæ—¶è¿˜æ»¡è¶³ nums[i] + nums[j] + nums[k] == 0 ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#ä½ç©ºé—´å¤æ‚åº¦çš„ç®—æ³•</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">threeSum</span>(<span class="hljs-params">self, nums: <span class="hljs-type">List</span>[<span class="hljs-built_in">int</span>]</span>) -&gt; <span class="hljs-type">List</span>[<span class="hljs-type">List</span>[<span class="hljs-built_in">int</span>]]:<br>        <br>        n=<span class="hljs-built_in">len</span>(nums)<br>        res=[]<br>        <span class="hljs-keyword">if</span>(<span class="hljs-keyword">not</span> nums <span class="hljs-keyword">or</span> n&lt;<span class="hljs-number">3</span>):<br>            <span class="hljs-keyword">return</span> []<br>        nums.sort() <span class="hljs-comment">#ç›¸å½“äºç›´æ¥å®Œæˆå‡åºæ’åˆ—</span><br>        res=[]<br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(n):<br>            <span class="hljs-keyword">if</span>(nums[i]&gt;<span class="hljs-number">0</span>): <span class="hljs-comment">#?åªèƒ½ä¿è¯ iæŒ‡æ ‡æ˜¯ä¸€ä¸ªç”¨è´Ÿæ•°çš„å½¢å¼å–å‡ºæ¥çš„å€¼</span><br>                <span class="hljs-keyword">return</span> res<br>            <span class="hljs-keyword">if</span>(i&gt;<span class="hljs-number">0</span> <span class="hljs-keyword">and</span> nums[i]==nums[i-<span class="hljs-number">1</span>]):<span class="hljs-comment">#å·²ç»æ£€æµ‹è¿‡äº†ä¸éœ€è¦è¿è¡Œ</span><br>                <span class="hljs-keyword">continue</span><br>            L=i+<span class="hljs-number">1</span><br>            R=n-<span class="hljs-number">1</span><br>            <span class="hljs-keyword">while</span>(L&lt;R):<br>                <span class="hljs-keyword">if</span>(nums[i]+nums[L]+nums[R]==<span class="hljs-number">0</span>):<br>                    res.append([nums[i],nums[L],nums[R]])<br>                    <span class="hljs-keyword">while</span>(L&lt;R <span class="hljs-keyword">and</span> nums[L]==nums[L+<span class="hljs-number">1</span>]): <span class="hljs-comment">#ç›¸åŒä¸éœ€è¦æ‰§è¡Œ</span><br>                        L=L+<span class="hljs-number">1</span><br>                    <span class="hljs-keyword">while</span>(L&lt;R <span class="hljs-keyword">and</span> nums[R]==nums[R-<span class="hljs-number">1</span>]):<br>                        R=R-<span class="hljs-number">1</span><br>                    L=L+<span class="hljs-number">1</span><br>                    R=R-<span class="hljs-number">1</span><br>                <span class="hljs-keyword">elif</span>(nums[i]+nums[L]+nums[R]&gt;<span class="hljs-number">0</span>):<br>                    R=R-<span class="hljs-number">1</span><br>                <span class="hljs-keyword">else</span>:<br>                    L=L+<span class="hljs-number">1</span><br>        <span class="hljs-keyword">return</span> res<br><span class="hljs-comment"># è¯´å®è¯, æœ‰ç‚¹åƒéå†çš„ç›´æ¥æ±‚å‡ºæ‰€æœ‰æƒ…å†µçš„ç®—æ³•ä½†å®é™…ä¸Šé‡‡ç”¨äº†ä¸€ç§ç±»ä¼¼äºä¸€å±‚éå†çš„æ–¹æ³•,å¯¹äºä¸€ä¸ªæ•°æ¥è¯´,åªè¦æ’åºè¿‡åæ‰ç”¨ä¸€ç§ç±»ä¼¼äºåŒæŒ‡é’ˆéå†çš„æ–¹æ³•å³å¯</span><br><br><br><span class="hljs-comment"># ä¸»æ‰“ä¸€ä¸ªåˆ©ç”¨å­—å…¸æ’åº</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">threeSum</span>(<span class="hljs-params">self, nums: <span class="hljs-type">List</span>[<span class="hljs-built_in">int</span>]</span>) -&gt; <span class="hljs-type">List</span>[<span class="hljs-type">List</span>[<span class="hljs-built_in">int</span>]]:<br>        ans = [] <span class="hljs-comment"># ç»“æœåˆ—è¡¨</span><br>        counts = &#123;&#125; <span class="hljs-comment"># ä½¿ç”¨å­—å…¸å­˜å‚¨numsä¸­çš„å…ƒç´ åŠå…¶å‡ºç°æ¬¡æ•°</span><br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> nums:<br>            counts[i] = counts.get(i, <span class="hljs-number">0</span>) + <span class="hljs-number">1</span> <span class="hljs-comment"># getæ˜¯å¾—åˆ° iå¯¹åº”çš„å­—å…¸çš„å€¼, æ—¶é—´å¤æ‚åº¦ç”šè‡³æ¥è¿‘1 </span><br>        <br>        nums = <span class="hljs-built_in">sorted</span>(counts) <span class="hljs-comment"># sorted æ˜¯ä¿ç•™å‰¯æœ¬çš„æ’åºæ–¹æ³•,sortæ˜¯ç›´æ¥åœ¨åŸæ¥çš„å­—å…¸ä¸Šé¢æ’åº</span><br>        <span class="hljs-keyword">for</span> i, num <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(nums):<br>            <span class="hljs-keyword">if</span> counts[num] &gt; <span class="hljs-number">1</span>: <span class="hljs-comment"># å¦‚æœå½“å‰å…ƒç´ çš„å‡ºç°æ¬¡æ•°å¤§äº1</span><br>                <span class="hljs-keyword">if</span> num == <span class="hljs-number">0</span>: <span class="hljs-comment"># å¤„ç†ç‰¹æ®Šæƒ…å†µ0</span><br>                    <span class="hljs-keyword">if</span> counts[num] &gt; <span class="hljs-number">2</span>:  <br>                        ans.append([<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>]) <span class="hljs-comment"># å¦‚æœ0å‡ºç°ä¸‰æ¬¡åŠä»¥ä¸Š,æ·»åŠ [0, 0, 0]åˆ°ç»“æœ</span><br>                        <span class="hljs-keyword">continue</span><br>                <span class="hljs-keyword">else</span>:<br>                    <span class="hljs-keyword">if</span> -num * <span class="hljs-number">2</span> <span class="hljs-keyword">in</span> counts: <span class="hljs-comment"># å¦‚æœå½“å‰å…ƒç´ çš„ç›¸åæ•°çš„ä¸¤å€ä¹Ÿåœ¨countsä¸­</span><br>                        ans.append([num, num, -<span class="hljs-number">2</span> * num]) <span class="hljs-comment"># æ·»åŠ [num, num, -2*num]åˆ°ç»“æœ</span><br><br>            <br>            <span class="hljs-keyword">if</span> num &lt; <span class="hljs-number">0</span>: <span class="hljs-comment"># åªéœ€è¦è€ƒè™‘è´Ÿæ•°çš„æƒ…å†µ</span><br>                two_sum = -num <span class="hljs-comment"># two_sumè¡¨ç¤ºé™¤numå¤–å¦å¤–ä¸¤ä¸ªå…ƒç´ çš„å’Œ</span><br>                left = bisect.bisect_left(nums, (two_sum - nums[-<span class="hljs-number">1</span>]), i + <span class="hljs-number">1</span>) <br>                <span class="hljs-comment"># ä½¿ç”¨äºŒåˆ†æŸ¥æ‰¾æ‰¾åˆ°åˆé€‚çš„å·¦è¾¹ç•Œä¸‹æ ‡</span><br>                <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> nums[left: bisect.bisect_right(nums, (two_sum // <span class="hljs-number">2</span>), left)]:<br>                    <span class="hljs-comment"># åœ¨åˆé€‚èŒƒå›´å†…éå†</span><br>                    k = two_sum - j  <br>                    <span class="hljs-keyword">if</span> k <span class="hljs-keyword">in</span> counts <span class="hljs-keyword">and</span> k != j: <span class="hljs-comment"># å¦‚æœæ‰¾åˆ°ç¬¦åˆçš„k</span><br>                        ans.append([num, j, k]) <span class="hljs-comment"># æ·»åŠ åˆ°ç»“æœ</span><br><br>        <span class="hljs-keyword">return</span> ans<br></code></pre></td></tr></table></figure><h3 id="ä¸‰æ•°ä¹‹å’Œæ¥è¿‘target"><a href="#ä¸‰æ•°ä¹‹å’Œæ¥è¿‘target" class="headerlink" title="ä¸‰æ•°ä¹‹å’Œæ¥è¿‘target"></a>ä¸‰æ•°ä¹‹å’Œæ¥è¿‘target</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">threeSumClosest</span>(<span class="hljs-params">self, nums: <span class="hljs-type">List</span>[<span class="hljs-built_in">int</span>], target: <span class="hljs-built_in">int</span></span>) -&gt; <span class="hljs-built_in">int</span>:<br>        nums.sort()<br>        n = <span class="hljs-built_in">len</span>(nums)<br>        min_diff = inf<br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(n - <span class="hljs-number">2</span>):<br>            x = nums[i]<br>            <span class="hljs-keyword">if</span> i <span class="hljs-keyword">and</span> x == nums[i - <span class="hljs-number">1</span>]:<br>                <span class="hljs-keyword">continue</span>  <span class="hljs-comment"># ä¼˜åŒ–ä¸‰ æ’åºåçš„å¸¸è§çš„ä¼˜åŒ–æ–¹æ³•, å¦‚æœæ’åºå,æœ‰ä¸¤ä¸ªæ•°ç›¸äº’ä¸´è¿‘åˆ™å¿…ä¸å¯èƒ½è¾“å‡ºæ­£ç¡®çš„å€¼</span><br><br>            <span class="hljs-comment"># ä¼˜åŒ–ä¸€ å¦‚æœæ‰§è¡Œåˆ°äº†è¿™ä¸ªå€¼,åŒæ—¶åä¸‰ä¸ªæ•°ä¹‹å’Œæ¯”targetå¤§ é‚£ä¹ˆè¿™é‡Œæ˜¯æœ€æ¥è¿‘çš„å€¼</span><br>            s = x + nums[i + <span class="hljs-number">1</span>] + nums[i + <span class="hljs-number">2</span>]<br>            <span class="hljs-keyword">if</span> s &gt; target:  <span class="hljs-comment"># åé¢æ— è®ºæ€ä¹ˆé€‰ï¼Œé€‰å‡ºçš„ä¸‰ä¸ªæ•°çš„å’Œä¸ä¼šæ¯” s è¿˜å°</span><br>                <span class="hljs-keyword">if</span> s - target &lt; min_diff:<br>                    ans = s  <span class="hljs-comment"># ç”±äºä¸‹ä¸€è¡Œç›´æ¥ breakï¼Œè¿™é‡Œæ— éœ€æ›´æ–° min_diff</span><br>                <span class="hljs-keyword">break</span><br><br>            <span class="hljs-comment"># ä¼˜åŒ–äºŒ</span><br>            s = x + nums[-<span class="hljs-number">2</span>] + nums[-<span class="hljs-number">1</span>]<br>            <span class="hljs-keyword">if</span> s &lt; target:  <span class="hljs-comment"># x åŠ ä¸Šåé¢ä»»æ„ä¸¤ä¸ªæ•°éƒ½ä¸è¶…è¿‡ sï¼Œæ‰€ä»¥ä¸‹é¢çš„åŒæŒ‡é’ˆå°±ä¸éœ€è¦è·‘äº†</span><br>                <span class="hljs-keyword">if</span> target - s &lt; min_diff:<br>                    min_diff = target - s<br>                    ans = s<br>                <span class="hljs-keyword">continue</span><br><br>            <span class="hljs-comment"># åŒæŒ‡é’ˆ å…¸ä¸­å…¸ä¹‹åŒæŒ‡é’ˆ</span><br>            j, k = i + <span class="hljs-number">1</span>, n - <span class="hljs-number">1</span><br>            <span class="hljs-keyword">while</span> j &lt; k:<br>                s = x + nums[j] + nums[k]<br>                <span class="hljs-keyword">if</span> s == target:<br>                    <span class="hljs-keyword">return</span> s<br>                <span class="hljs-keyword">if</span> s &gt; target:<br>                    <span class="hljs-keyword">if</span> s - target &lt; min_diff:  <span class="hljs-comment"># s ä¸ target æ›´è¿‘</span><br>                        min_diff = s - target<br>                        ans = s<br>                    k -= <span class="hljs-number">1</span><br>                <span class="hljs-keyword">else</span>:  <span class="hljs-comment"># s &lt; target</span><br>                    <span class="hljs-keyword">if</span> target - s &lt; min_diff:  <span class="hljs-comment"># s ä¸ target æ›´è¿‘</span><br>                        min_diff = target - s<br>                        ans = s<br>                    j += <span class="hljs-number">1</span><br>        <span class="hljs-keyword">return</span> ans<br><br></code></pre></td></tr></table></figure><h3 id="å››æ•°ä¹‹å’Œ"><a href="#å››æ•°ä¹‹å’Œ" class="headerlink" title="å››æ•°ä¹‹å’Œ"></a>å››æ•°ä¹‹å’Œ</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">fourSum</span>(<span class="hljs-params">self, nums: <span class="hljs-type">List</span>[<span class="hljs-built_in">int</span>], target: <span class="hljs-built_in">int</span></span>) -&gt; <span class="hljs-type">List</span>[<span class="hljs-type">List</span>[<span class="hljs-built_in">int</span>]]:<br>        quadruplets = <span class="hljs-built_in">list</span>()<br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> nums <span class="hljs-keyword">or</span> <span class="hljs-built_in">len</span>(nums) &lt; <span class="hljs-number">4</span>:<br>            <span class="hljs-keyword">return</span> quadruplets<br>        <br>        nums.sort()<br>        length = <span class="hljs-built_in">len</span>(nums)<br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(length - <span class="hljs-number">3</span>):<br>            <span class="hljs-keyword">if</span> i &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">and</span> nums[i] == nums[i - <span class="hljs-number">1</span>]:<br>                <span class="hljs-keyword">continue</span><br>            <span class="hljs-keyword">if</span> nums[i] + nums[i + <span class="hljs-number">1</span>] + nums[i + <span class="hljs-number">2</span>] + nums[i + <span class="hljs-number">3</span>] &gt; target:<br>                <span class="hljs-keyword">break</span><br>            <span class="hljs-keyword">if</span> nums[i] + nums[length - <span class="hljs-number">3</span>] + nums[length - <span class="hljs-number">2</span>] + nums[length - <span class="hljs-number">1</span>] &lt; target:<br>                <span class="hljs-keyword">continue</span><br>            <br>            <span class="hljs-comment">#ç®€å•çš„ä¼˜åŒ– </span><br><br>            <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(i + <span class="hljs-number">1</span>, length - <span class="hljs-number">2</span>):<br>                <span class="hljs-keyword">if</span> j &gt; i + <span class="hljs-number">1</span> <span class="hljs-keyword">and</span> nums[j] == nums[j - <span class="hljs-number">1</span>]:<br>                    <span class="hljs-keyword">continue</span><br>                <span class="hljs-keyword">if</span> nums[i] + nums[j] + nums[j + <span class="hljs-number">1</span>] + nums[j + <span class="hljs-number">2</span>] &gt; target:<br>                    <span class="hljs-keyword">break</span><br>                <span class="hljs-keyword">if</span> nums[i] + nums[j] + nums[length - <span class="hljs-number">2</span>] + nums[length - <span class="hljs-number">1</span>] &lt; target:<br>                    <span class="hljs-keyword">continue</span><br>                left, right = j + <span class="hljs-number">1</span>, length - <span class="hljs-number">1</span><br>                <span class="hljs-keyword">while</span> left &lt; right:<br>                    total = nums[i] + nums[j] + nums[left] + nums[right]<br>                    <span class="hljs-keyword">if</span> total == target:<br>                        quadruplets.append([nums[i], nums[j], nums[left], nums[right]])<br>                        <span class="hljs-keyword">while</span> left &lt; right <span class="hljs-keyword">and</span> nums[left] == nums[left + <span class="hljs-number">1</span>]:<br>                            left += <span class="hljs-number">1</span><br>                        left += <span class="hljs-number">1</span><br>                        <span class="hljs-keyword">while</span> left &lt; right <span class="hljs-keyword">and</span> nums[right] == nums[right - <span class="hljs-number">1</span>]:<br>                            right -= <span class="hljs-number">1</span><br>                        right -= <span class="hljs-number">1</span><br>                    <span class="hljs-keyword">elif</span> total &lt; target:<br>                        left += <span class="hljs-number">1</span><br>                    <span class="hljs-keyword">else</span>:<br>                        right -= <span class="hljs-number">1</span><br>        <br>        <span class="hljs-keyword">return</span> quadruplets<br></code></pre></td></tr></table></figure><h3 id="å­—æ¯å¼‚ä½è¯åˆ†ç»„"><a href="#å­—æ¯å¼‚ä½è¯åˆ†ç»„" class="headerlink" title="å­—æ¯å¼‚ä½è¯åˆ†ç»„"></a>å­—æ¯å¼‚ä½è¯åˆ†ç»„</h3><p>ç»™ä½ ä¸€ä¸ªå­—ç¬¦ä¸²æ•°ç»„ï¼Œè¯·ä½ å°† å­—æ¯å¼‚ä½è¯ ç»„åˆåœ¨ä¸€èµ·ã€‚å¯ä»¥æŒ‰ä»»æ„é¡ºåºè¿”å›ç»“æœåˆ—è¡¨ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python"><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">groupAnagrams</span>(<span class="hljs-params">self, strs: <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>]</span>) -&gt; <span class="hljs-type">List</span>[<span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>]]:<br>        a=&#123;&#125;<br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> strs:<br>            i_=<span class="hljs-string">&#x27;&#x27;</span>.join(<span class="hljs-built_in">sorted</span>(i))<span class="hljs-comment">#å†…éƒ¨çš„å­—ç¬¦ä¸²æ’åº??? æœ‰ç‚¹æŠ½è±¡äº†</span><br>            <span class="hljs-keyword">if</span> i_ <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> a:<br>                a[i_]=[i]<br>            <span class="hljs-keyword">else</span>:<br>                a[i_].append(i) <span class="hljs-comment">#å­˜å…¥i åˆç†çš„, ä½†æ˜¯æŠ½è±¡</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">list</span>(a.values())<br><br></code></pre></td></tr></table></figure><h3 id="åˆå¹¶ç›¸å…³çš„åŒºé—´"><a href="#åˆå¹¶ç›¸å…³çš„åŒºé—´" class="headerlink" title="åˆå¹¶ç›¸å…³çš„åŒºé—´"></a>åˆå¹¶ç›¸å…³çš„åŒºé—´</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">merge</span>(<span class="hljs-params">self, intervals: <span class="hljs-type">List</span>[<span class="hljs-type">List</span>[<span class="hljs-built_in">int</span>]]</span>) -&gt; <span class="hljs-type">List</span>[<span class="hljs-type">List</span>[<span class="hljs-built_in">int</span>]]:<br><br>        intervals.sort(key=<span class="hljs-keyword">lambda</span> x: x[<span class="hljs-number">0</span>]) <span class="hljs-comment">#æ’åºçš„å…³é”®å‡½æ•° è¿™é‡Œä¹Ÿå°±æ˜¯æŠŠleftè¿›è¡Œæ’åˆ—</span><br><br>        merged = []<br>        <span class="hljs-keyword">for</span> interval <span class="hljs-keyword">in</span> intervals:<br>            <span class="hljs-comment"># å¦‚æœåˆ—è¡¨ä¸ºç©ºï¼Œæˆ–è€…å½“å‰åŒºé—´ä¸ä¸Šä¸€åŒºé—´ä¸é‡åˆï¼Œç›´æ¥æ·»åŠ </span><br>            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> merged <span class="hljs-keyword">or</span> merged[-<span class="hljs-number">1</span>][<span class="hljs-number">1</span>] &lt; interval[<span class="hljs-number">0</span>]:<br>                merged.append(interval)<br>            <span class="hljs-keyword">else</span>:<br>                <span class="hljs-comment"># å¦åˆ™çš„è¯ï¼Œæˆ‘ä»¬å°±å¯ä»¥ä¸ä¸Šä¸€åŒºé—´è¿›è¡Œåˆå¹¶</span><br>                merged[-<span class="hljs-number">1</span>][<span class="hljs-number">1</span>] = <span class="hljs-built_in">max</span>(merged[-<span class="hljs-number">1</span>][<span class="hljs-number">1</span>], interval[<span class="hljs-number">1</span>])<br><br>        <span class="hljs-keyword">return</span> merged<br><br></code></pre></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>leetcode</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>NLP&amp;&amp;LLM</title>
    <link href="/2023/08/20/NLP/"/>
    <url>/2023/08/20/NLP/</url>
    
    <content type="html"><![CDATA[<h2 id="BASE"><a href="#BASE" class="headerlink" title="BASE"></a>BASE</h2><p>å‚è€ƒé“¾æ¥ <a href="https://huggingface.co/learn/nlp-course/">NLP_course</a></p><h3 id="unigram-tokenization"><a href="#unigram-tokenization" class="headerlink" title="unigram tokenization"></a>unigram tokenization</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs python"><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">encode_word</span>(<span class="hljs-params">word, model</span>):<br>    best_segmentations = [&#123;<span class="hljs-string">&quot;start&quot;</span>: <span class="hljs-number">0</span>, <span class="hljs-string">&quot;score&quot;</span>: <span class="hljs-number">1</span>&#125;] + [<br>        &#123;<span class="hljs-string">&quot;start&quot;</span>: <span class="hljs-literal">None</span>, <span class="hljs-string">&quot;score&quot;</span>: <span class="hljs-literal">None</span>&#125; <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(word))<br>    ]<br>    <span class="hljs-comment">#è‡³å°‘æ¯ä¸€ç§å­—é•¿éƒ½æœ‰ç•™ä¸‹æ¥å¯¹åº”çš„ä¸€ä¸ªå€¼.åŒæ—¶åœ¨ä½æ¬¡ä¸Šå¯¹åº”END,é‡Œé¢çš„startå¯¹åº”äº†åœ¨è¿™ä¸ªENDä¸­,åœ¨å“ªé‡Œæœ‰æœ€å¥½çš„åˆ†è¯çš„æ–¹æ³•.</span><br>    <span class="hljs-keyword">for</span> start_idx <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(word)):<br>        <span class="hljs-comment"># This should be properly filled by the previous steps of the loop</span><br>        best_score_at_start = best_segmentations[start_idx][<span class="hljs-string">&quot;score&quot;</span>]<br>        <span class="hljs-keyword">for</span> end_idx <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(start_idx + <span class="hljs-number">1</span>, <span class="hljs-built_in">len</span>(word) + <span class="hljs-number">1</span>):<br>            token = word[start_idx:end_idx] <span class="hljs-comment"># tokeæˆªå–äº†ä¸€ç»„å€¼,ä¹‹åé€šè¿‡æŸ¥è¡¨è¿›è¡Œæ¯”è¾ƒ</span><br>            <span class="hljs-keyword">if</span> token <span class="hljs-keyword">in</span> model <span class="hljs-keyword">and</span> best_score_at_start <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>                score = model[token] + best_score_at_start<br>                <span class="hljs-comment"># If we have found a better segmentation ending at end_idx, we update</span><br>                <span class="hljs-keyword">if</span> (<br>                    best_segmentations[end_idx][<span class="hljs-string">&quot;score&quot;</span>] <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span><br>                    <span class="hljs-keyword">or</span> best_segmentations[end_idx][<span class="hljs-string">&quot;score&quot;</span>] &gt; score<br>                ):<br>                <span class="hljs-comment">#è¿™é‡Œå–çš„æ˜¯-logç›¸å½“äºæ˜¯ä¸€ä¸ªé€’å‡çš„å‡½æ•°,å¦‚æœé¢‘ç‡é«˜,åè€Œå¾—åˆ°çš„å€¼è¶Šä½,æ‰€ä»¥è¿™é‡Œé€‰æ‹©é«˜é¢‘ç‡çš„ç•™ä¸‹,</span><br>                <span class="hljs-comment">#å…³äºç»§æ‰¿å‰é¢çš„å€¼,è¿™é‡Œçš„å«ä¹‰æŒ‡çš„æ˜¯:start endéƒ½å«æœ‰ä¸€å®šçš„å€¼,startçš„åˆ†è¯+æ–°å¢çš„è¯å—é¢‘ç‡å¤Ÿé«˜çš„æƒ…å†µæ‰æ›´æ–°ENDçš„æ¨¡å—</span><br>                <span class="hljs-comment">#ä¸‹é¢å¯¹åº”äº†ä¸¤ç§æƒ…å†µ,ä¸€ç§æ˜¯åç»­æ²¡æœ‰end_idxç›´æ¥æ‰“ä¸Šæ ‡ç­¾ å¦ä¸€ç§æ˜¯åœ¨å½“å‰çš„start + å¢çš„ æ¯”åç»­çš„ä½åˆ™æ›´æ”¹??</span><br>                    best_segmentations[end_idx] = &#123;<span class="hljs-string">&quot;start&quot;</span>: start_idx, <span class="hljs-string">&quot;score&quot;</span>: score&#125;<br><br>    segmentation = best_segmentations[-<span class="hljs-number">1</span>]<br>    <span class="hljs-keyword">if</span> segmentation[<span class="hljs-string">&quot;score&quot;</span>] <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>        <span class="hljs-comment"># We did not find a tokenization of the word -&gt; unknown</span><br>        <span class="hljs-keyword">return</span> [<span class="hljs-string">&quot;&lt;unk&gt;&quot;</span>], <span class="hljs-literal">None</span><br><br>    score = segmentation[<span class="hljs-string">&quot;score&quot;</span>]<br>    start = segmentation[<span class="hljs-string">&quot;start&quot;</span>]<br>    end = <span class="hljs-built_in">len</span>(word)<br>    tokens = []<br>    <span class="hljs-keyword">while</span> start != <span class="hljs-number">0</span>:<br>        tokens.insert(<span class="hljs-number">0</span>, word[start:end])<br>        next_start = best_segmentations[start][<span class="hljs-string">&quot;start&quot;</span>]<br>        end = start<br>        start = next_start<br>    tokens.insert(<span class="hljs-number">0</span>, word[start:end])<br>    <span class="hljs-keyword">return</span> tokens, score<br><span class="hljs-comment"># ä½†æ˜¯ä¸ºä»€ä¹ˆæ˜¯æœ€åçš„ä¸€ä¸ª?</span><br></code></pre></td></tr></table></figure><h2 id="MAIN-NLP-TASKS"><a href="#MAIN-NLP-TASKS" class="headerlink" title="MAIN NLP TASKS"></a>MAIN NLP TASKS</h2><h3 id="Token-classification"><a href="#Token-classification" class="headerlink" title="Token classification"></a>Token classification</h3><h4 id="preparing-the-data"><a href="#preparing-the-data" class="headerlink" title="preparing the data"></a>preparing the data</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> datasets <span class="hljs-keyword">import</span> load_dataset<br>raw_datasets = load_dataset(<span class="hljs-string">&quot;conll2003&quot;</span>)<br><br><span class="hljs-comment"># æ•°æ®å½¢å¼</span><br><br>DatasetDict(&#123;<br>    train: Dataset(&#123;<br>        features: [<span class="hljs-string">&#x27;chunk_tags&#x27;</span>, <span class="hljs-string">&#x27;id&#x27;</span>, <span class="hljs-string">&#x27;ner_tags&#x27;</span>, <span class="hljs-string">&#x27;pos_tags&#x27;</span>, <span class="hljs-string">&#x27;tokens&#x27;</span>],<br>        num_rows: <span class="hljs-number">14041</span><br>    &#125;)<br>    validation: Dataset(&#123;<br>        features: [<span class="hljs-string">&#x27;chunk_tags&#x27;</span>, <span class="hljs-string">&#x27;id&#x27;</span>, <span class="hljs-string">&#x27;ner_tags&#x27;</span>, <span class="hljs-string">&#x27;pos_tags&#x27;</span>, <span class="hljs-string">&#x27;tokens&#x27;</span>],<br>        num_rows: <span class="hljs-number">3250</span><br>    &#125;)<br>    test: Dataset(&#123;<br>        features: [<span class="hljs-string">&#x27;chunk_tags&#x27;</span>, <span class="hljs-string">&#x27;id&#x27;</span>, <span class="hljs-string">&#x27;ner_tags&#x27;</span>, <span class="hljs-string">&#x27;pos_tags&#x27;</span>, <span class="hljs-string">&#x27;tokens&#x27;</span>],<br>        num_rows: <span class="hljs-number">3453</span><br>    &#125;)<br>&#125;)<br><span class="hljs-comment">#the last column is called tokens, but it contains words in the sense that these are pre-tokenized inputs that still need to go through the tokenizer for subword tokenization</span><br><br><span class="hljs-comment"># æ•°æ®å½¢å¼</span><br>ner_feature = raw_datasets[<span class="hljs-string">&quot;train&quot;</span>].features[<span class="hljs-string">&quot;ner_tags&quot;</span>]<br><br><span class="hljs-type">Sequence</span>(feature=ClassLabel(num_classes=<span class="hljs-number">9</span>, names=[<span class="hljs-string">&#x27;O&#x27;</span>, <span class="hljs-string">&#x27;B-PER&#x27;</span>, <span class="hljs-string">&#x27;I-PER&#x27;</span>, <span class="hljs-string">&#x27;B-ORG&#x27;</span>, <span class="hljs-string">&#x27;I-ORG&#x27;</span>, <span class="hljs-string">&#x27;B-LOC&#x27;</span>, <span class="hljs-string">&#x27;I-LOC&#x27;</span>, <span class="hljs-string">&#x27;B-MISC&#x27;</span>, <span class="hljs-string">&#x27;I-MISC&#x27;</span>], names_file=<span class="hljs-literal">None</span>, <span class="hljs-built_in">id</span>=<span class="hljs-literal">None</span>), length=-<span class="hljs-number">1</span>, <span class="hljs-built_in">id</span>=<span class="hljs-literal">None</span>)<br><br><span class="hljs-comment"># è¡¨ç¤ºè¿™é‡Œçš„è®­ç»ƒé˜Ÿåˆ—çš„ç±»å‹</span><br></code></pre></td></tr></table></figure><p>è§£æ„æ•°æ®è¡¨ç¤º</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python"><br>words = raw_datasets[<span class="hljs-string">&quot;train&quot;</span>][<span class="hljs-number">0</span>][<span class="hljs-string">&quot;tokens&quot;</span>]<br>labels = raw_datasets[<span class="hljs-string">&quot;train&quot;</span>][<span class="hljs-number">0</span>][<span class="hljs-string">&quot;ner_tags&quot;</span>]<br>line1 = <span class="hljs-string">&quot;&quot;</span><br>line2 = <span class="hljs-string">&quot;&quot;</span><br><span class="hljs-keyword">for</span> word, label <span class="hljs-keyword">in</span> <span class="hljs-built_in">zip</span>(words, labels):<span class="hljs-comment">#ä¸ä»…å–å‡ºäº†ä¸¤ä¸ªåˆ—è¡¨ä¸­çš„å…ƒç´ ,åŒæ—¶æŠŠè¿™ä¸¤ä¸ªå¯¹åº”çš„æ•°ç»„å‹ç¼©æˆå…ƒç»„</span><br>    full_label = label_names[label]<br>    max_length = <span class="hljs-built_in">max</span>(<span class="hljs-built_in">len</span>(word), <span class="hljs-built_in">len</span>(full_label))<br>    line1 += word + <span class="hljs-string">&quot; &quot;</span> * (max_length - <span class="hljs-built_in">len</span>(word) + <span class="hljs-number">1</span>)<br>    line2 += full_label + <span class="hljs-string">&quot; &quot;</span> * (max_length - <span class="hljs-built_in">len</span>(full_label) + <span class="hljs-number">1</span>)<br></code></pre></td></tr></table></figure><h4 id="æ•°æ®åŠ å·¥"><a href="#æ•°æ®åŠ å·¥" class="headerlink" title="æ•°æ®åŠ å·¥"></a>æ•°æ®åŠ å·¥</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> transformers <span class="hljs-keyword">import</span> AutoTokenizer<br><br>model_checkpoint = <span class="hljs-string">&quot;bert-base-cased&quot;</span><br>tokenizer = AutoTokenizer.from_pretrained(model_checkpoint)<br><br>inputs = tokenizer(raw_dataset[<span class="hljs-string">&quot;train&quot;</span>][<span class="hljs-number">0</span>][<span class="hljs-string">&quot;tokens&quot;</span>],is_split_into_words = <span class="hljs-literal">True</span>)<br><br>inputs.word_ids()<span class="hljs-comment">#å¯ä»¥æ­£ç¡®çš„å¯¹é½æ¯ä¸€ä¸ªtokensçš„å•è¯çš„ä½ç½®</span><br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#è¿™ä¸ªå‡½æ•°ç›¸å½“äºåˆ†è£‚åŒæ—¶æ‰“ä¸Šæ ‡ç­¾</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">align_labels_with_tokens</span>(<span class="hljs-params">labels,word_ids</span>):<br>    <span class="hljs-comment">#labelsæ˜¯æ¥è‡ªäºner_tags</span><br>    new_labels = []<br>    current_word = <span class="hljs-literal">None</span><br>    <span class="hljs-keyword">for</span> word_id <span class="hljs-keyword">in</span> word_ids:<br>        <span class="hljs-keyword">if</span> word_id != current_word:<span class="hljs-comment">#åŒºåˆ†æ˜¯å¦æ˜¯ä¸€ä¸ªæ–°çš„å•è¯</span><br>            current_word = word_id<br>            label = -<span class="hljs-number">100</span> <span class="hljs-keyword">if</span> word_id <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">else</span> labels[word_id]<br>            new_labels.append(label)<span class="hljs-comment">#æ”¾å…¥æ–°çš„label</span><br>        <span class="hljs-keyword">elif</span> word_id = <span class="hljs-literal">None</span>:<br>            new_labels.append(-<span class="hljs-number">100</span>)<br>        <span class="hljs-keyword">else</span>:<br>            label = labels[word_id]<span class="hljs-comment">#æ˜¯åœ¨å½“å‰çš„labelsä¸­</span><br>            <span class="hljs-keyword">if</span> label % <span class="hljs-number">2</span> == <span class="hljs-number">1</span>:<br>                label += <span class="hljs-number">1</span> <span class="hljs-comment">#ç›¸å½“äºæŠŠBä¸­çš„å€¼è½¬æ¢ä¸ºI,å¦‚æœæ˜¯åŒä¸€ä¸ªå•è¯çš„æƒ…å†µä¸‹</span><br>            new_labels.append(label)<br>    <span class="hljs-keyword">return</span> new_labels<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">tokenize_and_align_labels</span>(<span class="hljs-params">examples</span>):<br>    tokenized_inputs = tokenizer(examples[<span class="hljs-string">&quot;tokens&quot;</span>],truncation = <span class="hljs-literal">True</span>, is_split_into_words =<span class="hljs-literal">True</span>)<br>    all_labels = example[<span class="hljs-string">&quot;ner_tags&quot;</span>]<br>    new_labels = []<br>    <span class="hljs-keyword">for</span> i,labels <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(all_labels):<br>        word_ids = tokenized_inputs.word_ids(i)<br>        new_labels.append(align_labels_with_tokens(labels,word_ids))<br>    <br>    tokenized_input[<span class="hljs-string">&quot;labels&quot;</span>] = new_labels<br>    <span class="hljs-keyword">return</span> tokenized_inputs<br><br><span class="hljs-comment">#è¿™é‡ŒåŸºæœ¬ç›¸å½“äºæ˜¯åœ¨ä¸‹é¢è¿›è¡Œäº†è°ƒç”¨,ä½†æ˜¯è¿™é‡Œä»ç„¶æ²¡æœ‰å®ŒæˆæŠŠæ‰€æœ‰çš„å¯¹é½é™„å¸¦ä¸Špadding</span><br><br><span class="hljs-comment">#ä»¥ä¸‹å®Œæˆæ•°æ®é›†çš„è®­ç»ƒ</span><br>tokenized_datasets = raw_datasets.<span class="hljs-built_in">map</span>(<br>    tokenize_and_align_labels,<span class="hljs-comment">#è¿™é‡Œçš„åŸç†åº”è¯¥ç›¸å½“äºç›´æ¥æŠŠè¿™ä¸ªrawæ•°æ®é›†ä¼ å…¥è¿›å»,ç„¶åç›´æ¥ä¾ç…§ç›¸å…³çš„å‡½æ•°è¿›è¡Œè¾“å‡º</span><br>    batched = <span class="hljs-literal">True</span>,<br>    remove_columns = raw_datasets[<span class="hljs-string">&quot;train&quot;</span>].column_names,<span class="hljs-comment">#è¿™é‡Œç›¸å½“äºæŠŠè®­ç»ƒåçš„è¿™ä¸€åˆ—åˆ é™¤æ‰</span><br>)<br><br></code></pre></td></tr></table></figure><h4 id="Fine-tuning-the-modle-with-trainer-API"><a href="#Fine-tuning-the-modle-with-trainer-API" class="headerlink" title="Fine-tuning the modle with trainer API"></a>Fine-tuning the modle with trainer API</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> transformers <span class="hljs-keyword">import</span> DataCollatorForTokenClassification<br>data_collator = DataClollatorForTokenClassification(tokenizer = tokenizer)<br><span class="hljs-comment">#è¿™é‡Œæ²¡æœ‰å¯¹é½çš„å€¼é»˜è®¤æ‰“ä¸Šäº†-100çš„æ ‡ç­¾</span><br></code></pre></td></tr></table></figure><h4 id="Metrics-åº¦é‡æŒ‡æ ‡"><a href="#Metrics-åº¦é‡æŒ‡æ ‡" class="headerlink" title="Metrics åº¦é‡æŒ‡æ ‡"></a>Metrics åº¦é‡æŒ‡æ ‡</h4><p>åˆ©ç”¨seqevalè¿›è¡Œåº¦é‡è¯¥æŒ‡æ ‡</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> evalutate<br>metric = evaluate.load(<span class="hljs-string">&quot;seqeval&quot;</span>)<br><br>labels = raw_datasets[<span class="hljs-string">&quot;train&quot;</span>][<span class="hljs-number">0</span>][<span class="hljs-string">&quot;ner_tags&quot;</span>]<br>labels = [label_names[i] <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> labels]<br><span class="hljs-comment">#è¿™é‡Œç›¸å½“äºæŠŠåŸå…ˆçš„åç§»å¯»å€è½¬æ¢æˆäº†æ­£å¸¸çš„å¯è¯»å…¥å­—ç¬¦ä¸²çš„å½¢å¼</span><br>predictions = labels.copy()<br>predictions[<span class="hljs-number">2</span>] = <span class="hljs-string">&quot;0&quot;</span><br>metric.compute(predictions= [predictions],reference = [labels])<br></code></pre></td></tr></table></figure><p>è®¡ç®—åº¦é‡å‡½æ•°<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">compute_metrcis</span>(<span class="hljs-params">eval_preds</span>):<br>    logis,labels = eval_preds<br>    predictions = np.argmax(logits,axis =-<span class="hljs-number">1</span>)<span class="hljs-comment">#true æ˜¯çœŸçš„å€¼,predictionæ˜¯ä¸€ä¸ªä»¥è®­ç»ƒç»“æœå¯¼å‡ºæ¥çš„å€¼</span><br>    true_labels = [[label_namse[l] <span class="hljs-keyword">for</span> l <span class="hljs-keyword">in</span> label <span class="hljs-keyword">if</span> l != -<span class="hljs-number">100</span>] <span class="hljs-keyword">for</span> label <span class="hljs-keyword">in</span> labels] <span class="hljs-comment"># å•¥?</span><br>    true_predictions = [ [label_name[p] <span class="hljs-keyword">for</span> (p,l) <span class="hljs-keyword">in</span> <span class="hljs-built_in">zip</span>(prediction,label) <span class="hljs-keyword">if</span> l != -<span class="hljs-number">100</span>] <span class="hljs-keyword">for</span> prediction,label <span class="hljs-keyword">in</span> <span class="hljs-built_in">zip</span>(predictions,labels)]<br>    all_metrics = metrci.compute(predictions = ture_predictions, references = true_labels)<br><br></code></pre></td></tr></table></figure></p><h4 id="defining-the-Model"><a href="#defining-the-Model" class="headerlink" title="defining the Model"></a>defining the Model</h4><p>è®¾ç½®ä¸€ä¸ªç›¸åçš„å­—å…¸<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python">id2label = &#123;i:label <span class="hljs-keyword">for</span> i, label <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(label_names)&#125;<br>lable2id = &#123;v,k <span class="hljs-keyword">for</span> k,v <span class="hljs-keyword">in</span> id2label.items()&#125;<br></code></pre></td></tr></table></figure><br>åœ¨ä¼ å…¥ç›¸å…³çš„æ¨¡å‹<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> transformers <span class="hljs-keyword">import</span> AutoModelForTokenClassification<br>model = AutoModelForTokenClassification.from_pretrained(<br>    model_checkpoint,<br>    id2label = id2label<br>    label2id = label2id<br>)<br></code></pre></td></tr></table></figure></p><h4 id="Fine-tuning-the-model"><a href="#Fine-tuning-the-model" class="headerlink" title="Fine-tuning the model"></a>Fine-tuning the model</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> huggingface_hub <span class="hljs-keyword">import</span> notebook_login<br>notebook_login()<br><span class="hljs-comment">#è°ƒç”¨è®­ç»ƒå‚æ•°</span><br><span class="hljs-keyword">from</span> transformes <span class="hljs-keyword">import</span> TrainingArguments<br>args = TrainingArguments(<br>    <span class="hljs-string">&quot;bert-finetune-ner&quot;</span>,<br>    evaluation_strategy = <span class="hljs-string">&quot;epoch&quot;</span>,<br>    save_strategy = <span class="hljs-string">&quot;epoch&quot;</span>,<br>    learning_rate = <span class="hljs-number">2e05</span>,<br>    num_train_epochs= <span class="hljs-number">3</span><br>    weight_decay= <span class="hljs-number">0.01</span>.<br>    push_to_hub = <span class="hljs-literal">True</span>,<br>)<br><span class="hljs-comment">#æ„å»ºä¸€ä¸ªtrainer</span><br><span class="hljs-keyword">from</span>  transformers <span class="hljs-keyword">import</span> Trainer<br><br>trainer = Trainer(<br>    model = model,<br>    args =args,<br>    train_dataset = tokenized_datasets[<span class="hljs-string">&quot;train&quot;</span>],<br>    eval_dataset = tokenized_datasets[<span class="hljs-string">&quot;validation&quot;</span>],<br>    data_collator = data_collator,<br>    compyte_metrics= compute_metrics,<br>    tokenizer = tokenizer,<br>)<br>trainer.train()<br>trainer.push_to_hub(commit_message= <span class="hljs-string">&quot;Training complete&quot;</span>)<br></code></pre></td></tr></table></figure><p>ä»¥ä¸Šçš„æ¨¡å‹åœ¨æ¯ä¸€æ¬¡è®­ç»ƒçš„æ—¶å€™,éƒ½ä¼šä¸Šä¼ åˆ°hubä¸­</p><h4 id="ä¼ ç»Ÿçš„è®­ç»ƒæµç¨‹ä¸¾ä¾‹"><a href="#ä¼ ç»Ÿçš„è®­ç»ƒæµç¨‹ä¸¾ä¾‹" class="headerlink" title="ä¼ ç»Ÿçš„è®­ç»ƒæµç¨‹ä¸¾ä¾‹"></a>ä¼ ç»Ÿçš„è®­ç»ƒæµç¨‹ä¸¾ä¾‹</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> torch.utils.data <span class="hljs-keyword">import</span> DataLoader<br><br>train_dataloader = DataLoader(<br>    tokenized_datasets[<span class="hljs-string">&quot;train&quot;</span>],<br>    shuffle = <span class="hljs-literal">True</span>,<br>    collate_fn = data_collator,<br>    batch_size = <span class="hljs-number">8</span>,<br><br>)<br>eval_dataloader = DataLoader(<br>    tokenized_datasets[<span class="hljs-string">&quot;validation&quot;</span>],<br>    collate_fn= data_collator,<br>    batch_size = <span class="hljs-number">8</span><br>)<br><br><span class="hljs-comment">#æ„å»ºæ¨¡å‹</span><br><br>model = AutoModelForTokenXlassification.from_pretrained(<br>    model_checkpoint,<br>    id2label = id2label,<br>    label2id  = label2id,<br>)<br><br><span class="hljs-keyword">from</span> torch.optim <span class="hljs-keyword">import</span> AdamW<br>optimizer = AdamW(model.parameters(),lr= <span class="hljs-number">2e-5</span>)<br><br><span class="hljs-comment">#åŠ é€Ÿå™¨æ¨¡å—</span><br><br><span class="hljs-keyword">from</span> accelerate <span class="hljs-keyword">import</span> Accelerator<br>accelerator = Accelerator()<br>modle,optimizer,train_dataloader,eval_dataloader = accelerator.prepare(<br>    modle,optimizer,train_dataloader,eval_dataloader<br>)<br><br><span class="hljs-comment">#???</span><br><span class="hljs-keyword">from</span> transformers <span class="hljs-keyword">import</span> get_scheduler<br>num_train_epochs = <span class="hljs-number">3</span><br>num_update_steps_per_epoch = <span class="hljs-built_in">len</span>(train_dataloader)<br>num_training_steps = num_train_epochs * num_update_steps_per_epoch <span class="hljs-comment">#å…¨éƒ¨è®­ç»ƒå®Œçš„epoch</span><br>lr_scheduler = get_scheduler(<br>    <span class="hljs-string">&quot;linear&quot;</span>,<br>    optimizer = optimizer.<br>    num_warmup_steps = <span class="hljs-number">0</span>,<br>    num_training_steps = num_training_steps<br>)<br><br></code></pre></td></tr></table></figure><h4 id="ä¸Šä¼ åˆ°ä»“åº“"><a href="#ä¸Šä¼ åˆ°ä»“åº“" class="headerlink" title="ä¸Šä¼ åˆ°ä»“åº“"></a>ä¸Šä¼ åˆ°ä»“åº“</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> huggingface_hub <span class="hljs-keyword">import</span> Repository,get_full_repo_name<br>model_name = <span class="hljs-string">&quot;bert-finetune-ner-accelerate&quot;</span><br>repo_name = get_full_repo_name(model_name)<span class="hljs-comment">#åŠ ä¸ŠåŸæ¥çš„åœ°å€.</span><br><br></code></pre></td></tr></table></figure><h4 id="Train-loop"><a href="#Train-loop" class="headerlink" title="Train loop"></a>Train loop</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs python"><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">postprocess</span>(<span class="hljs-params">predictions,labels</span>):<br>    predictions = predictions.detach().cpu().clone().numpy()<br>    labels = labels.detach().cpu().clone().numpy()<br>    <span class="hljs-comment">#ä»GPUä¸­æ‹·è´æ•°æ®å¹¶è½¬æ¢ä¸ºnumpyæ•°æ®</span><br><br>    true_labels = [ [label_names[l] <span class="hljs-keyword">for</span> l <span class="hljs-keyword">in</span> label <span class="hljs-keyword">if</span> l != <span class="hljs-number">100</span>] <span class="hljs-keyword">for</span> label <span class="hljs-keyword">in</span> labels]<br>    true_predictions = [ [label_names[p] <span class="hljs-keyword">for</span> (p,l) <span class="hljs-keyword">in</span> <span class="hljs-built_in">zip</span>(prediction,label) <span class="hljs-keyword">if</span> l != -<span class="hljs-number">100</span>]<br>    <span class="hljs-keyword">for</span> prediction , label <span class="hljs-keyword">in</span> <span class="hljs-built_in">zip</span>(predictions, labels)]<br>    <span class="hljs-keyword">return</span> true_labels,true_predictions<br><br><span class="hljs-comment">#è®­ç»ƒä¸­</span><br><span class="hljs-keyword">from</span> tqdm.auto <span class="hljs-keyword">import</span> tqdm<br><span class="hljs-keyword">import</span> torch<br>progress_bar = tqdm((<span class="hljs-built_in">range</span>(num_training_steps)))<br><br><span class="hljs-keyword">for</span> epoch <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(num_train_epochs):<br>    model.train()<br>    <span class="hljs-keyword">for</span> batch <span class="hljs-keyword">in</span> train_dataloader:<br>        outputs = model(**batch)<br>        loss = outputs.loss<br>        accelerator.backward(loss)<br>        optimizer.step()<br>        lr_scheduler.step()<br>        optimizer.zero_grad()<br>        progress_bar.update(<span class="hljs-number">1</span>)<br>    <br>    model.<span class="hljs-built_in">eval</span>()<br>    <span class="hljs-keyword">for</span> batch <span class="hljs-keyword">in</span> eval_dataloader:<br>        <span class="hljs-keyword">with</span> torch.no_grad():<br>            outputs = model(**batch)<br>        <br>        predictions = outputs/logits.argmax(dim=-<span class="hljs-number">1</span>)<br>        labels = batch[<span class="hljs-string">&quot;labels&quot;</span>]<br></code></pre></td></tr></table></figure><p>éƒ¨åˆ†è·³è¿‡ğŸ¤£ğŸ‘‰ğŸ»ğŸ¤¡</p><h3 id="Fine-tuning-a-masked-language-model"><a href="#Fine-tuning-a-masked-language-model" class="headerlink" title="Fine-tuning a masked language model"></a>Fine-tuning a masked language model</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> transformers <span class="hljs-keyword">import</span> AutoModelForMaskedLM<br>model_checkpoint = <span class="hljs-string">&quot;distilbert-base-uncased&quot;</span><br>model = AutoModelForMaskedLM.from_pretrained(model_Checkpoint)<br><span class="hljs-keyword">from</span> transformers <span class="hljs-keyword">import</span> AutoTokenizer<br>tokenizer = AutoTokenizer.from_pretrained(model_checkpoint)<br><br><span class="hljs-keyword">import</span> torch<br>inputs = tokenizer(text,return_tensors= <span class="hljs-string">&quot;pt&quot;</span>)<span class="hljs-comment">#æŒ‰ç…§pytorchå¼ é‡è¾“å‡º</span><br>token_logits = modle(**inputs).logits<br>mask_token_index = torch.where(inputs[input_ids]== tokenizer.mask_token_id)[<span class="hljs-number">1</span>]<br>mask_token_logits = token_logits[<span class="hljs-number">0</span>,mask_token_index,:]<br>top_5_token = torch.topk(mask_token_logits,<span class="hljs-number">5</span>,dim = <span class="hljs-number">1</span>).indices[<span class="hljs-number">0</span>],tolist()<br><br><span class="hljs-keyword">from</span> datasets <span class="hljs-keyword">import</span> load_dataset<br><br>imdb_dataset = load_dataset(<span class="hljs-string">&quot;imdb&quot;</span>)<br>sample = imdb_dataset[<span class="hljs-string">&quot;train&quot;</span>].shuffle(seed=<span class="hljs-number">42</span>).select(<span class="hljs-built_in">range</span>(<span class="hljs-number">3</span>))<br><span class="hljs-comment">#æ³¨æ„å¯ä»¥é€šè¿‡æ•°æ®é›†çš„ç‰¹å®šéƒ¨åˆ†çš„.shuffleæ¥é€‰æ‹©æ‰“ä¹±æ•°æ®é›†</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">tokenize_function</span>(<span class="hljs-params">examples</span>):<br>    result = tokenizer(examples[<span class="hljs-string">&quot;text&quot;</span>])<br>    <span class="hljs-keyword">if</span> tokenizer.is_fast:<br>        result[<span class="hljs-string">&quot;word_ids&quot;</span>] = [result.word_ids(i) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(result[<span class="hljs-string">&quot;input_ids&quot;</span>]))] <span class="hljs-comment">#word_idsç›¸å½“äºåˆ†è¯å™¨æ˜ å°„åˆ°äº†ç¬¬å‡ ä¸ªå•è¯ä¸Šé¢ è¿™é‡Œç›¸å½“äºå¯¹äºä¸åŒçš„å¥å­ç»„å»ºç«‹äº†ä¸åŒçš„å€¼</span><br>    <span class="hljs-keyword">return</span> result<br><br>tokenizer.model_max_length <span class="hljs-comment"># åˆ†è¯å™¨æœ€å¤§çš„æ–‡æœ¬å®¹çº³é‡</span><br><br><span class="hljs-comment">#è¿é”</span><br>tokenized_samples = tokenized_datasets[<span class="hljs-string">&quot;train&quot;</span>][:<span class="hljs-number">3</span>]<br><span class="hljs-keyword">for</span> idx,sample <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(tokenized_samples[<span class="hljs-string">&quot;input_ids&quot;</span>]):<br>    <span class="hljs-built_in">print</span>(f <span class="hljs-string">&quot;&gt;&gt;&#123;ids&#125;&quot;</span>)<br><br><br>concatenated_examples = &#123;<br>    <span class="hljs-comment">#ä»¥ä¸‹ç›¸å½“äºæŠŠå¤šä¸ªä¸åŒçš„åˆ—è¡¨åˆæˆä¸ºä¸€ä¸ªå…±åŒçš„åˆ—è¡¨</span><br>    k:<span class="hljs-built_in">sum</span>(tokenized_samples[k],[]) <span class="hljs-keyword">for</span> k <span class="hljs-keyword">in</span> examples.keys()<span class="hljs-comment">#ç”Ÿæˆå­—å…¸çš„é”®çš„å€¼</span><br>&#125;<span class="hljs-comment"># kæ˜¯ä¸€ç³»åˆ—çš„é”®</span><br>total_length = <span class="hljs-built_in">len</span>(concatenated_examples[<span class="hljs-string">&quot;input_ids&quot;</span>]) <span class="hljs-comment">#951</span><br><br>Chunk = &#123;<br>    k:[t[i:i+chunk_size] <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>,total_length,chunk_size)]<br>    <span class="hljs-keyword">for</span> k ,t <span class="hljs-keyword">in</span> concatenated_exampls.items() <span class="hljs-comment">#ç›¸å½“äºå…ƒç´ çš„æ•´åˆå†æŒ‰ç…§chunk_sizeçš„åˆ‡å‰²</span><br>&#125;<br><br><br><br></code></pre></td></tr></table></figure><p><strong>åŒæ—¶å¯¹äºæœ€åä¸€ä¸ªchunkå‡ºç°çš„ä¸å‡åŒ€çš„æƒ…å†µ,é‡‡ç”¨ç›´æ¥å¡«å……,æˆ–è€…ç›´æ¥ä¸¢å¼ƒçš„æ–¹æ³•</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">group_texts</span>(<span class="hljs-params">examples</span>):<br>    concatenated_examples = &#123;k:<span class="hljs-built_in">sum</span>(examples[k],[]) <span class="hljs-keyword">for</span> k <span class="hljs-keyword">in</span> examples.keys()&#125;<br>    total_length = <span class="hljs-built_in">len</span>(concatenated_examples[<span class="hljs-built_in">list</span>(examples.keys())[<span class="hljs-number">0</span>]])<br>    total_length = (total_length // chunk_size) *chunk_size<br><br>    result = &#123;<br>        k:[t[i:i+chunk_size]<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>,total_legth,chunk_size)] <span class="hljs-keyword">for</span> k,t inconcatenated_examples.items()<br>    &#125;<br><br>    result[<span class="hljs-string">&quot;labels&quot;</span>]= result[<span class="hljs-string">&quot;input_ids&quot;</span>].copy()<br>    <span class="hljs-keyword">return</span> result<br><br>lm_datasets = tokenzied_datasets.<span class="hljs-built_in">map</span>(group_texts,batched = <span class="hljs-literal">True</span>)    <br><br></code></pre></td></tr></table></figure><h4 id="Fine-tuning-DistilBERt-with-the-Trainer-API"><a href="#Fine-tuning-DistilBERt-with-the-Trainer-API" class="headerlink" title="Fine-tuning DistilBERt with the Trainer API"></a>Fine-tuning DistilBERt with the Trainer API</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> transformer <span class="hljs-keyword">import</span> DataCollatorForlanguageModeling<br>data_collator = DataCollatorForLanguageModeling(tokenizer = tokenizer,mlm_probability = <span class="hljs-number">0.15</span> )<br><br>samples = [lm_dataset[<span class="hljs-string">&quot;train&quot;</span>][i] <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">2</span>)]<br><span class="hljs-keyword">for</span> sample <span class="hljs-keyword">in</span> samples:<br>    _ = sample.popp(<span class="hljs-string">&quot;word_ids&quot;</span>) <span class="hljs-comment">#è¿™ä¸ªä¼šå¼¹å‡ºkeyå¯¹åº”çš„value å¹¶åˆ é™¤è¿™ä¸ªé”®å¯¹å€¼</span><br><br><span class="hljs-keyword">import</span> collections<br><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np<br><span class="hljs-keyword">from</span> transformers <span class="hljs-keyword">import</span> default_data_collator<br><br>ww_prolbability = <span class="hljs-number">0.2</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">whole_word_masking_data_collator</span>(<span class="hljs-params">features</span>):<br>    <span class="hljs-comment">#featuresæ˜¯æœ€å¤–çš„å­—å…¸</span><br>    <span class="hljs-comment">#featureæ˜¯ é”®å¯¹å€¼</span><br>    <span class="hljs-keyword">for</span> feature <span class="hljs-keyword">in</span> features:<br>        word_ids = feature.pop(<span class="hljs-string">&quot;word_ids&quot;</span>)<br>        mapping = collections.defaultdict(<span class="hljs-built_in">list</span>) <span class="hljs-comment">#mappingå†…éƒ¨å…ƒç´ æ˜¯ä¸€ç§åˆ—è¡¨</span><br>        current_word_index = -<span class="hljs-number">1</span><br>        current_word = <span class="hljs-literal">None</span>:<br>        <span class="hljs-keyword">for</span> idx,word_idx <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(word_ids):<br>            <span class="hljs-keyword">if</span> word_id <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>                <span class="hljs-keyword">if</span> word_id != current_word:<br>                    current_word = word_id<br>                    <span class="hljs-comment">#å•è¯æ•°é‡åŠ 1</span><br>                    current_word_index += <span class="hljs-number">1</span><br>                mapping[current_word_index].append(idx)<span class="hljs-comment">#åœ¨å½“å‰å•è¯çš„ä½ç½®ä¸Šæ˜ å°„å¯¹åº”çš„tokençš„ä½ç½®</span><br>    <span class="hljs-comment"># éšæœºçš„é®è”½ç›¸å…³çš„å­—ç¬¦</span><br>    mask = np.random.binomial(<span class="hljs-number">1</span>,wwm_probability,(<span class="hljs-built_in">len</span>(mapping))) <span class="hljs-comment">#åœ¨mappingä¸Šçš„æ¯ä¸€ä¸ªå…ƒç´ éƒ½åšäºŒé¡¹åˆ†å¸ƒ,æ¦‚ç‡æœ‰wwmç”Ÿæˆ,åŒæ—¶ç”Ÿæˆä¸€ä¸ªåˆ—è¡¨ å«æœ‰1,0ç­‰å…ƒç´  </span><br>    <span class="hljs-comment">#è¿™é‡Œæ»¡è¶³äº†ä¸€æ•´ä¸ªå•è¯é®è”½çš„æ–¹å¼</span><br><br><br>    <span class="hljs-comment">#åŒæ—¶åŸæ¥çš„labelså’Œinput_idséƒ½æ˜¯ä¿ç•™ä¸€æ ·çš„å€¼</span><br>    input_ids = feature[<span class="hljs-string">&quot;input_ids&quot;</span>] <br>    labels = feautre[<span class="hljs-string">&quot;labels&quot;</span>]<br>    new_labels = [-<span class="hljs-number">100</span>] *<span class="hljs-built_in">len</span>(labels) <span class="hljs-comment">#åˆ›å»ºä¸€ä¸ªé•¿åº¦ä¸ºlen æ¯ä¸€ä¸ªå…ƒç´ éƒ½æ˜¯[ -100]çš„åˆ—è¡¨ , </span><br>    <span class="hljs-keyword">for</span> word_id <span class="hljs-keyword">in</span> np.where(mask)[<span class="hljs-number">0</span>]: <span class="hljs-comment">#å½“ä½œå¸ƒå°”è¡Œä»£æ•°æ¥çœ‹</span><br>        word_id = word_id.item()<br>        <span class="hljs-keyword">for</span> idx <span class="hljs-keyword">in</span> mapping[word_id]:<br>            new_labels[idx] = labels[idx] <span class="hljs-comment">#å…¶ä»–çš„é»˜è®¤æ˜¯-100? è¿™é‡Œä¿ç•™ç€é®è”½çš„é‚£äº›è¯?</span><br>            input_ids[idx] = tokenizer.mask_token_id <span class="hljs-comment">#è¿™é‡Œåº”è¯¥æ˜¯ç›¸å½“äºé®è”½äº†?</span><br><br>    feature[<span class="hljs-string">&quot;labels&quot;</span>] = new_labels<br><br>    <span class="hljs-keyword">return</span> default_data_collator(features)<br><br>train_size =<span class="hljs-number">10_000</span><br>test_size = <span class="hljs-built_in">int</span>(<span class="hljs-number">0.1</span> * train_size) <span class="hljs-comment">#int() è¡¨ç¤ºç±»å‹è½¬æ¢ä¸ºæ•´æ•°</span><br><br>downsampled_dataset = lm_datasets[<span class="hljs-string">&quot;train&quot;</span>].train_test_split(<br>    train_size = train_size, test_size=test_size, seed = <span class="hljs-number">42</span><br>)<br><br></code></pre></td></tr></table></figure><h4 id="è®­ç»ƒæ•°æ®åº“"><a href="#è®­ç»ƒæ•°æ®åº“" class="headerlink" title="è®­ç»ƒæ•°æ®åº“"></a>è®­ç»ƒæ•°æ®åº“</h4><p>ç»™trainerå®šä¹‰å‚æ•°</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> transfromers <span class="hljs-keyword">import</span> TrainingArguments<br><br>batch_size = <span class="hljs-number">64</span><br>logging_steps = <span class="hljs-built_in">len</span>(downsampled_dataset[<span class="hljs-string">&quot;train&quot;</span>]) //batch_size<br>model_name = model_checkpoint.split(<span class="hljs-string">&quot;/&quot;</span>)[-<span class="hljs-number">1</span>] <span class="hljs-comment">#æŒ‰ç…§/çš„å½¢å¼åˆ‡å‰²,å¹¶å–å‡ºæœ€åä¸€ä¸ªå€¼</span><br>training_args = TrainingArguments(<br>    output_dir = <span class="hljs-string">f&quot;<span class="hljs-subst">&#123;model_name&#125;</span>-finetune-immdb&quot;</span>,<br>    overwrite_output_dir = <span class="hljs-literal">True</span>,<br>    evaluation_strategy = <span class="hljs-string">&quot;epocoh&quot;</span>,<br>    learning_rate = <span class="hljs-number">2e-5</span>,<br>    weight_decay = <span class="hljs-number">0.01</span>,<br>    per_device_train_batch_size = batch_size,<br>    per_device_eval_batch_size = batch_size,<br>    push_to_hub = <span class="hljs-literal">True</span>,<br>    fp16 = <span class="hljs-literal">True</span>,<br>    logging_steps = logging_steps,<br>)<br><br><span class="hljs-keyword">from</span> transformers <span class="hljs-keyword">import</span> Trainer<br>trainer = Trainer(<br>    model = model,<br>    args = training_args,<br>    train_dataset = downsampled_dataset[<span class="hljs-string">&quot;train&quot;</span>],<br>    eval_dataselt = downsampled_dataset[<span class="hljs-string">&quot;test&quot;</span>],<br>    data_collator = data_collator,<br>    tokenizer = tokenizer,<br>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">insert_random_mask</span>(<span class="hljs-params">batch</span>):<br>    features = [<span class="hljs-built_in">dict</span>(<span class="hljs-built_in">zip</span>(batch,t)) <span class="hljs-keyword">for</span> t <span class="hljs-keyword">in</span> <span class="hljs-built_in">zip</span>(*batch.values())] <br>    <span class="hljs-comment">#zip(*batch.value())ä¼šå¯¹ä¸€ä¸ªkeyçš„ä¸œè¥¿å‹ç¼©æˆä¸ºä¸€ä¸ªå…ƒç»„é€šå¸¸ï¼Œå®ƒç”¨äºå°†å¤šä¸ªåˆ—è¡¨æˆ–åºåˆ—çš„å…ƒç´ æŒ‰ç…§ç›¸åŒç´¢å¼•ä½ç½®é…å¯¹åœ¨ä¸€èµ·ã€‚ </span><br>    <span class="hljs-comment">#tç›¸å½“äºæ˜¯ä¸€ä¸ªå…ƒç»„, ç”¨æ¯ä¸€ä¸ªkeyå’Œå…ƒç»„ä¸­çš„å…ƒç´ è¿›è¡Œé…å¯¹</span><br>    masked_inputs = data_collator(features)<br>    <span class="hljs-keyword">return</span> &#123;<span class="hljs-string">&quot;masked_&quot;</span>+k:v.numpy()<span class="hljs-keyword">for</span> k,v <span class="hljs-keyword">in</span> masked_inputs.items()&#125;<br>    <span class="hljs-comment">#è¿™ä¸ªç›¸å½“äºåœ¨åŸå­—å…¸ä¹‹å‰åŠ ä¸Šâ€œmasked_&quot;çš„å‰ç¼€</span><br><br>downsampled_dataset = downsampled_dataset.remove_columns([<span class="hljs-string">&quot;word_ids&quot;</span>])<br>eval_dataset = downsampled_dataset[<span class="hljs-string">&quot;test&quot;</span>].<span class="hljs-built_in">map</span>(<br>    insert_random_mask,<br>    batched = <span class="hljs-literal">True</span>,<br>    remove_columns = downsampled_dataset[<span class="hljs-string">&quot;test&quot;</span>].column_names,<br>)<br><br>eval_dataset = eval_dataset.rename_columns(<br>    &#123;<br>        <span class="hljs-string">&quot;masked_input_ids&quot;</span>: <span class="hljs-string">&quot;input_ids&quot;</span>,<br>        <span class="hljs-string">&quot;masked_attention_mask&quot;</span>: <span class="hljs-string">&quot;attention_mask&quot;</span>,<br>        <span class="hljs-string">&quot;masked_labels&quot;</span>: <span class="hljs-string">&quot;labels&quot;</span>,<br>    &#125;<br>)<br><br><span class="hljs-keyword">from</span> torch.utils.data <span class="hljs-keyword">import</span> DataLoader<br><span class="hljs-keyword">from</span> transformers <span class="hljs-keyword">import</span> default_data_collator<br><br>batch_size =<span class="hljs-number">64</span><br>train_dataloader = DataLoader(<br>    downsampled_dataset[<span class="hljs-string">&quot;train&quot;</span>],<br>    shuffle = <span class="hljs-literal">True</span>,<br>    batch_size = batch_size,<br>    collate_fn = data_collator<br>)<br><br>eval_dataloader = DataLoader(<br>    eval_dataset,batch_size = batch_size.collate_fn = default_data_collator<br>)<br><br>model = AutoModelForMaskedLM.from_pretrained(model_checkpoint)<br><span class="hljs-keyword">from</span> torch.optim <span class="hljs-keyword">import</span> AdamW<br>optimizer = AdamW(model.parameters(),lr= <span class="hljs-number">5e-5</span>)<br><br><span class="hljs-keyword">from</span> accelerate <span class="hljs-keyword">import</span> Accelerator<br><br>accelerator = Accelerator()<br>model,optimizer,train_dataloader,eval_dataloader = accelerator.prepare(<br>    model,optimizer,train_dataloader,eval_dataloader<br>)<br><br></code></pre></td></tr></table></figure><h3 id="Translation"><a href="#Translation" class="headerlink" title="Translation"></a>Translation</h3><h4 id="loaddata"><a href="#loaddata" class="headerlink" title="loaddata"></a>loaddata</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> datasets <span class="hljs-keyword">import</span> load_dataset<br>raw_datasets = load_dataset(<span class="hljs-string">&quot;kde4&quot;</span>, lang1=<span class="hljs-string">&quot;en&quot;</span>, lang2=<span class="hljs-string">&quot;fr&quot;</span>)<br>split_datasets = raw_datasets[<span class="hljs-string">&quot;train&quot;</span>].train_test_split(train_size=<span class="hljs-number">0.9</span>, seed=<span class="hljs-number">20</span>) <span class="hljs-comment">#é€‰æ‹©è®­ç»ƒé›†å’Œæµ‹è¯•é›†</span><br><br>split_datasets[<span class="hljs-string">&quot;validation&quot;</span>] = split_datasets.pop(<span class="hljs-string">&quot;test&quot;</span>) <span class="hljs-comment">#é‡å‘½å</span><br><br>split_datasets[<span class="hljs-string">&quot;train&quot;</span>][<span class="hljs-number">1</span>][<span class="hljs-string">&quot;translation&quot;</span>] <span class="hljs-comment">#ä¸¤ç§id å’Œtranslation-&gt;å­—å…¸ åŒæ—¶en,fr</span><br><br><span class="hljs-keyword">from</span> transformers <span class="hljs-keyword">import</span> pipeline<br><br>model_checkpoint = <span class="hljs-string">&quot;Helsinki-NLP/opus-mt-en-fr&quot;</span><br>translator = pipeline(<span class="hljs-string">&quot;translation&quot;</span>, model=model_checkpoint)<br>translator(<span class="hljs-string">&quot;Default to expanded threads&quot;</span>)<br><br><span class="hljs-keyword">from</span> transformers <span class="hljs-keyword">import</span> AutoTokenizer<br><br>model_checkpoint = <span class="hljs-string">&quot;Helsinki-NLP/opus-mt-en-fr&quot;</span><br>tokenizer = AutoTokenizer.from_pretrained(model_checkpoint, return_tensors=<span class="hljs-string">&quot;pt&quot;</span>)<br><br><span class="hljs-comment">#tokenizerå®Œæˆ</span><br><br>en_sentence = split_datasets[<span class="hljs-string">&quot;train&quot;</span>][<span class="hljs-number">1</span>][<span class="hljs-string">&quot;translation&quot;</span>][<span class="hljs-string">&quot;en&quot;</span>]<br>fr_sentence = split_datasets[<span class="hljs-string">&quot;train&quot;</span>][<span class="hljs-number">1</span>][<span class="hljs-string">&quot;translation&quot;</span>][<span class="hljs-string">&quot;fr&quot;</span>]<br><br>inputs = tokenizer(en_sentence, text_target=fr_sentence)<br><br><span class="hljs-comment">#inputç»“æœç”Ÿæˆ</span><br>&#123;<span class="hljs-string">&#x27;input_ids&#x27;</span>: [<span class="hljs-number">47591</span>, <span class="hljs-number">12</span>, <span class="hljs-number">9842</span>, <span class="hljs-number">19634</span>, <span class="hljs-number">9</span>, <span class="hljs-number">0</span>], <span class="hljs-string">&#x27;attention_mask&#x27;</span>: [<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>], <span class="hljs-string">&#x27;labels&#x27;</span>: [<span class="hljs-number">577</span>, <span class="hljs-number">5891</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3184</span>, <span class="hljs-number">16</span>, <span class="hljs-number">2542</span>, <span class="hljs-number">5</span>, <span class="hljs-number">1710</span>, <span class="hljs-number">0</span>]&#125;<br><span class="hljs-comment">#æ²¡æœ‰ç†è§£é”™è¯¯çš„æƒ…å†µä¸‹:input_idsåº”è¯¥ç”¨çš„æ˜¯å¯¹åº”çš„æ¯ä¸€ä¸ªå•è¯åœ¨è¯­æ–™åº“çš„ä½ç½®,labelså¯¹åº”çš„æ³•è¯­çš„ä½ç½® #åŒæ—¶è¿™ä¸ªæ³¨æ„è¦æŒ‡å®šå‚æ•°</span><br><span class="hljs-built_in">print</span>(tokenizer.convert_ids_to_tokens(inputs[<span class="hljs-string">&quot;labels&quot;</span>])) <span class="hljs-comment">#è¿™é‡Œç”¨çš„æ˜¯æŠŠidè½¬æ¢æˆtokensçš„ä¸€ç§å‡½æ•°æ‰èƒ½åˆç†çš„çœ‹å‡ºæ˜¯ä»€ä¹ˆä¸œè¥¿</span><br><br>max_length = <span class="hljs-number">128</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">preprocess_function</span>(<span class="hljs-params">examples</span>):<br>    inputs = [ex[<span class="hljs-string">&quot;en&quot;</span>] <span class="hljs-keyword">for</span> ex <span class="hljs-keyword">in</span> examples[<span class="hljs-string">&quot;translation&quot;</span>]]<br>    targets = [ex[<span class="hljs-string">&quot;fr&quot;</span>] <span class="hljs-keyword">for</span> ex <span class="hljs-keyword">in</span> examples[<span class="hljs-string">&quot;translation&quot;</span>]]<br>    <span class="hljs-comment">#åˆ‡å‰²</span><br>    model_inputs = tokenizer(<br>        inputs, text_target=targets, max_length=max_length, truncation=<span class="hljs-literal">True</span><br>    )<br>    <span class="hljs-keyword">return</span> model_inputs<br><br><span class="hljs-keyword">from</span> transformers <span class="hljs-keyword">import</span> AutoModelForSeq2SeqLM<br><br>model = AutoModelForSeq2SeqLM.from_pretrained(model_checkpoint)<br><span class="hljs-keyword">from</span> transformers <span class="hljs-keyword">import</span> DataCollatorForSeq2Seq<br><br>data_collator = DataCollatorForSeq2Seq(tokenizer, model=model)<br><span class="hljs-comment">#the padding value used to pad the labels should be -100 and not the padding token of the tokenizer, to make sure those padded values are ignored in the loss computation. it takes the tokenizer used to preprocess the inputs, but it also takes the model. This is because this data collator will also be responsible for preparing the decoder input IDs, which are shifted versions of the labels with a special token at the beginning. Since this shift is done slightly differently for different architectures, the DataCollatorForSeq2Seq needs to know the model object:</span><br><br><span class="hljs-comment">#for ex</span><br>batch = data_collator([tokenized_datasets[<span class="hljs-string">&quot;train&quot;</span>][i] <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, <span class="hljs-number">3</span>)])<br>batch.keys()<br>dict_keys([<span class="hljs-string">&#x27;attention_mask&#x27;</span>, <span class="hljs-string">&#x27;input_ids&#x27;</span>, <span class="hljs-string">&#x27;labels&#x27;</span>, <span class="hljs-string">&#x27;decoder_input_ids&#x27;</span>])<br>batch[<span class="hljs-string">&quot;labels&quot;</span>]<br>batch[<span class="hljs-string">&quot;decoder_input_ids&quot;</span>]  <span class="hljs-comment"># see that they are shifted versions of the labels:</span><br><br></code></pre></td></tr></table></figure><h4 id="Metrics"><a href="#Metrics" class="headerlink" title="Metrics"></a>Metrics</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> evaluate<br>metric = evaluate.load(<span class="hljs-string">&quot;sacrebleu&quot;</span>)<br>predictions = [<br>    <span class="hljs-string">&quot;This plugin lets you translate web pages between several languages automatically.&quot;</span><br>]<br>references = [<br>    [<br>        <span class="hljs-string">&quot;This plugin allows you to automatically translate web pages between several languages.&quot;</span><br>    ]<br>]<br><span class="hljs-comment"># the predictions should be a list of sentences, but the references should be a list of lists of sentences.</span><br><br>metric.compute(predictions=predictions, references=references)<span class="hljs-comment">#è°ƒç”¨å‡½æ•°è¯„åˆ¤ç¿»è¯‘ç»“æœçš„å¥½å</span><br><br><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">compute_metrics</span>(<span class="hljs-params">eval_preds</span>):<br>    preds, labels = eval_preds<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(preds,<span class="hljs-built_in">tuple</span>):<span class="hljs-comment">#æ£€æŸ¥å¯¹è±¡ç±»å‹æ˜¯ä¸æ˜¯å…ƒç»„ //ä¸€ç§ç›¸å…³çš„å‡½æ•°</span><br>        preds = preds[<span class="hljs-number">0</span>]<br>    <br>    decoded_preds = tokenizer.batch_decode(preds,skip_special_toknes = <span class="hljs-literal">True</span>) <span class="hljs-comment">#è¿™é‡Œåº”è¯¥æ˜¯å·²ç»å®Œæˆäº†æ›¿æ¢,æ‰€ä»¥ä¸éœ€è¦åœ¨è¿™é‡Œè¿›è¡Œæ›´æ”¹</span><br>    labes = np.where(labels != -<span class="hljs-number">100</span>,labels,tokenizer.pad_token_id) <span class="hljs-comment">#åˆ†åˆ«ä»£è¡¨äº†æ£€ç´¢çš„å€¼,åœ¨å“ªæ£€ç´¢,ä¸ç¬¦åˆçš„å€¼æ›¿æ¢æˆä»€ä¹ˆ</span><br>    decoded_labels = tokenizer.batch_decode(labels,skip_special_tokens =<span class="hljs-literal">True</span>)<br><br>    decoded_preds = [pred.strip() <span class="hljs-keyword">for</span> pred <span class="hljs-keyword">in</span> decoded_preds] <span class="hljs-comment">#å»é™¤å­—ç¬¦ä¸²ä¸¤ä¾§çš„ç©ºç™½å­—ç¬¦ï¼ˆåŒ…æ‹¬ç©ºæ ¼ã€åˆ¶è¡¨ç¬¦ã€æ¢è¡Œç¬¦ç­‰</span><br>    decoded_labels = [[label.strip()] <span class="hljs-keyword">for</span> label <span class="hljs-keyword">in</span> decoded_labels]<br><br>    result = metric.compute(predictions=decoded_preds, references=decoded_labels) <span class="hljs-comment">#è®¡ç®—å‡ºç»“æœ</span><br>    <span class="hljs-keyword">return</span> &#123;<span class="hljs-string">&quot;bleu&quot;</span>: result[<span class="hljs-string">&quot;score&quot;</span>]&#125;<br></code></pre></td></tr></table></figure><p>è¯„ä¼°å‡½æ•°</p><h4 id="Fine-tuning-the-model-1"><a href="#Fine-tuning-the-model-1" class="headerlink" title="Fine-tuning the model"></a>Fine-tuning the model</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> transformers <span class="hljs-keyword">import</span> Seq2SeqTrainingArguments<br><br>args = Seq2SeqTrainingArguments(<br>    <span class="hljs-string">f&quot;marian-finetuned-kde4-en-to-fr&quot;</span>,<br>    evaluation_strategy=<span class="hljs-string">&quot;no&quot;</span>,<br>    save_strategy=<span class="hljs-string">&quot;epoch&quot;</span>,<br>    learning_rate=<span class="hljs-number">2e-5</span>,<br>    per_device_train_batch_size=<span class="hljs-number">32</span>,<br>    per_device_eval_batch_size=<span class="hljs-number">64</span>,<br>    weight_decay=<span class="hljs-number">0.01</span>,<br>    save_total_limit=<span class="hljs-number">3</span>,<br>    num_train_epochs=<span class="hljs-number">3</span>,<br>    predict_with_generate=<span class="hljs-literal">True</span>,<br>    fp16=<span class="hljs-literal">True</span>,<br>    push_to_hub=<span class="hljs-literal">True</span>,<br>)<br><br><span class="hljs-keyword">from</span> transformers <span class="hljs-keyword">import</span> Seq2SeqTrainingArguments<br><br>args = Seq2SeqTrainingArguments(<br>    <span class="hljs-string">f&quot;marian-finetuned-kde4-en-to-fr&quot;</span>,<br>    evaluation_strategy=<span class="hljs-string">&quot;no&quot;</span>,<br>    save_strategy=<span class="hljs-string">&quot;epoch&quot;</span>,<br>    learning_rate=<span class="hljs-number">2e-5</span>,<br>    per_device_train_batch_size=<span class="hljs-number">32</span>,<br>    per_device_eval_batch_size=<span class="hljs-number">64</span>,<br>    weight_decay=<span class="hljs-number">0.01</span>,<br>    save_total_limit=<span class="hljs-number">3</span>,<br>    num_train_epochs=<span class="hljs-number">3</span>,<br>    predict_with_generate=<span class="hljs-literal">True</span>,<br>    fp16=<span class="hljs-literal">True</span>,<span class="hljs-comment">#åœ¨GPUä¸ŠåŠ é€Ÿè®­ç»ƒ</span><br>    push_to_hub=<span class="hljs-literal">True</span>,<br>)<br><span class="hljs-keyword">from</span> transformers <span class="hljs-keyword">import</span> Seq2SeqTrainer<br><br>trainer = Seq2SeqTrainer(<br>    model,<br>    args,<br>    train_dataset=tokenized_datasets[<span class="hljs-string">&quot;train&quot;</span>],<br>    eval_dataset=tokenized_datasets[<span class="hljs-string">&quot;validation&quot;</span>],<br>    data_collator=data_collator,<br>    tokenizer=tokenizer,<br>    compute_metrics=compute_metrics,<br>)<br></code></pre></td></tr></table></figure><h3 id="summation"><a href="#summation" class="headerlink" title="summation"></a>summation</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs python">english_dataset.set_format(<span class="hljs-string">&quot;pandas&quot;</span>)<span class="hljs-comment">#è½¬æ¢æ•°æ®ç±»å‹</span><br>english_df = english_dataset[<span class="hljs-string">&quot;train&quot;</span>][:]<br><span class="hljs-comment"># Show counts for top 20 products</span><br>english_df[<span class="hljs-string">&quot;product_category&quot;</span>].value_counts()[:<span class="hljs-number">20</span>]<span class="hljs-comment">#ç»Ÿè®¡å‡ºç°æ¬¡æ•°æœ€å¤šçš„ä¸¤ä¸ª</span><br><br><span class="hljs-comment">#æ•°æ®è¿‡æ»¤</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">filter_books</span>(<span class="hljs-params">example</span>):<br>    <span class="hljs-keyword">return</span> (<br>        example[<span class="hljs-string">&quot;product_category&quot;</span>] == <span class="hljs-string">&quot;book&quot;</span><br>        <span class="hljs-keyword">or</span> example[<span class="hljs-string">&quot;product_category&quot;</span>] == <span class="hljs-string">&quot;digital_ebook_purchase&quot;</span><br>    )<br><br>english_dataset.reset_format() <span class="hljs-comment">#é‡æ–°è®¾ç½®æ•°æ®çš„æ ¼å¼</span><br>spanish_books = spanish_dataset.<span class="hljs-built_in">filter</span>(filter_books) <span class="hljs-comment">#åº”è¯¥æ˜¯åˆ©ç”¨æ•°æ®çš„æ ¼å¼,æŒ‰ç…§è¿”å›å€¼æ¥è¿‡æ»¤æ•°æ®</span><br>english_books = english_dataset.<span class="hljs-built_in">filter</span>(filter_books)<br><br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> datasets <span class="hljs-keyword">import</span> concatenate_datasets, DatasetDict<br><br>books_dataset = DatasetDict()<br><br><span class="hljs-keyword">for</span> split <span class="hljs-keyword">in</span> english_books.keys():<br>    books_dataset[split] = concatenate_datasets(<br>        [english_books[split], spanish_books[split]]<br>    ) <span class="hljs-comment">#è¿™é‡Œæ˜¯å–å‡ºç›¸å…³çš„æ ‡ç­¾ ç„¶ååˆ›å»ºä¸€è‡´çš„é‡.</span><br>    books_dataset[split] = books_dataset[split].shuffle(seed=<span class="hljs-number">42</span>)<br><br><span class="hljs-comment"># Peek at a few examples</span><br>show_samples(books_dataset) <span class="hljs-comment">#booksæ··å…¥ä¸¤ç§ä¸åŒè¯­è¨€çš„æ•°æ®é›†</span><br><br></code></pre></td></tr></table></figure><h4 id="æŸ¥çœ‹å†…å®¹"><a href="#æŸ¥çœ‹å†…å®¹" class="headerlink" title="æŸ¥çœ‹å†…å®¹"></a>æŸ¥çœ‹å†…å®¹</h4><p>å¯¹äºæ€»ç»“æ¥è¯´,è¿‡æ»¤æ‰å‡çŸ­çš„æ€»ç»“æ˜¯ä¸€ä»¶å¾ˆé‡è¦çš„äº‹æƒ…,å¦åˆ™ä¼šå¼•èµ·è¿™ç§çŸ­æ€»ç»“çš„bias</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs python">books_dataset = books_dataset.<span class="hljs-built_in">filter</span>(<span class="hljs-keyword">lambda</span> x: <span class="hljs-built_in">len</span>(x[<span class="hljs-string">&quot;review_title&quot;</span>].split()) &gt; <span class="hljs-number">2</span>)<span class="hljs-comment">#æŒ‰ç…§é‡Œé¢å€¼ä¸º1çš„æ–¹å¼è¿›è¡Œè¿‡æ»¤</span><br><br><span class="hljs-keyword">from</span> transformers <span class="hljs-keyword">import</span> AutoTokenizer<br><br>model_checkpoint = <span class="hljs-string">&quot;google/mt5-small&quot;</span><br>tokenizer = AutoTokenizer.from_pretrained(model_checkpoint)<br><br><span class="hljs-comment">#è¾“å‡ºç»“æœ</span><br>&#123;<span class="hljs-string">&#x27;input_ids&#x27;</span>: [<span class="hljs-number">336</span>, <span class="hljs-number">259</span>, <span class="hljs-number">28387</span>, <span class="hljs-number">11807</span>, <span class="hljs-number">287</span>, <span class="hljs-number">62893</span>, <span class="hljs-number">295</span>, <span class="hljs-number">12507</span>, <span class="hljs-number">1</span>], <span class="hljs-string">&#x27;attention_mask&#x27;</span>: [<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>]&#125;<br><br>tokenizer.convert_ids_to_tokens(inputs.input_ids) <span class="hljs-comment">#åˆ†è¯è½¬æ¢çš„è¯­å¥</span><br>[<span class="hljs-string">&#x27;â–I&#x27;</span>, <span class="hljs-string">&#x27;â–&#x27;</span>, <span class="hljs-string">&#x27;loved&#x27;</span>, <span class="hljs-string">&#x27;â–reading&#x27;</span>, <span class="hljs-string">&#x27;â–the&#x27;</span>, <span class="hljs-string">&#x27;â–Hung&#x27;</span>, <span class="hljs-string">&#x27;er&#x27;</span>, <span class="hljs-string">&#x27;â–Games&#x27;</span>, <span class="hljs-string">&#x27;&lt;/s&gt;&#x27;</span>]<br><br>max_input_length = <span class="hljs-number">512</span><br>max_target_length = <span class="hljs-number">30</span><br><br><span class="hljs-comment">#è¿™é‡Œæ²¡æœ‰çœ‹æ‡‚....</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">preprocess_function</span>(<span class="hljs-params">examples</span>):<br>    model_inputs = tokenizer(<br>        examples[<span class="hljs-string">&quot;review_body&quot;</span>],<br>        max_length=max_input_length,<br>        truncation=<span class="hljs-literal">True</span>,<br>    )<br>    labels = tokenizer(<br>        examples[<span class="hljs-string">&quot;review_title&quot;</span>], max_length=max_target_length, truncation=<span class="hljs-literal">True</span><br>    )<br>    model_inputs[<span class="hljs-string">&quot;labels&quot;</span>] = labels[<span class="hljs-string">&quot;input_ids&quot;</span>]<br>    <span class="hljs-keyword">return</span> model_inputs<br><br></code></pre></td></tr></table></figure><h4 id="create-a-strong-yet-simple-baseline"><a href="#create-a-strong-yet-simple-baseline" class="headerlink" title="create a strong, yet simple baseline!"></a>create a strong, yet simple baseline!</h4><p>A common baseline for text summarization is to simply take the first three sentences of an article, often called the lead-3 baseline.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> nltk<br><br>nltk.download(<span class="hljs-string">&quot;punkt&quot;</span>)<br><br><span class="hljs-keyword">from</span> nltk.tokenize <span class="hljs-keyword">import</span> sent_tokenize<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">three_sentence_summary</span>(<span class="hljs-params">text</span>):<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;\n&quot;</span>.join(sent_tokenize(text)[:<span class="hljs-number">3</span>])<br><br><br><span class="hljs-built_in">print</span>(three_sentence_summary(books_dataset[<span class="hljs-string">&quot;train&quot;</span>][<span class="hljs-number">1</span>][<span class="hljs-string">&quot;review_body&quot;</span>]))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">evaluate_baseline</span>(<span class="hljs-params">dataset, metric</span>):<br>    summaries = [three_sentence_summary(text) <span class="hljs-keyword">for</span> text <span class="hljs-keyword">in</span> dataset[<span class="hljs-string">&quot;review_body&quot;</span>]]<br>    <span class="hljs-keyword">return</span> metric.compute(predictions=summaries, references=dataset[<span class="hljs-string">&quot;review_title&quot;</span>])<br><br><span class="hljs-comment">#ç›¸å½“äºç”¨æ–‡æœ¬çš„å‰ä¸‰å¥è¯ä½œä¸ºè¯„åˆ¤çš„æ ‡å‡†</span><br><br><span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd<br><br>score = evaluate_baseline(books_dataset[<span class="hljs-string">&quot;validation&quot;</span>], rouge_score)<br>rouge_names = [<span class="hljs-string">&quot;rouge1&quot;</span>, <span class="hljs-string">&quot;rouge2&quot;</span>, <span class="hljs-string">&quot;rougeL&quot;</span>, <span class="hljs-string">&quot;rougeLsum&quot;</span>]<br>rouge_dict = <span class="hljs-built_in">dict</span>((rn, <span class="hljs-built_in">round</span>(score[rn].mid.fmeasure * <span class="hljs-number">100</span>, <span class="hljs-number">2</span>)) <span class="hljs-keyword">for</span> rn <span class="hljs-keyword">in</span> rouge_names)<br>rouge_dict<br></code></pre></td></tr></table></figure><h2 id="LangChain"><a href="#LangChain" class="headerlink" title="LangChain"></a>LangChain</h2><h3 id="chain"><a href="#chain" class="headerlink" title="chain"></a>chain</h3><p>èµ·åˆ°äº†ä¸²è”ä¸åŒçš„agentçš„ä½œç”¨</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Chain</span>(BaseModel, ABC):<br>    <span class="hljs-string">&quot;&quot;&quot;Base interface that all chains should implement.&quot;&quot;&quot;</span><br><br>    memory: BaseMemory<br>    callbacks: Callbacks<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__call__</span>(<span class="hljs-params"></span><br><span class="hljs-params">        self,</span><br><span class="hljs-params">        inputs: <span class="hljs-type">Any</span>,</span><br><span class="hljs-params">        return_only_outputs: <span class="hljs-built_in">bool</span> = <span class="hljs-literal">False</span>,</span><br><span class="hljs-params">        callbacks: Callbacks = <span class="hljs-literal">None</span>,</span><br><span class="hljs-params">    </span>) -&gt; <span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]:<br>        ...<br><br><span class="hljs-comment">#use it</span><br><span class="hljs-keyword">from</span> langchain.llms <span class="hljs-keyword">import</span> OpenAI<br><span class="hljs-keyword">from</span> langchain.prompts <span class="hljs-keyword">import</span> PromptTemplate<br><br>llm = OpenAI(temperature=<span class="hljs-number">0.9</span>)<br>prompt = PromptTemplate(<span class="hljs-comment">#è¿™é‡Œåº”è¯¥æ˜¯åˆ›å»ºä¸€ä¸ªpromptçš„æ¨¡ç‰ˆ</span><br>    input_variables=[<span class="hljs-string">&quot;product&quot;</span>],<br>    template=<span class="hljs-string">&quot;What is a good name for a company that makes &#123;product&#125;?&quot;</span>,<br>)<br><span class="hljs-keyword">from</span> langchain.chains <span class="hljs-keyword">import</span> LLMChain<br>chain = LLMChain(llm=llm, prompt=prompt)<span class="hljs-comment">#ä¼ å…¥ä¸¤ä¸ªå‚æ•°</span><br><br><span class="hljs-comment"># Run the chain only specifying the input variable.</span><br><span class="hljs-built_in">print</span>(chain.run(<span class="hljs-string">&quot;colorful socks&quot;</span>))<br><br><br><span class="hljs-keyword">from</span> langchain.chat_models <span class="hljs-keyword">import</span> ChatOpenAI<br><span class="hljs-keyword">from</span> langchain.prompts.chat <span class="hljs-keyword">import</span> (<br>    ChatPromptTemplate,<br>    HumanMessagePromptTemplate,<br>)<br>human_message_prompt = HumanMessagePromptTemplate(<br>        prompt=PromptTemplate(<br>            template=<span class="hljs-string">&quot;What is a good name for a company that makes &#123;product&#125;?&quot;</span>,<br>            input_variables=[<span class="hljs-string">&quot;product&quot;</span>],<br>        )<br>    )<br>chat_prompt_template = ChatPromptTemplate.from_messages([human_message_prompt])<br>chat = ChatOpenAI(temperature=<span class="hljs-number">0.9</span>)<br>chain = LLMChain(llm=chat, prompt=chat_prompt_template)<br><span class="hljs-built_in">print</span>(chain.run(<span class="hljs-string">&quot;colorful socks&quot;</span>))<br><br><span class="hljs-comment"># call chain</span><br>chat = ChatOpenAI(temperature=<span class="hljs-number">0</span>)<br>prompt_template = <span class="hljs-string">&quot;Tell me a &#123;adjective&#125; joke&quot;</span><br>llm_chain = LLMChain(llm=chat, prompt=PromptTemplate.from_template(prompt_template))<br><br>llm_chain(inputs=&#123;<span class="hljs-string">&quot;adjective&quot;</span>: <span class="hljs-string">&quot;corny&quot;</span>&#125;)<span class="hljs-comment">#ç”Ÿæˆåå¡«å…¥input</span><br>llm_chain(<span class="hljs-string">&quot;colorful socks&quot;</span>)<br><br><span class="hljs-comment"># åŒæ—¶ä¹Ÿå¯ä»¥é€‰æ‹©applyçš„æ–¹å¼,é€šè¿‡å¡«å…¥ä¸€ä¸ªåˆ—è¡¨,é‡Œé¢åˆ†åˆ«æ˜¯è¿™äº›å­—å…¸</span><br><br>input_list = [<br>    &#123;<span class="hljs-string">&quot;product&quot;</span>: <span class="hljs-string">&quot;socks&quot;</span>&#125;,<br>    &#123;<span class="hljs-string">&quot;product&quot;</span>: <span class="hljs-string">&quot;computer&quot;</span>&#125;,<br>    &#123;<span class="hljs-string">&quot;product&quot;</span>: <span class="hljs-string">&quot;shoes&quot;</span>&#125;<br>]<br><br>llm_chain.apply(input_list)<br>llm_chain.generate(input_list)<span class="hljs-comment">#ç›¸ä¼¼çš„åŠŸèƒ½,ä½†æ˜¯å†…å®¹ç±»å‹ä¸åŒ</span><br>llm_chain(<span class="hljs-string">&quot;corny&quot;</span>, return_only_outputs=<span class="hljs-literal">True</span>)<span class="hljs-comment">#å–æ¶ˆ</span><br>llm_chain.run(&#123;<span class="hljs-string">&quot;adjective&quot;</span>: <span class="hljs-string">&quot;corny&quot;</span>&#125;)<span class="hljs-comment">#ç­‰ä»·äºå¡«å…¥è¿™ä¸ªè¿è¡Œ,runé‡Œé¢å¿…é¡»å¡«å…¥å­—å…¸</span><br>llm_chain.predict(product=<span class="hljs-string">&quot;colorful socks&quot;</span>)<span class="hljs-comment">#è¿™é‡Œå¿…é¡»å¡«å…¥å…³é”®è¯è¿›è¡Œå®Œæˆ,å¦‚ä¸‹</span><br><br>template = <span class="hljs-string">&quot;&quot;&quot;Tell me a &#123;adjective&#125; joke about &#123;subject&#125;.&quot;&quot;&quot;</span><br>prompt = PromptTemplate(template=template, input_variables=[<span class="hljs-string">&quot;adjective&quot;</span>, <span class="hljs-string">&quot;subject&quot;</span>])<br>llm_chain = LLMChain(prompt=prompt, llm=OpenAI(temperature=<span class="hljs-number">0</span>))<br><br>llm_chain.predict(adjective=<span class="hljs-string">&quot;sad&quot;</span>, subject=<span class="hljs-string">&quot;ducks&quot;</span>)<br><br><span class="hljs-comment"># è¯­æ³•åˆ†æparsing the outputs</span><br><br><span class="hljs-comment">#å¿…é¡»å¸¦ä¸Šparsingçš„ä¿¡å·</span><br><span class="hljs-keyword">from</span> langchain.output_parsers <span class="hljs-keyword">import</span> CommaSeparatedListOutputParser<br><br>output_parser = CommaSeparatedListOutputParser()<br>template = <span class="hljs-string">&quot;&quot;&quot;List all the colors in a rainbow&quot;&quot;&quot;</span><br>prompt = PromptTemplate(template=template, input_variables=[], output_parser=output_parser)<br>llm_chain = LLMChain(prompt=prompt, llm=llm)<br><br>llm_chain.predict()<br>llm_chain.predict_and_parse()<br><br><br></code></pre></td></tr></table></figure><h3 id="modules"><a href="#modules" class="headerlink" title="modules"></a>modules</h3><h4 id="prompts"><a href="#prompts" class="headerlink" title="prompts"></a>prompts</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> langchain <span class="hljs-keyword">import</span> PromptTemplate<br>prompt_template = PromptTemplate.from_template(<br>    <span class="hljs-string">&quot;Tell me a &#123;adjective&#125; joke about &#123;content&#125;.&quot;</span><br>)<span class="hljs-comment">#å¼•å·åŠ å…¥æŠ½è±¡å†…å®¹ formatå¯ä»¥æ”¾å…¥å®ä½“</span><br>prompt_template.<span class="hljs-built_in">format</span>(adjective=<span class="hljs-string">&quot;funny&quot;</span>, content=<span class="hljs-string">&quot;chickens&quot;</span>)<br><br>invalid_prompt = PromptTemplate(<br>    input_variables=[<span class="hljs-string">&quot;adjective&quot;</span>],<span class="hljs-comment">#å¯ä»¥ä»è¿™é‡Œä¹°ä½ çš„å­—å…¸å†…å®¹è¿›è¡Œæ¯”è¾ƒ</span><br>    template=<span class="hljs-string">&quot;Tell me a &#123;adjective&#125; joke about &#123;content&#125;.&quot;</span><br>)<br><br><span class="hljs-comment">#chat prompt template</span><br><br><br>template = ChatPromptTemplate.from_messages([<br>    (<span class="hljs-string">&quot;system&quot;</span>, <span class="hljs-string">&quot;You are a helpful AI bot. Your name is &#123;name&#125;.&quot;</span>),<br>    (<span class="hljs-string">&quot;human&quot;</span>, <span class="hljs-string">&quot;Hello, how are you doing?&quot;</span>),<br>    (<span class="hljs-string">&quot;ai&quot;</span>, <span class="hljs-string">&quot;I&#x27;m doing well, thanks!&quot;</span>),<br>    (<span class="hljs-string">&quot;human&quot;</span>, <span class="hljs-string">&quot;&#123;user_input&#125;&quot;</span>),<span class="hljs-comment">#å¤šè½®äº¤æµ?</span><br>])<br><br>messages = template.format_messages(<br>    name=<span class="hljs-string">&quot;Bob&quot;</span>,<br>    user_input=<span class="hljs-string">&quot;What is your name?&quot;</span><span class="hljs-comment">#.format_messageså¯ä»¥ç”¨æ¥è¡¥å……ä¿¡æ¯</span><br>)<br><br><span class="hljs-comment"># few-shot prompt templates</span><br>examples = [<br>  &#123;<br>    <span class="hljs-string">&quot;question&quot;</span>: <span class="hljs-string">&quot;Who lived longer, Muhammad Ali or Alan Turing?&quot;</span>,<br>    <span class="hljs-string">&quot;answer&quot;</span>: <br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">Are follow up questions needed here: Yes.</span><br><span class="hljs-string">Follow up: How old was Muhammad Ali when he died?</span><br><span class="hljs-string">Intermediate answer: Muhammad Ali was 74 years old when he died.</span><br><span class="hljs-string">Follow up: How old was Alan Turing when he died?</span><br><span class="hljs-string">Intermediate answer: Alan Turing was 41 years old when he died.</span><br><span class="hljs-string">So the final answer is: Muhammad Ali</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br>  &#125;] <span class="hljs-comment">#examplesè¡¨ç°å½¢å¼ä¸ºåˆ—è¡¨ä¸­åµŒå…¥ç›¸å…³çš„å­—å…¸</span><br>example_prompt = PromptTemplate(input_variables=[<span class="hljs-string">&quot;question&quot;</span>, <span class="hljs-string">&quot;answer&quot;</span>], template=<span class="hljs-string">&quot;Question: &#123;question&#125;\n&#123;answer&#125;&quot;</span>)<br><br><span class="hljs-built_in">print</span>(example_prompt.<span class="hljs-built_in">format</span>(**examples[<span class="hljs-number">0</span>]))<span class="hljs-comment">## **åœ¨pythonä¸­ä¼ é€’äº†å­—å…¸ä¸­çš„å¥å¯¹å€¼</span><br><br>prompt = FewShotPromptTemplate(<br>    examples=examples, <br>    example_prompt=example_prompt, <br>    suffix=<span class="hljs-string">&quot;Question: &#123;input&#125;&quot;</span>, <span class="hljs-comment">#æ·»åŠ ä¸€ä¸ªåç¼€</span><br>    input_variables=[<span class="hljs-string">&quot;input&quot;</span>],<span class="hljs-comment">#åŠ å…¥ä¸€ä¸ªinputä½œä¸ºä¸€ä¸ªè¾“å‡ºå˜é‡,æ”¾åœ¨åé¢ç”¨æ¥å¡«å…¥</span><br>)<br><br><span class="hljs-built_in">print</span>(prompt.<span class="hljs-built_in">format</span>(<span class="hljs-built_in">input</span>=<span class="hljs-string">&quot;Who was the father of Mary Ball Washington?&quot;</span>))<span class="hljs-comment">#åŒæ—¶formatæ˜¯ç›´æ¥æŠŠè¿™ä¸ªå­—ç¬¦ä¸²ç”¨æ¥è¿”å›</span><br><br><span class="hljs-comment"># é€šè¿‡exampleselectorå®Œæˆç›¸å…³çš„æ“ä½œ</span><br><span class="hljs-keyword">from</span> langchain.prompts.example_selector <span class="hljs-keyword">import</span> SemanticSimilarityExampleSelector<br><span class="hljs-keyword">from</span> langchain.vectorstores <span class="hljs-keyword">import</span> Chroma<br><span class="hljs-keyword">from</span> langchain.embeddings <span class="hljs-keyword">import</span> OpenAIEmbeddings<br>example_selector = SemanticSimilarityExampleSelector.from_examples(<br>    <span class="hljs-comment"># This is the list of examples available to select from.</span><br>    examples,<br>    <span class="hljs-comment"># This is the embedding class used to produce embeddings which are used to measure semantic similarity.</span><br>    OpenAIEmbeddings(),<br>    <span class="hljs-comment"># This is the VectorStore class that is used to store the embeddings and do a similarity search over.</span><br>    Chroma,<br>    <span class="hljs-comment"># This is the number of examples to produce.</span><br>    k=<span class="hljs-number">1</span><br>)<br><br><span class="hljs-comment"># Few-shot examples for chat models - API</span><br>langchain.prompts.few_shot.FewShotChatMessagePromptTemplate ç±»<br>examples = [<br>    &#123;<span class="hljs-string">&quot;input&quot;</span>: <span class="hljs-string">&quot;2+2&quot;</span>, <span class="hljs-string">&quot;output&quot;</span>: <span class="hljs-string">&quot;4&quot;</span>&#125;,<br>    &#123;<span class="hljs-string">&quot;input&quot;</span>: <span class="hljs-string">&quot;2+3&quot;</span>, <span class="hljs-string">&quot;output&quot;</span>: <span class="hljs-string">&quot;5&quot;</span>&#125;,<span class="hljs-comment">#ç›¸å½“äºä¸¤ä¸ª</span><br>]<br>example_prompt = ChatPromptTemplate.from_messages(<br>    [(<span class="hljs-string">&#x27;human&#x27;</span>, <span class="hljs-string">&#x27;&#123;input&#125;&#x27;</span>), (<span class="hljs-string">&#x27;ai&#x27;</span>, <span class="hljs-string">&#x27;&#123;output&#125;&#x27;</span>)]<br>)<br>few_shot_prompt = FewShotChatMessagePromptTemplate(<br>    examples=examples,<br>    <span class="hljs-comment"># This is a prompt template used to format each individual example.</span><br>    example_prompt=example_prompt,<br>)<br>final_prompt = ChatPromptTemplate.from_messages(<br>    [<br>        (<span class="hljs-string">&#x27;system&#x27;</span>, <span class="hljs-string">&#x27;You are a helpful AI Assistant&#x27;</span>),<br>        few_shot_prompt,<br>        (<span class="hljs-string">&#x27;human&#x27;</span>, <span class="hljs-string">&#x27;&#123;input&#125;&#x27;</span>),<br>    ]<br>)<br><br><span class="hljs-comment">#root chain</span><br><br><br></code></pre></td></tr></table></figure><h3 id="memory"><a href="#memory" class="headerlink" title="memory"></a>memory</h3><h4 id="store"><a href="#store" class="headerlink" title="store"></a>store</h4><p>å‘ƒå‘ƒ,æ„Ÿè§‰è¿™ä¸ªå•å…ƒæœ‰ç‚¹åƒå­˜åœ¨ç¬¬ä¸‰æ–¹åº“é‡Œé¢?</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#é€šè¿‡chatmessagehistortyç±»æ¥å®Œæˆç›¸å…³æ“ä½œ</span><br><span class="hljs-keyword">from</span> langchain.memory <span class="hljs-keyword">import</span> ChatMessageHistory<br>history = ChatMessageHistory()<br>history.add_user_message(<span class="hljs-string">&quot;HI&quot;</span>)<br>history.add_ai_message(<span class="hljs-string">&quot;what&#x27;s up?&quot;</span>)<br>history.messages<br>    [HumanMessage(content=<span class="hljs-string">&#x27;hi!&#x27;</span>, additional_kwargs=&#123;&#125;),<br>     AIMessage(content=<span class="hljs-string">&#x27;whats up?&#x27;</span>, additional_kwargs=&#123;&#125;)]<br><br><span class="hljs-comment">#for start</span><br><span class="hljs-keyword">from</span> langchain.memory <span class="hljs-keyword">import</span> ConversationBufferjMemory<br>memory = ConversationBufferMemory()<br>memory = ConversationBufferMemory(memory_key=<span class="hljs-string">&quot;chat_history&quot;</span>)<span class="hljs-comment">#æŠŠhistoryçš„é”®å€¼æ›´æ”¹</span><br>memory.chat_memory.add_user_message(<span class="hljs-string">&quot;hi!&quot;</span>)<br>memory.chat_memory.add_ai_message(<span class="hljs-string">&quot;what&#x27;s up?&quot;</span>)<br>memory.load_memory_variables(&#123;&#125;)<span class="hljs-comment">#åŒæ—¶å¯ä»¥å‘ç°é‡Œé¢æ”¾å…¥çš„æ˜¯å­—å…¸åŒæ—¶å«æœ‰historyä»¥åŠAI: å¯ä»¥ä½¿ç”¨</span><br><br>memory = ConversationBufferMemory(return_messages=<span class="hljs-literal">True</span>)<br>memory.chat_memory.add_user_message(<span class="hljs-string">&quot;hi!&quot;</span>)<br>memory.chat_memory.add_ai_message(<span class="hljs-string">&quot;what&#x27;s up?&quot;</span>)<br><span class="hljs-comment">#return list of memory</span><br><span class="hljs-comment">#å¯ä»¥é€šè¿‡input_keyä»¥åŠoutput_keyå®ç°å‚æ•°ç›¸å…³çš„æ–¹æ¡ˆ</span><br><br><span class="hljs-comment"># end to end</span><br><span class="hljs-keyword">from</span> langchain.llms <span class="hljs-keyword">import</span> OpenAI<br><span class="hljs-keyword">from</span> langchain.prompts <span class="hljs-keyword">import</span> PromptTemplate<br><span class="hljs-keyword">from</span> langchain.chains <span class="hljs-keyword">import</span> LLMChain<br><span class="hljs-keyword">from</span> langchain.memory <span class="hljs-keyword">import</span> ConversationBufferMemory<br><br><br>llm = OpenAI(temperature=<span class="hljs-number">0</span>)<br><span class="hljs-comment"># Notice that &quot;chat_history&quot; is present in the prompt template</span><br>template = <span class="hljs-string">&quot;&quot;&quot;You are a nice chatbot having a conversation with a human.</span><br><span class="hljs-string"></span><br><span class="hljs-string">Previous conversation:</span><br><span class="hljs-string">&#123;chat_history&#125;</span><br><span class="hljs-string"></span><br><span class="hljs-string">New human question: &#123;question&#125;</span><br><span class="hljs-string">Response:&quot;&quot;&quot;</span><br>prompt = PromptTemplate.from_template(template)<br><span class="hljs-comment"># Notice that we need to align the `memory_key`</span><br>memory = ConversationBufferMemory(memory_key=<span class="hljs-string">&quot;chat_history&quot;</span>)<br>conversation = LLMChain(<br>    llm=llm,<br>    prompt=prompt,<br>    verbose=<span class="hljs-literal">True</span>,<br>    memory=memory<br>)<br><span class="hljs-comment"># Notice that we just pass in the `question` variables - `chat_history` gets populated by memory</span><br>conversation(&#123;<span class="hljs-string">&quot;question&quot;</span>: <span class="hljs-string">&quot;hi&quot;</span>&#125;)<br><br><span class="hljs-comment"># Memory in LLMChain</span><br><span class="hljs-keyword">from</span> langchain.chains <span class="hljs-keyword">import</span> LLMChain<br><span class="hljs-keyword">from</span> langchain.llms <span class="hljs-keyword">import</span> OpenAI<br><span class="hljs-keyword">from</span> langchain.memory <span class="hljs-keyword">import</span> ConversationBufferMemory<br><span class="hljs-keyword">from</span> langchain.prompts <span class="hljs-keyword">import</span> PromptTemplate<br><br>template = <span class="hljs-string">&quot;&quot;&quot;You are a chatbot having a conversation with a human.</span><br><span class="hljs-string"></span><br><span class="hljs-string">&#123;chat_history&#125;</span><br><span class="hljs-string">Human: &#123;human_input&#125;</span><br><span class="hljs-string">Chatbot:&quot;&quot;&quot;</span><br><br>prompt = PromptTemplate(<br>    input_variables=[<span class="hljs-string">&quot;chat_history&quot;</span>, <span class="hljs-string">&quot;human_input&quot;</span>], template=template<br>)<br><span class="hljs-comment">#è¿™ä¸ªåº”è¯¥ä»£è¡¨çš„æ˜¯å¯ä»¥åœ¨é‡Œé¢è¾“å…¥å˜é‡,åŒæ—¶é€šè¿‡æŒ‡æ˜input_variablesä¸ºå¤–éƒ¨å˜é‡,å¯ä»¥åœ¨ä¹‹åæ·»åŠ è¿›å»</span><br>memory = ConversationBufferMemory(memory_key=<span class="hljs-string">&quot;chat_history&quot;</span>)<br>llm = OpenAI()<br>llm_chain = LLMChain(<br>    llm=llm,<br>    prompt=prompt,<br>    verbose=<span class="hljs-literal">True</span>,<br>    memory=memory,<br>)<br><span class="hljs-comment">#langchainæä¾›äº†memortæ¥å£,åº”è¯¥å¯ä»¥è‡ªåŠ¨é“¾æ¥prompté‡Œçš„æ•°æ®ä»¥åŠmemoryé‡Œçš„æ•°æ®ä¸”æ ‡ç­¾ä¸ºchat_history</span><br>llm_chain.predict(human_input=<span class="hljs-string">&quot;Hi there my friend&quot;</span>) <span class="hljs-comment"># è¿™é‡Œé€šè¿‡å­—ç¬¦ä¸²çš„æ–¹å¼è¿›è¡Œé¢„æµ‹</span><br><br><br><span class="hljs-comment"># å¢åŠ è®°å¿†LLM</span><br><span class="hljs-keyword">from</span> langchain.chat_models <span class="hljs-keyword">import</span> ChatOpenAI<br><span class="hljs-keyword">from</span> langchain.schema <span class="hljs-keyword">import</span> SystemMessage<br><span class="hljs-keyword">from</span> langchain.prompts <span class="hljs-keyword">import</span> ChatPromptTemplate, HumanMessagePromptTemplate, MessagesPlaceholder<br><br>prompt = ChatPromptTemplate.from_messages([<span class="hljs-comment"># ç»„åˆæ•°æ®çš„å½¢å¼</span><br>    SystemMessage(content=<span class="hljs-string">&quot;You are a chatbot having a conversation with a human.&quot;</span>), <span class="hljs-comment"># The persistent system prompt</span><br>    MessagesPlaceholder(variable_name=<span class="hljs-string">&quot;chat_history&quot;</span>), <span class="hljs-comment"># Where the memory will be stored.è®°å¿†å­˜å‚¨çš„key</span><br>    HumanMessagePromptTemplate.from_template(<span class="hljs-string">&quot;&#123;human_input&#125;&quot;</span>), <span class="hljs-comment"># Where the human input will injected</span><br>])<br>    <br>memory = ConversationBufferMemory(memory_key=<span class="hljs-string">&quot;chat_history&quot;</span>, return_messages=<span class="hljs-literal">True</span>)<br><br><br><span class="hljs-comment"># Memory in the Multi-Input Chain</span><br><span class="hljs-keyword">from</span> langchain.embeddings.openai <span class="hljs-keyword">import</span> OpenAIEmbeddings<br><span class="hljs-keyword">from</span> langchain.embeddings.cohere <span class="hljs-keyword">import</span> CohereEmbeddings<br><span class="hljs-keyword">from</span> langchain.text_splitter <span class="hljs-keyword">import</span> CharacterTextSplitter<br><span class="hljs-keyword">from</span> langchain.vectorstores.elastic_vector_search <span class="hljs-keyword">import</span> ElasticVectorSearch<br><span class="hljs-keyword">from</span> langchain.vectorstores <span class="hljs-keyword">import</span> Chroma<br><span class="hljs-keyword">from</span> langchain.docstore.document <span class="hljs-keyword">import</span> Document<br><br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;../../state_of_the_union.txt&quot;</span>) <span class="hljs-keyword">as</span> f:<br>    state_of_the_union = f.read()<br>text_splitter = CharacterTextSplitter(chunk_size=<span class="hljs-number">1000</span>, chunk_overlap=<span class="hljs-number">0</span>)<br>texts = text_splitter.split_text(state_of_the_union)<br><br>embeddings = OpenAIEmbeddings()<br>docsearch = Chroma.from_texts(<br>    texts, embeddings, metadatas=[&#123;<span class="hljs-string">&quot;source&quot;</span>: i&#125; <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(texts))]<br>)<span class="hljs-comment"># æŒ‰ç…§source textsæ¯ä¸€ä¸ªå•å…ƒéƒ½ä½œä¸ºåµŒå…¥æ•°æ®å¤„ç†</span><br>query = <span class="hljs-string">&quot;What did the president say about Justice Breyer&quot;</span><br>docs = docsearch.similarity_search(query) <span class="hljs-comment"># æ•°æ®åº“å¯ä»¥ç›´æ¥ä½¿ç”¨å…¶å¤„ç† .similarity_search()æ£€ç´¢</span><br><br><span class="hljs-keyword">from</span> langchain.chains.question_answering <span class="hljs-keyword">import</span> load_qa_chain<br><span class="hljs-keyword">from</span> langchain.llms <span class="hljs-keyword">import</span> OpenAI<br><span class="hljs-keyword">from</span> langchain.prompts <span class="hljs-keyword">import</span> PromptTemplate<br><span class="hljs-keyword">from</span> langchain.memory <span class="hljs-keyword">import</span> ConversationBufferMemory<br><br>template = <span class="hljs-string">&quot;&quot;&quot;You are a chatbot having a conversation with a human.</span><br><span class="hljs-string"></span><br><span class="hljs-string">Given the following extracted parts of a long document and a question, create a final answer.</span><br><span class="hljs-string"></span><br><span class="hljs-string">&#123;context&#125;</span><br><span class="hljs-string"></span><br><span class="hljs-string">&#123;chat_history&#125;</span><br><span class="hljs-string">Human: &#123;human_input&#125;</span><br><span class="hljs-string">Chatbot:&quot;&quot;&quot;</span><br><br>prompt = PromptTemplate(<br>    input_variables=[<span class="hljs-string">&quot;chat_history&quot;</span>, <span class="hljs-string">&quot;human_input&quot;</span>, <span class="hljs-string">&quot;context&quot;</span>], template=template<br>)<br>memory = ConversationBufferMemory(memory_key=<span class="hljs-string">&quot;chat_history&quot;</span>, input_key=<span class="hljs-string">&quot;human_input&quot;</span>)<span class="hljs-comment">#</span><br>chain = load_qa_chain(<br>    OpenAI(temperature=<span class="hljs-number">0</span>), chain_type=<span class="hljs-string">&quot;stuff&quot;</span>, memory=memory, prompt=prompt<br>)<br><span class="hljs-comment"># memory in agent</span><br><br>search = GoogleSearchAPIWrapper()<br>tools = [<br>    Tool(<span class="hljs-comment">#? </span><br>        name=<span class="hljs-string">&quot;Search&quot;</span>,<span class="hljs-comment">#ming ming</span><br>        func=search.run,<span class="hljs-comment">#å‡½æ•°åŠŸèƒ½</span><br>        description=<span class="hljs-string">&quot;useful for when you need to answer questions about current events&quot;</span>,<br>    )<br>]<span class="hljs-comment">#å¯ä»¥ä½¿ç”¨çš„åŠŸèƒ½</span><br><br><br>prefix = <span class="hljs-string">&quot;&quot;&quot;Have a conversation with a human, answering the following questions as best you can. You have access to the following tools:&quot;&quot;&quot;</span><br>suffix = <span class="hljs-string">&quot;&quot;&quot;Begin!&quot;</span><br><span class="hljs-string"></span><br><span class="hljs-string">&#123;chat_history&#125;</span><br><span class="hljs-string">Question: &#123;input&#125;</span><br><span class="hljs-string">&#123;agent_scratchpad&#125;&quot;&quot;&quot;</span><br><span class="hljs-comment"># </span><br>prompt = ZeroShotAgent.create_prompt(<br>    tools,<br>    prefix=prefix,<br>    suffix=suffix,<br>    input_variables=[<span class="hljs-string">&quot;input&quot;</span>, <span class="hljs-string">&quot;chat_history&quot;</span>, <span class="hljs-string">&quot;agent_scratchpad&quot;</span>],<br>)<span class="hljs-comment"># ? å¯ä»¥ç›´æ¥åµŒå…¥å‰ç¼€ä»¥åŠåç¼€å—</span><br><br>memory = ConversationBufferMemory(memory_key=<span class="hljs-string">&quot;chat_history&quot;</span>)<span class="hljs-comment">#æŒ‰ç…§ä¹‹å‰çš„</span><br><br>llm_chain = LLMChain(llm=OpenAI(temperature=<span class="hljs-number">0</span>), prompt=prompt)<br>agent = ZeroShotAgent(llm_chain=llm_chain, tools=tools, verbose=<span class="hljs-literal">True</span>)<span class="hljs-comment">#ä»£ç†äºº, å·¥å…·</span><br>agent_chain = AgentExecutor.from_agent_and_tools(<br>    agent=agent, tools=tools, verbose=<span class="hljs-literal">True</span>, memory=memory<br>)<span class="hljs-comment">#memory é‡æ–°åµŒå…¥agent_chain </span><br><br><br><br><br></code></pre></td></tr></table></figure><h3 id="retrieve-æ£€ç´¢å™¨"><a href="#retrieve-æ£€ç´¢å™¨" class="headerlink" title="retrieve æ£€ç´¢å™¨"></a>retrieve æ£€ç´¢å™¨</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br></pre></td><td class="code"><pre><code class="hljs python"><br><span class="hljs-comment"># quick start!</span><br><br><br><span class="hljs-comment">#document loader - ex for csv-&gt;ä»¥é€—å·ä½œä¸ºåˆ†éš”çš„æ–‡ä»¶</span><br><span class="hljs-keyword">from</span> langchain.document_loaders.csv_loader <span class="hljs-keyword">import</span> CSVLoader<br>loader = CSVLoader(file_path = <span class="hljs-string">&#x27;./example_data/mllb_teams_2012.csv&#x27;</span>)<br>data = loader.load()<br><br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;../../state_of_the_union.txt&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>    state_of_the_union = f.read()<br><span class="hljs-keyword">from</span> langchain.text_splitter <span class="hljs-keyword">import</span> RecursiveCharacterTextSplitter<br>text_splitter = RecursiveCharacterTextSplitter(<br>    <span class="hljs-comment"># Set a really small chunk size, just to show.</span><br>    chunk_size = <span class="hljs-number">100</span>,<span class="hljs-comment">#æœ€é•¿æ•°é‡</span><br>    chunk_overlap  = <span class="hljs-number">20</span>,<span class="hljs-comment">#é‡å æ•°é‡</span><br>    length_function = <span class="hljs-built_in">len</span>,<br>    add_start_index = <span class="hljs-literal">True</span>,<span class="hljs-comment">#åˆ‡å‰²åçš„å¼€å§‹å­—ç¬¦åœ¨åŸæ¥çš„æ•°ç»„ä¸­çš„ä½ç½®</span><br>)<br><br><span class="hljs-comment">#---ä»¥ä¸Šç•¥å»äº†ä¸€äº›å…¶ä»–çš„åˆ‡å‰²æ–¹å¼</span><br><br><span class="hljs-comment">#Lost in the middle: The problem with long contexts:When models must access relevant information in the middle of long contexts, they tend to ignore the provided documents</span><br><span class="hljs-comment">#é‡‡ç”¨é‡æ–°æ‰“ä¹±çš„æ–¹å¼å®Œæˆ(æ£€ç´¢ä¹‹å)</span><br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">import</span> chromadb<br><span class="hljs-keyword">from</span> langchain.vectorstores <span class="hljs-keyword">import</span> Chroma<br><span class="hljs-keyword">from</span> langchain.embeddings <span class="hljs-keyword">import</span> HuggingFaceEmbeddings<br><span class="hljs-keyword">from</span> langchain.document_transformers <span class="hljs-keyword">import</span> (<br>    LongContextReorder,<br>)<br><span class="hljs-keyword">from</span> langchain.chains <span class="hljs-keyword">import</span> StuffDocumentsChain, LLMChain<br><span class="hljs-keyword">from</span> langchain.prompts <span class="hljs-keyword">import</span> PromptTemplate<br><span class="hljs-keyword">from</span> langchain.llms <span class="hljs-keyword">import</span> OpenAI<br><br><span class="hljs-comment"># Get embeddings.</span><br>embeddings = HuggingFaceEmbeddings(model_name=<span class="hljs-string">&quot;all-MiniLM-L6-v2&quot;</span>)<br><br>texts = [<br>    <span class="hljs-string">&quot;Basquetball is a great sport.&quot;</span>,<br>    <span class="hljs-string">&quot;Fly me to the moon is one of my favourite songs.&quot;</span>,<br>    <span class="hljs-string">&quot;The Celtics are my favourite team.&quot;</span>,<br>    <span class="hljs-string">&quot;This is a document about the Boston Celtics&quot;</span>,<br>    <span class="hljs-string">&quot;I simply love going to the movies&quot;</span>,<br>    <span class="hljs-string">&quot;The Boston Celtics won the game by 20 points&quot;</span>,<br>    <span class="hljs-string">&quot;This is just a random text.&quot;</span>,<br>    <span class="hljs-string">&quot;Elden Ring is one of the best games in the last 15 years.&quot;</span>,<br>    <span class="hljs-string">&quot;L. Kornet is one of the best Celtics players.&quot;</span>,<br>    <span class="hljs-string">&quot;Larry Bird was an iconic NBA player.&quot;</span>,<br>]<br><br><span class="hljs-comment"># Create a retriever</span><br>retriever = Chroma.from_texts(texts, embedding=embeddings).as_retriever(<br>    search_kwargs=&#123;<span class="hljs-string">&quot;k&quot;</span>: <span class="hljs-number">10</span>&#125;<br>)<br>query = <span class="hljs-string">&quot;What can you tell me about the Celtics?&quot;</span><br><br><span class="hljs-comment"># Get relevant documents ordered by relevance score</span><br>docs = retriever.get_relevant_documents(query)<br>docs<br><span class="hljs-comment">#è¿™ä¸ªbä¸œè¥¿ç©¿æ¨¡äº†å§</span><br><br><span class="hljs-comment">#embedding</span><br><span class="hljs-keyword">from</span> langchain.embeddings <span class="hljs-keyword">import</span> OpenAIEmbeddings<br><br>embeddings_model = OpenAIEmbeddings()<span class="hljs-comment">#ç›´æ¥è®¾ç½®</span><br>embeddings = embeddings_model.embed_documents(<br>    [<br>        <span class="hljs-string">&quot;Hi there!&quot;</span>,<br>        <span class="hljs-string">&quot;Oh, hello!&quot;</span>,<br>        <span class="hljs-string">&quot;What&#x27;s your name?&quot;</span>,<br>        <span class="hljs-string">&quot;My friends call me World&quot;</span>,<br>        <span class="hljs-string">&quot;Hello World!&quot;</span><br>    ]<br>)<span class="hljs-comment">#åˆ†è§£çš„æ—¶å€™æ”¯æŒåˆ—è¡¨é‡Œçš„å¤šä¸ªå­—ç¬¦ä¸²çš„å½¢å¼</span><br><span class="hljs-built_in">len</span>(embeddings), <span class="hljs-built_in">len</span>(embeddings[<span class="hljs-number">0</span>])<span class="hljs-comment">#è¡¨ç¤ºæœ‰å¤šå°‘è¡Œçš„å˜é‡é•¿åº¦</span><br><br>embedded_query = embeddings_model.embed_query(<span class="hljs-string">&quot;What was the name mentioned in the conversation?&quot;</span>)<br>embedded_query[:<span class="hljs-number">5</span>]<span class="hljs-comment">#è¯¢é—®ä»¥åŠå…¶ä»–çš„å«æœ‰ä¸åŒçš„è¡¨å¾å½¢å¼</span><br><br><span class="hljs-comment">#æ”¯æŒcachingæŠ€æœ¯</span><br><span class="hljs-comment">#TODO</span><br><span class="hljs-comment">#Vector stores </span><br><span class="hljs-comment">#å­˜å‚¨embeddingå‘é‡åŒæ—¶ä¹‹åç”¨äºæŸ¥è¯¢çš„æ–¹å¼</span><br><span class="hljs-keyword">from</span> langchain.document_loaders <span class="hljs-keyword">import</span> TextLoader<br><span class="hljs-keyword">from</span> langchain.embeddings.openai <span class="hljs-keyword">import</span> OpenAIEmbeddings<br><span class="hljs-keyword">from</span> langchain.text_splitter <span class="hljs-keyword">import</span> CharacterTextSplitter<br><span class="hljs-keyword">from</span> langchain.vectorstores <span class="hljs-keyword">import</span> FAISS<br><br><span class="hljs-comment"># Load the document, split it into chunks, embed each chunk and load it into the vector store.</span><br>raw_documents = TextLoader(<span class="hljs-string">&#x27;../../../state_of_the_union.txt&#x27;</span>).load()<br>text_splitter = CharacterTextSplitter(chunk_size=<span class="hljs-number">1000</span>, chunk_overlap=<span class="hljs-number">0</span>)<br>documents = text_splitter.split_documents(raw_documents)<span class="hljs-comment">#å·²ç»å®Œæˆç›¸å…³çš„åˆ‡å‰²äº†</span><br>db = FAISS.from_documents(documents, OpenAIEmbeddings())<br><span class="hljs-comment">#ç›¸ä¼¼æ€§çš„æŸ¥è¯¢</span><br>query = <span class="hljs-string">&quot;What did the president say about Ketanji Brown Jackson&quot;</span><br>docs = db.similarity_search(query)<br><span class="hljs-built_in">print</span>(docs[<span class="hljs-number">0</span>].page_content)<br><span class="hljs-comment">#vectoræŸ¥è¯¢</span><br>embedding_vector = OpenAIEmbeddings().embed_query(query)<br>docs = db.similarity_search_by_vector(embedding_vector)<br><span class="hljs-built_in">print</span>(docs[<span class="hljs-number">0</span>].page_content)<br><span class="hljs-comment">#ç»“æœä¸€è‡´</span><br><br><span class="hljs-comment">#retrieve QUICK START</span><br><span class="hljs-keyword">from</span> abc <span class="hljs-keyword">import</span> ABC, abstractmethod<br><span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">Any</span>, <span class="hljs-type">List</span><br><span class="hljs-keyword">from</span> langchain.schema <span class="hljs-keyword">import</span> Document<br><span class="hljs-keyword">from</span> langchain.callbacks.manager <span class="hljs-keyword">import</span> Callbacks<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">BaseRetriever</span>(<span class="hljs-title class_ inherited__">ABC</span>):<br>    ...<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_relevant_documents</span>(<span class="hljs-params"></span><br><span class="hljs-params">        self, query: <span class="hljs-built_in">str</span>, *, callbacks: Callbacks = <span class="hljs-literal">None</span>, **kwargs: <span class="hljs-type">Any</span></span><br><span class="hljs-params">    </span>) -&gt; <span class="hljs-type">List</span>[Document]:<br>        <span class="hljs-string">&quot;&quot;&quot;Retrieve documents relevant to a query.</span><br><span class="hljs-string">        Args:</span><br><span class="hljs-string">            query: string to find relevant documents for</span><br><span class="hljs-string">            callbacks: Callback manager or list of callbacks</span><br><span class="hljs-string">        Returns:</span><br><span class="hljs-string">            List of relevant documents</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        ...<br><br>    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">aget_relevant_documents</span>(<span class="hljs-params"></span><br><span class="hljs-params">        self, query: <span class="hljs-built_in">str</span>, *, callbacks: Callbacks = <span class="hljs-literal">None</span>, **kwargs: <span class="hljs-type">Any</span></span><br><span class="hljs-params">    </span>) -&gt; <span class="hljs-type">List</span>[Document]:<br>        <span class="hljs-string">&quot;&quot;&quot;Asynchronously get documents relevant to a query.</span><br><span class="hljs-string">        Args:</span><br><span class="hljs-string">            query: string to find relevant documents for</span><br><span class="hljs-string">            callbacks: Callback manager or list of callbacks</span><br><span class="hljs-string">        Returns:</span><br><span class="hljs-string">            List of relevant documents</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        ...<br><br><span class="hljs-keyword">from</span> langchain.chains <span class="hljs-keyword">import</span> RetrievalQA<br><span class="hljs-keyword">from</span> langchain.llms <span class="hljs-keyword">import</span> OpenAI<br><span class="hljs-keyword">from</span> langchain.document_loaders <span class="hljs-keyword">import</span> TextLoader<br>loader = TextLoader(<span class="hljs-string">&#x27;../state_of_the_union.txt&#x27;</span>, encoding=<span class="hljs-string">&#x27;utf8&#x27;</span>)<br><span class="hljs-keyword">from</span> langchain.indexes <span class="hljs-keyword">import</span> VectorstoreIndexCreator<br>index = VectorstoreIndexCreator().from_loaders([loader])<span class="hljs-comment">#</span><br>query = <span class="hljs-string">&quot;What did the president say about Ketanji Brown Jackson&quot;</span><br>index.query_with_sources(query)<span class="hljs-comment">#è¿”å›ç›¸å…³çš„å­—ç¬¦ä¸²</span><br>query = <span class="hljs-string">&quot;What did the president say about Ketanji Brown Jackson&quot;</span><br>index.query_with_sources(query)<span class="hljs-comment">#å­—å…¸ å«æœ‰è¯¦ç»†çš„ç›¸å…³çš„æ–‡æœ¬</span><br>index.query(<span class="hljs-string">&quot;Summarize the general content of this document.&quot;</span>, retriever_kwargs=&#123;<span class="hljs-string">&quot;search_kwargs&quot;</span>: &#123;<span class="hljs-string">&quot;filter&quot;</span>: &#123;<span class="hljs-string">&quot;source&quot;</span>: <span class="hljs-string">&quot;../state_of_the_union.txt&quot;</span>&#125;&#125;&#125;)<span class="hljs-comment">#åŒæ—¶å¯ä»¥é€‰æ‹©è¿‡æ»¤çš„æ–¹å¼</span><br><br><br><span class="hljs-comment">#muliquery use</span><br><br><br><span class="hljs-comment"># Build a sample vectorDB</span><br><span class="hljs-keyword">from</span> langchain.vectorstores <span class="hljs-keyword">import</span> Chroma<br><span class="hljs-keyword">from</span> langchain.document_loaders <span class="hljs-keyword">import</span> WebBaseLoader<br><span class="hljs-keyword">from</span> langchain.embeddings.openai <span class="hljs-keyword">import</span> OpenAIEmbeddings<br><span class="hljs-keyword">from</span> langchain.text_splitter <span class="hljs-keyword">import</span> RecursiveCharacterTextSplitter<br><br><span class="hljs-comment"># Load blog post</span><br>loader = WebBaseLoader(<span class="hljs-string">&quot;https://lilianweng.github.io/posts/2023-06-23-agent/&quot;</span>)<br>data = loader.load()<br><br><span class="hljs-comment"># Split</span><br>text_splitter = RecursiveCharacterTextSplitter(chunk_size=<span class="hljs-number">500</span>, chunk_overlap=<span class="hljs-number">0</span>)<br>splits = text_splitter.split_documents(data)<br><br><span class="hljs-comment"># VectorDB</span><br>embedding = OpenAIEmbeddings()<br>vectordb = Chroma.from_documents(documents=splits, embedding=embedding)<br><span class="hljs-comment">#chromaè¡¨ç¤ºsplitç”¨embeddingå¤„ç†åå­˜å…¥æ•°æ®åº“</span><br><span class="hljs-keyword">from</span> langchain.chat_models <span class="hljs-keyword">import</span> ChatOpenAI<br><span class="hljs-keyword">from</span> langchain.retrievers.multi_query <span class="hljs-keyword">import</span> MultiQueryRetriever<br><br>question = <span class="hljs-string">&quot;What are the approaches to Task Decomposition?&quot;</span><br>llm = ChatOpenAI(temperature=<span class="hljs-number">0</span>)<br>retriever_from_llm = MultiQueryRetriever.from_llm(<br>    retriever=vectordb.as_retriever(), llm=llm<br>)<br>unique_docs = retriever_from_llm.get_relevant_documents(query=question)<span class="hljs-comment">#è¡¨ç¤ºä¾æ®è¯¢é—®,è¿ç»­äº§ç”Ÿç›¸å…³çš„ç–‘é—®æ¥è¿›è¡Œæ£€ç´¢</span><br><span class="hljs-built_in">len</span>(unique_docs)<br><span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">List</span><br><span class="hljs-keyword">from</span> langchain <span class="hljs-keyword">import</span> LLMChain<br><span class="hljs-keyword">from</span> pydantic <span class="hljs-keyword">import</span> BaseModel, Field<span class="hljs-comment">#æ•°æ®éªŒè¯åº“ å¯ä»¥å®šä¹‰ä¸åŒåå­—çš„ç±»</span><br><span class="hljs-keyword">from</span> langchain.prompts <span class="hljs-keyword">import</span> PromptTemplate<br><span class="hljs-keyword">from</span> langchain.output_parsers <span class="hljs-keyword">import</span> PydanticOutputParser<br><br><br><span class="hljs-comment"># Output parser will split the LLM result into a list of queries</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">LineList</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):<br>    <span class="hljs-comment"># &quot;lines&quot; is the key (attribute name) of the parsed output</span><br>    lines: <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>] = Field(description=<span class="hljs-string">&quot;Lines of text&quot;</span>)<br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">LineListOutputParser</span>(<span class="hljs-title class_ inherited__">PydanticOutputParser</span>):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-literal">None</span>:<br>        <span class="hljs-built_in">super</span>().__init__(pydantic_object=LineList)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">parse</span>(<span class="hljs-params">self, text: <span class="hljs-built_in">str</span></span>) -&gt; LineList:<br>        lines = text.strip().split(<span class="hljs-string">&quot;\n&quot;</span>)<br>        <span class="hljs-keyword">return</span> LineList(lines=lines)<br><br><br>output_parser = LineListOutputParser()<br><br>QUERY_PROMPT = PromptTemplate(<br>    input_variables=[<span class="hljs-string">&quot;question&quot;</span>],<br>    template=<span class="hljs-string">&quot;&quot;&quot;You are an AI language model assistant. Your task is to generate five </span><br><span class="hljs-string">    different versions of the given user question to retrieve relevant documents from a vector </span><br><span class="hljs-string">    database. By generating multiple perspectives on the user question, your goal is to help</span><br><span class="hljs-string">    the user overcome some of the limitations of the distance-based similarity search. </span><br><span class="hljs-string">    Provide these alternative questions seperated by newlines.</span><br><span class="hljs-string">    Original question: &#123;question&#125;&quot;&quot;&quot;</span>,<br>)<br>llm = ChatOpenAI(temperature=<span class="hljs-number">0</span>)<br><br><span class="hljs-comment"># Chain</span><br>llm_chain = LLMChain(llm=llm, prompt=QUERY_PROMPT, output_parser=output_parser)<br><br><span class="hljs-comment"># Other inputs</span><br>question = <span class="hljs-string">&quot;What are the approaches to Task Decomposition?&quot;</span><br><br><span class="hljs-comment"># æŒ‰æ—¶é—´æ£€ç´¢å®Œæˆ</span><br>scoring = semantic_similarity + (<span class="hljs-number">1.0</span> - decay_rate) ^ hours_passed<br><span class="hljs-comment">#æ¯ä¸€æ¬¡accesséƒ½éœ€è¦æ›´æ–°è‡ªå·±çš„è®°å¿†</span><br><span class="hljs-keyword">import</span> faiss<br><br><span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> datetime, timedelta<br><span class="hljs-keyword">from</span> langchain.docstore <span class="hljs-keyword">import</span> InMemoryDocstore<br><span class="hljs-keyword">from</span> langchain.embeddings <span class="hljs-keyword">import</span> OpenAIEmbeddings<br><span class="hljs-keyword">from</span> langchain.retrievers <span class="hljs-keyword">import</span> TimeWeightedVectorStoreRetriever<br><span class="hljs-keyword">from</span> langchain.schema <span class="hljs-keyword">import</span> Document<br><span class="hljs-keyword">from</span> langchain.vectorstores <span class="hljs-keyword">import</span> FAISS<br><br><span class="hljs-comment"># Define your embedding model</span><br>embeddings_model = OpenAIEmbeddings()<br><span class="hljs-comment"># Initialize the vectorstore as empty</span><br>embedding_size = <span class="hljs-number">1536</span><br>index = faiss.IndexFlatL2(embedding_size)<br>vectorstore = FAISS(embeddings_model.embed_query, index, InMemoryDocstore(&#123;&#125;), &#123;&#125;)<span class="hljs-comment">#vectorstore ç”¨äºæè¿°å­˜å…¥çš„æ–¹å¼</span><br>retriever = TimeWeightedVectorStoreRetriever(vectorstore=vectorstore, decay_rate=<span class="hljs-number">.0000000000000000000000001</span>, k=<span class="hljs-number">1</span>)<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>NLP_hug</tag>
      
    </tags>
    
  </entry>
  
  
  
  
</search>
